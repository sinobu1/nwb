<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
    <title>AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <style>
        :root {
            --bg-main: #000000; 
            --bg-card: #121212; 
            --bg-select: #2C2C2E;
            --bg-user-msg: #3E3E42;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --border-color: #282828; 
            --app-wrapper-border: #000000; 
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
            --gold-highlight: #d8ab4e; 
            --success-green: #4CAF50;
            --error-red: #F44336;
            --ios-tab-bar-bg: rgba(28, 28, 30, 0.85); 
        }
        html {
            height: 100%; 
        }
        body {
            height: 100%; 
            overflow: hidden; 
            font-family: var(--font-family);
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            overscroll-behavior-y: contain; 
            margin: 0;
            padding: 0;
        }
        .app-wrapper {
            width: 100%;
            max-width: 450px; 
            height: 100%; 
            position: relative; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--app-wrapper-border); 
            border-right: 1px solid var(--app-wrapper-border); 
        }
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column; 
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out;
            background-color: var(--bg-main);
            z-index: 10;
            will-change: opacity, visibility;
            padding-bottom: env(safe-area-inset-bottom); 
        }
        .screen.active { z-index: 20; opacity: 1; visibility: visible; }
        .screen:not(.active) { opacity: 0; visibility: hidden; pointer-events: none; }

        #main-screen, #image-generator-screen, #summarizer-screen, #chat-screen { flex-grow: 1; } 
        #main-content-area, .feature-content-area { 
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
         .fixed-header { 
            padding: 0.75rem 1rem;
            background: rgba(18,18,18,0.85); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            align-items: center; 
            gap: 0.5rem; 
            border-bottom: 1px solid var(--border-color);
            z-index: 25; 
            color: var(--text-primary);
            position: sticky; 
            top: 0;
            flex-shrink: 0;
            min-height: 56px; 
        }
        .fixed-header h1 { font-size: 1.125rem; font-weight: 600; margin: 0; flex-grow: 1; text-align: center; } 
        .fixed-header .back-btn {
            color: var(--gold-highlight); 
            cursor: pointer;
            padding: 0.25rem; 
        }
         .main-screen-header { 
            padding: 1rem 1rem 0.5rem 1rem;
            background-color: var(--bg-main);
            flex-shrink: 0;
        }
        .main-screen-header h1 { font-size: 1.875rem; font-weight: 800; margin-bottom: 0.25rem; }
        .main-screen-header p.subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; }


        .content-pane { display: none; }
        .content-pane.active { display: block; }

        h2 { font-size: 1.25rem; font-weight: 700; }


        .swiper-container-wrapper { margin-top: 0.75rem; flex-shrink: 0; } 
        .swiper-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 0.75rem; 
            padding: 0 0.25rem; 
        }
        .swiper-header h2 {
            font-size: 1.4rem; 
            font-weight: 700;
        }
        .swiper-nav-arrows { display: flex; gap: 0.5rem; }
        .swiper-nav-arrow { 
            width: 36px; 
            height: 36px; 
            background-color: var(--bg-card); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: opacity 0.2s, transform 0.1s; 
            color: var(--text-secondary); 
        }
        .swiper-nav-arrow svg { 
            width: 18px; 
            height: 18px;
        }
        .swiper-nav-arrow:hover { color: var(--text-primary); }
        .swiper-nav-arrow:active { transform: scale(0.9); }
        .swiper-nav-arrow.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        
        .swiper-slide { width: 180px; height: 120px; cursor: pointer; }
        .tg-card { border-radius: 16px; overflow: hidden; height: 100%; }
        .carousel-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 0.75rem; text-align: left; }
        .card-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .card-title { font-size: 0.9rem; font-weight: 600; color: #FFFFFF; }
        .card-description { font-size: 0.75rem; color: #FFFFFF; opacity: 0.80; margin-top: 0.1rem; line-height: 1.2; }

        .palette-grad-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .palette-grad-2 { background: linear-gradient(135deg, #ff8c00 0%, #ff0080 100%); }
        .palette-grad-3 { background: linear-gradient(135deg, #20bf55 0%, #01baef 100%); }
        .palette-grad-4 { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
        .palette-grad-5 { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); }
        .palette-grad-6 { background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%); }
        .palette-grad-7 { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .palette-grad-8 { background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); }
        .palette-grad-default { background-color: #2D2D2D; } 

        .full-screen-card-list { display: grid; gap: 0.75rem; margin-top: 1rem; }
        .full-screen-card { 
            background-color: var(--bg-card); 
            border-radius: 16px; 
            padding: 1rem; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            cursor: pointer; 
            transition: transform 0.1s; 
            margin-bottom: 0.75rem; 
        }
        .full-screen-card:last-child {
            margin-bottom: 0; 
        }
        .full-screen-card:active { transform: scale(0.98); }
        .full-screen-card .icon { font-size: 1.75rem; }
        .full-screen-card .info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.1rem;}
        .full-screen-card .info p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.3;}

        .ios-tab-bar {
            flex-shrink: 0;
            max-width: 400px;
            width: calc(100% - 2rem);
            margin: 0 auto 1rem auto; 
            display: flex;
            border-radius: 16px; 
            padding: 0.3rem; 
            background-color: var(--ios-tab-bar-bg); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 100;
            position: relative; 
        }
        .tab-item { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: color 0.2s, background-color 0.2s; 
            padding: 0.35rem 0; 
            border-radius: 12px; 
            background-color: transparent; 
            margin: 0.1rem; 
        }
        .tab-item.active { 
            color: var(--gold-highlight); 
            background-color: rgba(80, 80, 80, 0.5); 
        }
        .tab-item:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.05); 
        }
        .tab-item svg { width: 22px; height: 22px; margin-bottom: 2px; } 
        .tab-item span { font-size: 0.6rem; font-weight: 500; }

        .ios-card { background-color: var(--bg-card); border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
        .profile-header { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 1rem;
            background-color: #333;
            background-size: cover;
            background-position: center;
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; 
            font-weight: 500;
            color: var(--text-primary);
        }
        .profile-info h2 { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.2rem 0;}
        .profile-info p { font-size: 0.85rem; color: var(--text-secondary); margin:0;}
        .profile-gems { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; font-size: 0.9rem;}

        /* Chat Screen Specific Styles */
        #chat-screen { display: flex; flex-direction: column; }

        #chat-screen .chat-header { 
            justify-content: space-between; 
        }
        .chat-title-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            text-align: center;
            overflow: hidden; 
        }
        #chat-agent-name {
            font-size: 1.0rem; 
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
            display: block; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            max-width: 100%; 
        }
        #chat-model-name {
            font-size: 0.75rem; 
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.1;
            display: block; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        /* .dietitian-chat-active styles are now applied via JS for explicit control */
        
        .chat-header-btn { 
            width: 38px; 
            height: 38px; 
            border-radius: 50%; 
            display: flex; /* Ensures SVG is centered */
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            color: var(--text-secondary); 
            flex-shrink: 0; 
        }
        .chat-header-btn svg { /* Ensure SVG scales well within button */
            width: 20px; /* Adjusted for better visual fit */
            height: 20px; /* Adjusted for better visual fit */
        }

        .chat-header-btn#chat-back-btn { color: var(--gold-highlight); }
        .chat-header-btn#chat-back-btn svg { width: 22px; height: 22px; } /* Specific size for back arrow if needed */
        .chat-header-btn:hover { background-color: var(--bg-card); }
        
        .chat-messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 1rem; 
            display: flex; 
            flex-direction: column; 
            gap: 0.25rem; 
            -webkit-overflow-scrolling: touch; 
            cursor: default; 
        }
        
        .chat-input-area { 
            flex-shrink: 0; 
            padding: 0.75rem; 
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); 
            border-top: 1px solid var(--border-color); 
            background-color: var(--bg-main); 
            display: flex;
            align-items: flex-end; 
            gap: 0.75rem; 
            z-index: 15; 
        }
        #chat-attach-file-btn {
            flex-shrink: 0;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.25rem; 
        }
        #chat-attach-file-btn svg {
            width: 24px;
            height: 24px;
        }
        #chat-attach-file-btn:hover {
            color: var(--text-primary);
        }
        /* Hiding attach button is now done via JS in openChat */

        .image-preview-container {
            display: none; 
            padding: 0.5rem 0.75rem 0; 
            flex-shrink: 0;
        }
        .image-preview-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-card);
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .image-preview-item img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 0.5rem;
            object-fit: cover;
        }
        .remove-preview-btn {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        #chat-prompt-input { 
            flex-grow: 1; 
            background-color: var(--bg-card);
            border-radius: 20px; 
            padding: 0.65rem 1rem; 
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.95rem; 
            line-height: 1.4; 
            min-height: 40px; 
            max-height: 120px; 
            resize: none; 
            overflow-y: auto; 
        }
        #chat-prompt-input:focus {
            outline: none;
            border-color: var(--gold-highlight);
            box-shadow: 0 0 0 1px var(--gold-highlight);
        }
        #chat-send-message-btn { 
            flex-shrink: 0; 
            padding: 0.65rem 1rem; 
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 20px; 
            font-size: 0.95rem; 
            font-weight: 500; 
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            height: 40px; 
            line-height: 1; 
        }
        #chat-send-message-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .chat-message { 
            padding: 0.5rem 0.9rem; 
            border-radius: 1.1rem; 
            max-width: 85%; 
            word-wrap: break-word; 
            line-height: 1.4; 
            opacity: 0; 
            transform: translateY(10px); 
            animation: pop-in 0.3s ease forwards; 
            margin-top: 0.65rem; 
            will-change: transform, opacity; 
            font-size: 0.9rem; 
            display: flex; 
            flex-direction: column; 
        }
        .chat-message img.message-image { 
            max-width: 100%;
            max-height: 200px; 
            border-radius: 0.75rem; 
            margin-bottom: 0.5rem; 
            object-fit: cover;
            cursor: pointer; 
        }
        .message-content-text { 
            word-wrap: break-word; 
        }

        @keyframes pop-in { to { opacity: 1; transform: translateY(0); } }
        .message-bot { background-color: var(--bg-card); align-self: flex-start; color: var(--text-primary); }
        .message-user { background-color: var(--bg-user-msg); align-self: flex-end; color: var(--text-primary); }
        .message-bot.tailed { border-bottom-left-radius: 0.25rem; }
        .message-user.tailed { border-bottom-right-radius: 0.25rem; }
        .chat-message.grouped { margin-top: 0.25rem; }
        .chat-message.no-tail { border-bottom-left-radius: 1.1rem; border-bottom-right-radius: 1.1rem; }
        
        .message-bot.typing .message-content-text::after { 
            content: '.'; 
            animation: dots 1.2s steps(5, end) infinite; 
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: '...'; } }
        
        .message-meta { 
            font-size: 0.7rem; 
            color: var(--text-secondary); 
            line-height: 1; 
            user-select: none; 
            margin-top: 0.2rem; 
            text-align: right; 
        }
        .message-user .message-meta { 
            align-self: flex-end;
        }
        .message-bot .message-meta { 
            align-self: flex-end; 
        }


        .chat-date-divider { text-align: center; margin: 1rem auto; background-color: rgba(44, 44, 46, 0.8); color: var(--text-primary); font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.6rem; border-radius: 1rem; width: fit-content; }

        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card); padding: 1.5rem; border-radius: 1rem; width: calc(100% - 2rem); max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .custom-select { width: 100%; background-color: var(--bg-select); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 1rem; margin-top: 0.5rem;}

        .feature-input-area { margin-bottom: 1rem; }
        .feature-input-area textarea, .feature-input-area input[type="text"] {
            width: 100%;
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 44px;
        }
        .feature-input-area textarea { min-height: 100px; }
        .feature-submit-btn { 
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }
        .feature-submit-btn:hover { background-color: #c89a3e; }
        .feature-submit-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }
        .generated-image-container { margin-top: 1rem; text-align: center; }
        .generated-image-container img { max-width: 100%; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-card); }
        .generated-image-container button { 
            margin-top: 0.75rem;
            background-color: var(--bg-select);
            color: var(--text-primary);
        }
        .summarizer-output { margin-top: 1rem; padding: 1rem; background-color: var(--bg-card); border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-primary); font-size: 0.9rem; }
        .error-message { color: var(--error-red); text-align: center; margin-top: 1rem; }

        #fullscreen-image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 2000; 
            padding: 1rem;
            box-sizing: border-box;
        }
        #fullscreen-image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        #fullscreen-image-viewer .close-fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        ::-webkit-scrollbar {
            width: 6px; 
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-main); 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #2a2a2a; 
            border-radius: 10px;
            border: 1px solid var(--bg-main); 
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #4a4a4a; 
        }
        * {
           scrollbar-width: thin;
           scrollbar-color: #2a2a2a var(--bg-main);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="main-screen" class="screen active"> 
            <div id="main-content-area"> 
                <div id="home-content" class="content-pane active">
                    <div class="main-screen-header">
                        <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
                        <p class="subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
                    </div>
                    <div class="full-screen-card" id="image-generator-card">
                        <div class="icon" style="font-size: 2rem;">üé®</div>
                        <div class="info"><h3>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚ú®</h3><p>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é.</p></div>
                    </div>
                    <div class="full-screen-card" id="dietitian-agent-card">
                        <div class="icon" style="font-size: 2rem;">ü•ë</div>
                        <div class="info"><h3>–î–∏–µ—Ç–æ–ª–æ–≥ (–∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ)</h3><p>–ê–Ω–∞–ª–∏–∑ –ö–ë–ñ–£ –ø–æ —Ñ–æ—Ç–æ –±–ª—é–¥–∞.</p></div>
                    </div>

                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>–ê–≥–µ–Ω—Ç—ã</h2><div class="swiper-nav-arrows"><div id="agents-nav-prev" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="agents-nav-next" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="agents-swiper"><div class="swiper-wrapper" id="agents-swiper-wrapper"></div></div>
                    </div>
                     <div class="swiper-container-wrapper"> <div class="swiper-header"><h2>–ú–æ–¥–µ–ª–∏</h2><div class="swiper-nav-arrows"><div id="models-nav-prev" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="models-nav-next" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="models-swiper"><div class="swiper-wrapper" id="models-swiper-wrapper"></div></div>
                    </div>
                </div>
                <div id="tools-content" class="content-pane">
                    <div class="main-screen-header">
                        <h1>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h1>
                        <p class="subtitle">–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –±–∞–∑–µ –ò–ò</p>
                    </div>
                    <div id="tools-list" class="full-screen-card-list">
                        </div>
                </div>
                <div id="profile-content" class="content-pane">
                     <div class="main-screen-header">
                        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
                        <p class="subtitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ</p>
                    </div>
                    <div class="ios-card">
                       <div class="profile-header">
                           <div id="profile-avatar-img" class="profile-avatar"></div>
                           <div class="profile-info">
                               <h2 id="profile-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                               <p id="profile-id">ID: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</p>
                           </div>
                       </div>
                       <div class="profile-gems"><span>üíé –ë–∞–ª–∞–Ω—Å –≥–µ–º–æ–≤</span><span id="gem-balance" style="font-weight:700;">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
                    </div>
                </div>
            </div>
            <nav class="ios-tab-bar">
                <div class="tab-item active" data-tab="home">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>–ì–ª–∞–≤–Ω–∞—è</span>
                </div>
                <div class="tab-item" data-tab="tools">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>
                </div>
                <div class="tab-item" data-tab="profile">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                </div>
            </nav>
        </div>

        <div id="chat-screen" class="screen"> 
            <div class="chat-header fixed-header"> 
                <div id="chat-back-btn" class="chat-header-btn">
                     <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 </div>
                 <div class="chat-title-container">
                    <span id="chat-agent-name">–ê–≥–µ–Ω—Ç</span>
                    <span id="chat-model-name">–ú–æ–¥–µ–ª—å</span> </div>
                 <div id="chat-settings-btn" class="chat-header-btn">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .54 1.85v.19a2 2 0 0 1-.54 1.85l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.54-1.85v-.19a2 2 0 0 1 .54 1.85l.15-.1a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                 </div>
            </div>
            <div class="chat-messages" id="chat-messages-container"></div>
            <div id="image-preview-container" class="image-preview-container"></div>
            <div class="chat-input-area"> 
                <input type="file" id="chat-file-input" accept="image/*" style="display: none;">
                <button id="chat-attach-file-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                </button>
                <textarea id="chat-prompt-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button id="chat-send-message-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button> 
            </div>
        </div>

        <div id="image-generator-screen" class="screen">
            <div class="fixed-header">
                <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </div>
                <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚ú®</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <input type="text" id="image-prompt-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...">
                </div>
                <button id="generate-image-btn" class="feature-submit-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <div id="image-loading-indicator" class="loading-indicator" style="display: none;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</div>
                <div id="generated-image-container" class="generated-image-container"></div>
                <div id="image-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="summarizer-screen" class="screen">
            <div class="fixed-header">
                 <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 </div>
                <h1>–°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ ‚ú®</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <textarea id="summarizer-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
                </div>
                <button id="summarize-text-btn" class="feature-submit-btn">–°—É–º–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <div id="summarizer-loading-indicator" class="loading-indicator" style="display: none;">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞...</div>
                <div id="summarizer-output" class="summarizer-output" style="display: none;"></div>
                <div id="summarizer-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="settings-modal"> 
            <div class="modal-content">
                <div class="modal-header"><h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3><div class="modal-close-btn" style="cursor: pointer;">‚úï</div></div>
                <div><label for="agent-select">–ê–ì–ï–ù–¢</label><select id="agent-select" class="custom-select"></select></div>
                <div style="margin-top: 1rem;"><label for="model-select">–ú–û–î–ï–õ–¨</label><select id="model-select" class="custom-select"></select></div>
            </div>
        </div>
    </div>
    <div id="fullscreen-image-viewer">
        <button class="close-fullscreen-btn">&times;</button>
        <img src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp || {};
    let currentMiniAppChatHistory = []; 
    let lastMessageInfo = { sender: null, date: null }; 
    let agentsSwiper, modelsSwiper;
    let selectedFileBase64 = null; 
    let selectedFileMimeType = null; 

    const API_KEY = "AIzaSyCdDMpgLJyz6aYdwT9q4sbBk7sHVID4BTI"; 
    const APP_BACKEND_URL = "https://nwb-production.up.railway.app"; 

    const logger = {
        info: (message, ...optionalParams) => console.log(`[INFO] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        warn: (message, ...optionalParams) => console.warn(`[WARN] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        error: (message, ...optionalParams) => console.error(`[ERROR] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        debug: (message, ...optionalParams) => console.debug(`[DEBUG] ${new Date().toISOString()}: ${message}`, ...optionalParams),
    };

    const generalAgents = [ 
        { key: "universal_ai_basic", name: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π", icon: "üåê", desc: "–û—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã", palette: "palette-grad-1", systemPrompt: "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç." }, 
        { key: "idea_generator", name: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π", icon: "üí°", desc: "–ü–æ–º–æ—â—å –≤ –ø–æ–∏—Å–∫–µ –∏–¥–µ–π", palette: "palette-grad-2", systemPrompt: "–¢—ã ‚Äî –ò–ò, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –∏–¥–µ–π. –ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–¥—É–º–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ." }, 
        { key: "career_coach", name: "–ö–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", icon: "üìà", desc: "–°–æ–≤–µ—Ç—ã –ø–æ –∫–∞—Ä—å–µ—Ä–µ", palette: "palette-grad-3", systemPrompt: "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ—É—á. –î–∞–≤–∞–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –∫–∞—Ä—å–µ—Ä—ã." }, 
        { key: "programming_partner", name: "–ü–∞—Ä—Ç–Ω–µ—Ä –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞", icon: "üíª", desc: "–ü–æ–º–æ—â—å –≤ –∫–æ–¥–µ", palette: "palette-grad-4", systemPrompt: "–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤. –ü–æ–º–æ–≥–∞–π —Å –∫–æ–¥–æ–º, –æ–±—ä—è—Å–Ω—è–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏—è." }, 
        { key: "tutor_assistant", name: "–í–Ω–µ—à–∫–æ–ª—å–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫", icon: "ÔøΩ", desc: "–ü–æ–º–æ—â—å —Å —É—á–µ–±–æ–π", palette: "palette-grad-5", systemPrompt: "–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π –ò–ò-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä. –ü–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —É—á–µ–±–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö." }, 
        { key: "literary_editor", name: "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä", icon: "‚úçÔ∏è", desc: "–£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤", palette: "palette-grad-6", systemPrompt: "–¢—ã ‚Äî –ò–ò-—Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü–æ–º–æ–≥–∞–π —É–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç—ã, –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏ –∏ –¥–µ–ª–∞—Ç—å –∏—Ö –±–æ–ª–µ–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–º–∏." }
    ];

    const models = [ 
        { key: "google_gemini_2_0_flash", name: "Gemini 2.0 Flash", icon: "‚ö°Ô∏è", desc: "–ë—ã—Å—Ç—Ä–∞—è –∏ –¥–æ—Å—Ç—É–ø–Ω–∞—è", palette: "palette-grad-default" },
        { key: "google_gemini_2_5_flash_preview", name: "Gemini 2.5 Flash", icon: "üëÅÔ∏è‚Äçüó®Ô∏è", desc: "–ë—ã—Å—Ç—Ä—ã–π –∏ —Å–ø–æ—Å–æ–±–Ω—ã–π", palette: "palette-grad-1" },
        { key: "custom_api_gemini_2_5_pro", name: "Gemini 2.5 Pro", icon: "üöÄ", desc: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å", palette: "palette-grad-2" }, 
        { key: "custom_api_grok_3", name: "Grok 3", icon: "üåÄ", desc: "–ú–æ–¥–µ–ª—å Grok", palette: "palette-grad-3" },
        { key: "custom_api_gpt_4o_mini", name: "GPT-4o mini", icon: "üß†", desc: "–ö–æ–º–ø–∞–∫—Ç–Ω–∞—è GPT-4o", palette: "palette-grad-4" }
    ];
    
    const toolConfigs = {
        "photo_dietitian_analyzer": { 
            key: "photo_dietitian_analyzer", 
            name: "ü•ë –î–∏–µ—Ç–æ–ª–æ–≥ (–∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ)", 
            icon: "ü•ë", 
            desc: "–ê–Ω–∞–ª–∏–∑ –ö–ë–ñ–£ –ø–æ —Ñ–æ—Ç–æ –±–ª—é–¥–∞.", 
            forced_model_key: "google_gemini_2_5_flash_preview", 
            systemPrompt: "–¢—ã ‚Äî –î–∏–µ—Ç–æ–ª–æ–≥-–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–¥–æ—Ä–æ–≤–æ–º—É –ø–∏—Ç–∞–Ω–∏—é, —Ä–∞–±–æ—Ç–∞—é—â–∏–π —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–π –ò–ò-–º–æ–¥–µ–ª—å—é, —Å–ø–æ—Å–æ–±–Ω–æ–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ–¥—ã. –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –§–û–¢–û–ì–†–ê–§–ò–ô –µ–¥—ã, –ø—Ä–∏—Å–ª–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –¢–≤–æ–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –°–¢–†–û–ì–û —Å–ª–µ–¥—É—é—â–∏–π: 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –§–û–¢–û –±–ª—é–¥–∞. 2. –¢—ã –ø–æ–ª—É—á–∞–µ—à—å —ç—Ç–æ —Ñ–æ—Ç–æ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ: –¢–û–õ–¨–ö–û –≤–µ–∂–ª–∏–≤–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∫–∞–∑–∞—Ç—å –ü–†–ò–ú–ï–†–ù–´–ô –í–ï–° –ø–æ—Ä—Ü–∏–∏ –≤ –≥—Ä–∞–º–º–∞—Ö. –ù–µ –¥–µ–ª–∞–π –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Å–æ—Å—Ç–∞–≤–µ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–µ—Å–∞! –ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞: '–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —Ñ–æ—Ç–æ! –ß—Ç–æ–±—ã —è –º–æ–≥ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ö–ë–ñ–£, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —ç—Ç–æ–π –ø–æ—Ä—Ü–∏–∏ –≤ –≥—Ä–∞–º–º–∞—Ö.' 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –í–ï–° –ø–æ—Ä—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–º. 4. –¢–µ–ø–µ—Ä—å, –∏–º–µ—è –§–û–¢–û –∏ –í–ï–°, —Ç—ã –¥–æ–ª–∂–µ–Ω: –∞) –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –±–ª—é–¥–∞ –ø–æ —Ñ–æ—Ç–æ. –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è, –ª—É—á—à–µ –∑–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Å–æ—Å—Ç–∞–≤–µ. –±) –£—á–∏—Ç—ã–≤–∞—è —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤–µ—Å, —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π (–ö–∫–∞–ª), —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–µ–ª–∫–æ–≤ (–ë), –∂–∏—Ä–æ–≤ (–ñ) –∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ (–£) –¥–ª—è –≤—Å–µ–π –ø–æ—Ä—Ü–∏–∏. –≤) –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —á–µ—Ç–∫–æ–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: '–ê–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ –±–ª—é–¥–∞ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å: [–≤–µ—Å] –≥): - –ë–ª—é–¥–æ/–ü—Ä–æ–¥—É–∫—Ç—ã: [–î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤] - –ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å: ~[X] –ö–∫–∞–ª - –ë–µ–ª–∫–∏: ~[Y] –≥ - –ñ–∏—Ä—ã: ~[Z] –≥ - –£–≥–ª–µ–≤–æ–¥—ã: ~[W] –≥ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: [1-2 –∫—Ä–∞—Ç–∫–∏—Ö, –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –ø–æ –¥–∞–Ω–Ω–æ–º—É –±–ª—é–¥—É/–ø—Ä–∏–µ–º—É –ø–∏—â–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ –µ–≥–æ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏, –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∑–∞–º–µ–Ω–∞—Ö, —Å–æ—á–µ—Ç–∞–µ–º–æ—Å—Ç–∏ –∏–ª–∏ –≤–ª–∏—è–Ω–∏–∏ –Ω–∞ —Ü–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã].' –≥) –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω, –¥—Ä—É–∂–µ–ª—é–±–µ–Ω –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–µ–Ω, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–∏–µ—Ç–æ–ª–æ–≥. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Å—Ç–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–µ—Å–∞ –∑–∞–¥–∞–µ—Ç –û–ë–©–ò–ô —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ –¥–∏–µ—Ç–æ–ª–æ–≥–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ø–æ–ª—å–∑–∞ –∞–≤–æ–∫–∞–¥–æ'), –æ—Ç–≤–µ—á–∞–π –Ω–∞ –Ω–µ–≥–æ –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç-–¥–∏–µ—Ç–æ–ª–æ–≥, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å–≤–æ–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö, –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ –∏ –∑–∞–ø—Ä–æ—Å–∞ –≤–µ—Å–∞."
        }
    };

    const appTools = [
        { key: "image_generator_tool", name: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚ú®", icon: "üé®", desc: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é.", screenId: "image-generator-screen" },
        { key: "photo_dietitian_analyzer", name: "–î–∏–µ—Ç–æ–ª–æ–≥ (–∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ)", icon: "ü•ë", desc: "–ê–Ω–∞–ª–∏–∑ –ö–ë–ñ–£ –ø–æ —Ñ–æ—Ç–æ –±–ª—é–¥–∞.", isChatTool: true }, 
        { key: "summarizer_tool", name: "–°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ ‚ú®", icon: "üìë", desc: "–ö—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –∏ –≤–∏–¥–µ–æ.", screenId: "summarizer-screen" },
    ];

    let selectedAgentKey = generalAgents[0].key; 
    let selectedModelKey = models[0].key; 

    const mainScreen = document.getElementById('main-screen');
    const chatScreen = document.getElementById('chat-screen');
    const imageGeneratorScreen = document.getElementById('image-generator-screen');
    const summarizerScreen = document.getElementById('summarizer-screen');
    const dietitianAgentCard = document.getElementById('dietitian-agent-card'); 
    const imageGeneratorCard = document.getElementById('image-generator-card');

    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatPromptInput = document.getElementById('chat-prompt-input'); 
    const chatSendMessageBtn = document.getElementById('chat-send-message-btn'); 
    const chatAttachFileBtn = document.getElementById('chat-attach-file-btn');
    const chatFileInput = document.getElementById('chat-file-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    const chatAgentNameEl = document.getElementById('chat-agent-name');
    const chatModelNameEl = document.getElementById('chat-model-name');

    const chatBackButton = document.getElementById('chat-back-btn'); // In-app back button
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const agentSelect = document.getElementById('agent-select'); 
    const modelSelect = document.getElementById('model-select'); 
    const mainContentArea = document.getElementById('main-content-area');

    const imagePromptInputEl = document.getElementById('image-prompt-input'); 
    const generateImageBtn = document.getElementById('generate-image-btn');
    const imageLoadingIndicator = document.getElementById('image-loading-indicator');
    const generatedImageContainer = document.getElementById('generated-image-container');
    const imageErrorMessage = document.getElementById('image-error-message');

    const summarizerInput = document.getElementById('summarizer-input');
    const summarizeTextBtn = document.getElementById('summarize-text-btn');
    const summarizerLoadingIndicator = document.getElementById('summarizer-loading-indicator');
    const summarizerOutput = document.getElementById('summarizer-output');
    const summarizerErrorMessage = document.getElementById('summarizer-error-message');
    
    const fullscreenImageViewer = document.getElementById('fullscreen-image-viewer');
    const fullscreenImage = fullscreenImageViewer.querySelector('img');
    const closeFullscreenBtn = fullscreenImageViewer.querySelector('.close-fullscreen-btn');

    let pollingInterval = null;

    function formatTime(date) { return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }

    function switchScreen(screenToShow) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        screenToShow.classList.add('active');
        if (tg.BackButton) {
            if (screenToShow !== mainScreen) { tg.BackButton.show(); }
            else { tg.BackButton.hide(); }
        }
        if (screenToShow === chatScreen) { startPolling(); chatPromptInput.focus(); } 
        else { stopPolling(); }
    }

    if (tg.BackButton) {
        tg.BackButton.onClick(() => {
            const activeScreenEl = document.querySelector('.screen.active');
            if (!activeScreenEl) return; 
            const activeScreenId = activeScreenEl.id;

            if (activeScreenId === 'chat-screen') {
                closeChat(); 
            } else if (activeScreenId === 'image-generator-screen' || activeScreenId === 'summarizer-screen') {
                switchScreen(mainScreen);
            } else if (activeScreenId !== 'main-screen') {
                switchScreen(mainScreen);
            }
        });
    }

    document.querySelectorAll('.back-btn[data-target-screen]').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetScreenId = btn.dataset.targetScreen;
            const targetScreen = document.getElementById(targetScreenId);
            if (targetScreen) switchScreen(targetScreen);
        });
    });

    function showTab(tabId) {
        document.querySelectorAll('.content-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        const pane = document.getElementById(`${tabId}-content`);
        const tab = document.querySelector(`.tab-item[data-tab="${tabId}"]`);
        if (pane) pane.classList.add('active');
        if (tab) tab.classList.add('active');
        mainContentArea.scrollTop = 0;
        if (tabId === 'profile') { 
            displayProfileData(); 
        }
    }

    function saveChatToLocalStorage() { 
        try { 
            const displayHistory = Array.from(chatMessagesContainer.children)
                .filter(el => el.classList.contains('chat-message') && !el.classList.contains('typing'))
                .map(msgEl => {
                    const sender = msgEl.classList.contains('message-user') ? 'user' : 'bot';
                    const textContent = msgEl.querySelector('.message-content-text')?.textContent || '';
                    const imageEl = msgEl.querySelector('.message-image');
                    const imageDataUrl = imageEl ? imageEl.src : null;
                    let timestamp = msgEl.dataset.timestamp || new Date().toISOString();
                    return { sender, content: { text: textContent, imageDataUrl: imageDataUrl }, timestamp }; 
                });
            setTimeout(() => {
                localStorage.setItem('uiChatHistory_' + selectedAgentKey, JSON.stringify(displayHistory)); 
            },0);
        }
        catch (e) { console.error("Error saving UI chat history:", e); }
    }

    function loadChatFromLocalStorage() { 
        chatMessagesContainer.innerHTML = '';
        lastMessageInfo = { sender: null, date: null };
        currentMiniAppChatHistory = []; 
        try {
            const savedUiHistory = localStorage.getItem('uiChatHistory_' + selectedAgentKey);
            if (savedUiHistory) {
                const parsedUiHistory = JSON.parse(savedUiHistory);
                if (parsedUiHistory.length === 0) return; 

                parsedUiHistory.forEach(msg => {
                    if (msg.content && (msg.content.text || msg.content.imageDataUrl)) {
                        addMessageToChat(msg.sender, msg.content, { 
                            isRestoredFromHistory: true, 
                            timestamp: msg.timestamp 
                        });
                        const historyEntryParts = [];
                        if (msg.content.text) historyEntryParts.push({text: msg.content.text});
                        currentMiniAppChatHistory.push({role: msg.sender === 'user' ? 'user' : 'model', parts: historyEntryParts});
                    }
                });
            }
        } catch (e) {
            console.error("Error loading UI chat history:", e);
        }
    }
    
    function openFullscreenImage(src) {
        fullscreenImage.src = src;
        fullscreenImageViewer.style.display = 'flex';
    }
    closeFullscreenBtn.addEventListener('click', () => {
        fullscreenImageViewer.style.display = 'none';
        fullscreenImage.src = ''; 
    });
    fullscreenImageViewer.addEventListener('click', (e) => { 
        if (e.target === fullscreenImageViewer) {
            fullscreenImageViewer.style.display = 'none';
            fullscreenImage.src = '';
        }
    });

    function addMessageToChat(sender, content, options = {}) {
        const { isTyping = false, isRestoredFromHistory = false, timestamp: msgTimestampStr } = options;
        
        let textContent = '';
        let imageDataUrl = null;

        if (typeof content === 'string') {
            textContent = content;
        } else if (typeof content === 'object' && content !== null) {
            textContent = content.text || '';
            imageDataUrl = content.imageDataUrl || null;
        }

        if (!isTyping && !textContent && !imageDataUrl) {
            return null; 
        }

        const now = msgTimestampStr ? new Date(msgTimestampStr) : new Date(); 
        const currentDate = now.toDateString();

        if (!isTyping && (!lastMessageInfo.date || currentDate !== lastMessageInfo.date)) {
            const divider = document.createElement('div');
            divider.className = 'chat-date-divider';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (currentDate === today) { divider.textContent = '–°–µ–≥–æ–¥–Ω—è'; }
            else if (currentDate === yesterday) { divider.textContent = '–í—á–µ—Ä–∞'; }
            else { divider.textContent = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }); }
            chatMessagesContainer.appendChild(divider);
        }

        const lastMessageElement = chatMessagesContainer.querySelector('.chat-message:last-of-type');
        if (!isTyping && lastMessageElement && sender === lastMessageInfo.sender && currentDate === lastMessageInfo.date) {
             lastMessageElement.classList.add('no-tail', 'grouped');
             lastMessageElement.classList.remove('tailed');
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message message-${sender} tailed`;
        msgDiv.dataset.timestamp = now.toISOString(); 
        
        if (imageDataUrl) {
            const imgElement = document.createElement('img');
            imgElement.src = imageDataUrl;
            imgElement.alt = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —á–∞—Ç–µ";
            imgElement.className = 'message-image';
            imgElement.addEventListener('click', () => openFullscreenImage(imageDataUrl));
            msgDiv.appendChild(imgElement);
        }

        if (textContent || isTyping) { 
            const contentSpan = document.createElement('span');
            contentSpan.className = 'message-content-text'; 
            contentSpan.textContent = textContent || (isTyping ? '–ü–µ—á–∞—Ç–∞–µ—Ç...' : ''); 
            msgDiv.appendChild(contentSpan);
            if (isTyping) { 
                 contentSpan.classList.add('message-content'); 
            }
        }
        
        if (isTyping) {
            msgDiv.classList.add('typing');
        } else {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const timeSpan = document.createElement('span');
            timeSpan.textContent = formatTime(now);
            metaDiv.appendChild(timeSpan);
            msgDiv.appendChild(metaDiv);
        }
        chatMessagesContainer.appendChild(msgDiv);

        if (!isTyping && !isRestoredFromHistory) {
            const historyEntryParts = [];
            if (textContent) historyEntryParts.push({ text: textContent });
            currentMiniAppChatHistory.push({ role: (sender === 'user' ? 'user' : 'model'), parts: historyEntryParts });
            saveChatToLocalStorage(); 
        }
        lastMessageInfo = { sender: sender, date: currentDate };
        chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
        return msgDiv;
    }

    async function submitMessageToBackend(userText, agentKeyForBackend, modelKeyToSubmit, imageBase64, imageMimeType) { 
        let userId = tg.initDataUnsafe?.user?.id;
        if (!userId) {
            addMessageToChat('bot', { text: "–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω." });
            const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
            if (typingIndicator) typingIndicator.remove();
            return;
        }
        
        const backendProcessUrl = `${APP_BACKEND_URL}/api/process_app_message/${userId}`;
        const payload = { 
            text: userText, 
            agentKey: agentKeyForBackend, 
            modelKey: modelKeyToSubmit 
        };

        if (imageBase64 && imageMimeType) {
            payload.image_base64 = imageBase64;
            payload.image_mime_type = imageMimeType;
        } 

        try {
            const response = await fetch(backendProcessUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) 
            });
            if (!response.ok) {
                let errorText = `–û—à–∏–±–∫–∞ –±—ç–∫–µ–Ω–¥–∞: ${response.status} ${response.statusText}`;
                try {
                    const errorResult = await response.json();
                    errorText = errorResult.message || (errorResult.detail ? JSON.stringify(errorResult.detail) : errorText);
                } catch (e) { /* ignore */ }
                addMessageToChat('bot', { text: errorText });
            } else {
                 const result = await response.json();
                 logger.info("Message submitted to backend successfully:", result);
            }
        } catch (error) {
            addMessageToChat('bot', { text: "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –±—ç–∫–µ–Ω–¥." });
        } finally {
            const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
            if (typingIndicator) typingIndicator.remove();
        }
    }

    async function handleSendMessage() {
        const text = chatPromptInput.value.trim(); 
        if (!text && !selectedFileBase64) { 
            if (selectedAgentKey === "photo_dietitian_analyzer") { 
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.");
            }
            return;
        }

        let messageContentForChat = { text: text }; 
        if (selectedFileBase64 && selectedFileMimeType) {
            const imageDataUrl = `data:${selectedFileMimeType};base64,${selectedFileBase64}`;
            messageContentForChat.imageDataUrl = imageDataUrl; 
        }
        addMessageToChat('user', messageContentForChat); 
        
        const imageToSend = selectedFileBase64; 
        const mimeTypeToSend = selectedFileMimeType; 

        chatPromptInput.value = ''; 
        autoResizeTextarea.call(chatPromptInput); 
        clearImagePreview(); 
        chatSendMessageBtn.disabled = true; 

        const oldTypingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
        if(oldTypingIndicator) oldTypingIndicator.remove();
        addMessageToChat('bot', { text: '–ü–µ—á–∞—Ç–∞–µ—Ç...' }, { isTyping: true }); 
        
        let modelKeyForBackend = selectedModelKey; 
        if (selectedAgentKey === "photo_dietitian_analyzer") {
            const dietitianConfig = toolConfigs["photo_dietitian_analyzer"];
            if (dietitianConfig?.forced_model_key) {
                modelKeyForBackend = dietitianConfig.forced_model_key;
            }
        }
        await submitMessageToBackend(text, selectedAgentKey, modelKeyForBackend, imageToSend, mimeTypeToSend);
    }

    function autoResizeTextarea() {
        this.style.height = 'auto'; 
        let newHeight = this.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(this).maxHeight);
        if (newHeight > maxHeight) { newHeight = maxHeight; this.style.overflowY = 'auto';  } 
        else { this.style.overflowY = 'hidden'; }
        this.style.height = newHeight + 'px';
        chatSendMessageBtn.disabled = this.value.trim().length === 0 && !selectedFileBase64; 
    }
    chatPromptInput.addEventListener('input', autoResizeTextarea);

    let isInputRecentlyFocused = false; 
    function hideKeyboardIfFocused() {
        if (document.activeElement === chatPromptInput) { chatPromptInput.blur(); }
    }
    chatPromptInput.addEventListener('focus', () => { isInputRecentlyFocused = true; setTimeout(() => { isInputRecentlyFocused = false; }, 300); });
    chatMessagesContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('message-image')) { return; }
        if (event.target !== chatPromptInput && !chatPromptInput.contains(event.target) && 
            event.target !== chatSendMessageBtn && !chatSendMessageBtn.contains(event.target) && 
            event.target !== chatAttachFileBtn && !chatAttachFileBtn.contains(event.target)) {
            hideKeyboardIfFocused();
        }
    });
    let scrollTimeout;
    chatMessagesContainer.addEventListener('scroll', () => {
        if (isInputRecentlyFocused) { return; }
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => { hideKeyboardIfFocused(); }, 150); 
    });

    chatAttachFileBtn.addEventListener('click', () => { chatFileInput.click(); });
    chatFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFileBase64 = e.target.result.split(',')[1]; 
                selectedFileMimeType = file.type;
                displayImagePreview(e.target.result, file.name);
                chatSendMessageBtn.disabled = false; 
            };
            reader.onerror = () => { tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª."); clearImagePreview(); };
            reader.readAsDataURL(file);
        } else if (file) { tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è."); clearImagePreview(); }
        chatFileInput.value = ''; 
    });

    function displayImagePreview(imageDataUrl, fileName) {
        imagePreviewContainer.innerHTML = `
            <div class="image-preview-item">
                <img src="${imageDataUrl}" alt="Preview">
                <span>${fileName.length > 20 ? fileName.substring(0, 17) + '...' : fileName}</span>
                <button type="button" class="remove-preview-btn" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
            </div>`;
        imagePreviewContainer.style.display = 'block';
        imagePreviewContainer.querySelector('.remove-preview-btn').addEventListener('click', clearImagePreview);
    }
    function clearImagePreview() {
        selectedFileBase64 = null; selectedFileMimeType = null;
        imagePreviewContainer.innerHTML = ''; imagePreviewContainer.style.display = 'none';
        chatSendMessageBtn.disabled = chatPromptInput.value.trim().length === 0; 
    }

    async function fetchUpdates() {
        let userId = tg.initDataUnsafe?.user?.id;
        if (!userId || !chatScreen.classList.contains('active')) { return; }
        const backendGetUpdatesUrl = `${APP_BACKEND_URL}/api/get_updates/${userId}`;
        try {
            const response = await fetch(backendGetUpdatesUrl);
            if (!response.ok) { return; }
            const data = await response.json();
            if (data?.status === 'ok' && data.messages?.length > 0) {
                const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
                if (typingIndicator) typingIndicator.remove();
                data.messages.forEach(msg => addMessageToChat(msg.sender, { text: msg.text }, { timestamp: msg.timestamp }));
            }
        } catch (error) { /* ignore */ }
    }
    function startPolling() { stopPolling(); fetchUpdates(); pollingInterval = setInterval(fetchUpdates, 3000); }
    function stopPolling() { if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; } }

    function populateCarousel(containerId, items, type) {
        const wrapper = document.getElementById(containerId);
        if (!wrapper) return;
        wrapper.innerHTML = '';
        items.forEach(item => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `<div class="tg-card"><div class="carousel-card ${item.palette || 'palette-grad-default'}"><div class="card-icon">${item.icon}</div><div><h3 class="card-title">${item.name}</h3><p class="card-description">${item.desc}</p></div></div></div>`;
            slide.addEventListener('click', () => {
                if (type === 'agent') { 
                    const agentConfig = generalAgents.find(a => a.key === item.key);
                    if (agentConfig) openChat(agentConfig); 
                } else if (type === 'model') { 
                    selectedModelKey = item.key; 
                    if (chatScreen.classList.contains('active') && !chatScreen.classList.contains('dietitian-chat-active')) {
                         const modelDetails = models.find(m => m.key === selectedModelKey);
                         if (chatModelNameEl) chatModelNameEl.textContent = modelDetails?.name || selectedModelKey;
                         addMessageToChat('bot', {text: `–ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${modelDetails?.name || selectedModelKey}.`});
                         modelSelect.value = selectedModelKey;
                    } else { tg.showPopup?.({message: `–ú–æ–¥–µ–ª—å ${item.name} –≤—ã–±—Ä–∞–Ω–∞.`}); }
                }
            });
            wrapper.appendChild(slide);
        });
    }

    function populateToolsList() {
        const list = document.getElementById('tools-list');
        if (!list) return;
        list.innerHTML = '';
        appTools.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'full-screen-card';
            card.innerHTML = `<div class="icon">${tool.icon}</div><div class="info"><h3>${tool.name}</h3><p>${tool.desc}</p></div>`;
            card.addEventListener('click', () => {
                if (tool.isChatTool) {
                    const toolChatConfig = toolConfigs[tool.key];
                    if (toolChatConfig) openChat(toolChatConfig);
                } else if (tool.screenId) {
                    const targetScreen = document.getElementById(tool.screenId);
                    if (targetScreen) switchScreen(targetScreen);
                } else { tg.showAlert?.(`–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${tool.name}" –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.`); }
            });
            list.appendChild(card);
        });
    }
    
    imageGeneratorCard?.addEventListener('click', () => switchScreen(imageGeneratorScreen));
    dietitianAgentCard?.addEventListener('click', () => {
        const dietitianConfig = toolConfigs["photo_dietitian_analyzer"];
        if (dietitianConfig) openChat(dietitianConfig); 
        else { tg.showAlert?.('–î–∏–µ—Ç–æ–ª–æ–≥ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.'); }
    });

    async function handleGenerateImage() { /* ... same as before ... */ }
    generateImageBtn?.addEventListener('click', handleGenerateImage);
    imagePromptInputEl?.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleGenerateImage(); });
    async function handleSummarizeText() { /* ... same as before ... */ }
    summarizeTextBtn?.addEventListener('click', handleSummarizeText);

    function displayProfileData() {
        const user = tg.initDataUnsafe?.user;
        const avatarImg = document.getElementById('profile-avatar-img');
        const profileNameEl = document.getElementById('profile-name');
        const profileIdEl = document.getElementById('profile-id');
        const gemBalanceEl = document.getElementById('gem-balance');

        if (user && user.id) {
            if (user.photo_url) {
                avatarImg.style.backgroundImage = `url(${user.photo_url})`;
                avatarImg.innerHTML = ''; 
            } else {
                avatarImg.style.backgroundImage = '';
                avatarImg.style.backgroundColor = '#444'; 
                avatarImg.innerHTML = (user.first_name || 'U').charAt(0).toUpperCase();
            }
            profileNameEl.textContent = `${user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${user.last_name || ''}`.trim();
            profileIdEl.textContent = `ID: ${user.id}`;
        } else {
            avatarImg.style.backgroundImage = '';
            avatarImg.style.backgroundColor = '#444';
            avatarImg.innerHTML = '?'; 
            profileNameEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            profileIdEl.textContent = 'ID: –ù/–î';
        }
        gemBalanceEl.textContent = "0.0"; // Placeholder
    }

    function updateNavArrows(swiperInstance, prefix) { /* ... same as before ... */ }

    function openChat(config) { 
        selectedAgentKey = config.key; 
        if (chatAgentNameEl) chatAgentNameEl.textContent = config.name;
        let modelToDisplay, currentModelForBackend;

        // Explicitly manage visibility of chat header elements based on chat type
        if (config.key === "photo_dietitian_analyzer") { 
            chatScreen.classList.add('dietitian-chat-active'); // Used for attach button visibility
            chatPromptInput.placeholder = "–§–æ—Ç–æ: –≤–µ—Å, –¥–µ—Ç–∞–ª–∏..."; // Shortened placeholder
            currentModelForBackend = config.forced_model_key || models[0].key;
            const dietitianModelDetails = models.find(m => m.key === currentModelForBackend);
            modelToDisplay = dietitianModelDetails?.name || currentModelForBackend;
            
            chatModelNameEl.style.display = 'none';
            chatSettingsBtn.style.display = 'none';
            chatAttachFileBtn.style.display = 'flex'; // Show attach for dietitian
        } else { 
            chatScreen.classList.remove('dietitian-chat-active');
            chatPromptInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ...";
            currentModelForBackend = selectedModelKey; 
            const generalAgentModelDetails = models.find(m => m.key === currentModelForBackend);
            modelToDisplay = generalAgentModelDetails?.name || currentModelForBackend;

            chatModelNameEl.style.display = 'block';
            chatSettingsBtn.style.display = 'flex'; // Ensure it's flex for proper centering
            chatAttachFileBtn.style.display = 'none'; // Hide attach for general agents
        }
        if (chatModelNameEl) chatModelNameEl.textContent = modelToDisplay; // This will be hidden for dietitian by style.display
        
        agentSelect.value = selectedAgentKey; 
        modelSelect.value = currentModelForBackend; 

        clearImagePreview();
        loadChatFromLocalStorage(); 

        if (chatMessagesContainer.children.length === 0) { 
            let welcomeMessageText = `–ü—Ä–∏–≤–µ—Ç! –Ø ${config.name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`;
            if (config.key === "photo_dietitian_analyzer") {
                welcomeMessageText = `–ü—Ä–∏–≤–µ—Ç! –Ø ${config.name}. –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –±–ª—é–¥–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å –ø–æ—Ä—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ö–ë–ñ–£.`;
            }
            if (welcomeMessageText) {
                addMessageToChat('bot', { text: welcomeMessageText });
            }
        }
        switchScreen(chatScreen);
    }

    function closeChat() { 
        stopPolling();
        // No need to remove dietitian-chat-active here, openChat will set it correctly.
        clearImagePreview();
        switchScreen(mainScreen); 
     }
    function openSettingsModal() { 
        // This modal is only for general agent chats.
        // Ensure agentSelect reflects the current general agent and modelSelect the global model.
        if (!chatScreen.classList.contains('dietitian-chat-active')) {
            agentSelect.value = selectedAgentKey; 
            modelSelect.value = selectedModelKey;
            settingsModal.style.display = 'flex';
        }
    }
    function closeSettingsModal() { settingsModal.style.display = 'none'; }
    function viewportChangedHandler() { /* ... same as before ... */ }

    function init() {
        if (tg.ready) tg.ready();
        if (tg.expand) tg.expand(); 
        if (tg.MainButton) tg.MainButton.hide();
        if (tg.onEvent) tg.onEvent('viewportChanged', viewportChangedHandler);
        setTimeout(viewportChangedHandler, 200); 

        populateCarousel('agents-swiper-wrapper', generalAgents, 'agent'); 
        populateCarousel('models-swiper-wrapper', models, 'model');
        
        agentsSwiper = new Swiper("#agents-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'agents') }, slideChange(s){ updateNavArrows(s, 'agents') } }});
        modelsSwiper = new Swiper("#models-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'models') }, slideChange(s){ updateNavArrows(s, 'models') } }});
        document.getElementById('agents-nav-prev')?.addEventListener('click', () => agentsSwiper?.slidePrev());
        document.getElementById('agents-nav-next')?.addEventListener('click', () => agentsSwiper?.slideNext());
        document.getElementById('models-nav-prev')?.addEventListener('click', () => modelsSwiper?.slidePrev());
        document.getElementById('models-nav-next')?.addEventListener('click', () => modelsSwiper?.slideNext());

        populateToolsList(); 
        displayProfileData(); 

        agentSelect.innerHTML = ''; 
        generalAgents.forEach(a => { 
            const icon = a.icon || "üë§";
            agentSelect.appendChild(new Option(`${icon} ${a.name}`, a.key));
        });
        modelSelect.innerHTML = ''; 
        models.forEach(m => modelSelect.appendChild(new Option(m.name, m.key))); 

        document.querySelectorAll('.tab-item').forEach(tab => tab.addEventListener('click', () => showTab(tab.dataset.tab)));
        
        chatSendMessageBtn.addEventListener('click', handleSendMessage);
        chatPromptInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey && !chatSendMessageBtn.disabled) { 
                e.preventDefault(); handleSendMessage(); 
            } 
        });

        chatBackButton?.addEventListener('click', closeChat); // This is the in-app back button
        chatSettingsBtn?.addEventListener('click', openSettingsModal); 
        document.querySelector('.modal-close-btn')?.addEventListener('click', closeSettingsModal);
        settingsModal?.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

        agentSelect.addEventListener('change', (e) => {
            const newAgentKey = e.target.value;
            const agentConfig = generalAgents.find(a => a.key === newAgentKey); 
            if (agentConfig) { 
                selectedAgentKey = newAgentKey; 
                if (chatAgentNameEl) chatAgentNameEl.textContent = agentConfig.name;
                const modelDetails = models.find(m => m.key === selectedModelKey); // Use current global selectedModelKey
                if (chatModelNameEl) chatModelNameEl.textContent = modelDetails?.name || selectedModelKey; 
                modelSelect.value = selectedModelKey; 
                
                // Ensure chat is configured as general agent chat
                chatScreen.classList.remove('dietitian-chat-active'); 
                chatPromptInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ...";
                chatModelNameEl.style.display = 'block';
                chatSettingsBtn.style.display = 'flex';
                chatAttachFileBtn.style.display = 'none';

                clearImagePreview();
                loadChatFromLocalStorage(); 
                if (chatMessagesContainer.children.length === 0) {
                    addMessageToChat('bot', { text: `–ê–≥–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${agentConfig.name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?` });
                }
            }
        });
        
        modelSelect.addEventListener('change', (e) => { 
            selectedModelKey = e.target.value; 
            const modelDetails = models.find(m => m.key === selectedModelKey);
            if (chatModelNameEl) chatModelNameEl.textContent = modelDetails?.name || selectedModelKey; 
            if (chatScreen.classList.contains('active') && !chatScreen.classList.contains('dietitian-chat-active')) {
                addMessageToChat('bot', { text: `–ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${modelDetails?.name || selectedModelKey}.`});
            }
        });

        autoResizeTextarea.call(chatPromptInput); 
        showTab('home');
        if (tg.BackButton) tg.BackButton.hide();

        const initialAgentDisplay = generalAgents.find(a => a.key === selectedAgentKey);
        const initialModelDisplay = models.find(m => m.key === selectedModelKey);
        if (initialAgentDisplay && chatAgentNameEl) chatAgentNameEl.textContent = initialAgentDisplay.name;
        if (initialModelDisplay && chatModelNameEl) chatModelNameEl.textContent = initialModelDisplay.name;
    }
    init();
});
</script>
</body>
</html>
