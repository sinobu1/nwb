<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
    <title>AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <style>
        :root {
            --bg-main: #101010;
            --bg-card: #1E1E1E;
            --bg-select: #2C2C2E;
            --bg-user-msg: #3E3E42;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --border-color: #3A3A3C;
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
            --gold-highlight: #d8ab4e;
        }
        html, body { position: fixed; inset: 0; overflow: hidden; font-family: var(--font-family); background-color: var(--bg-main); color: var(--text-primary); display: flex; justify-content: center; overscroll-behavior-y: contain; }
        .app-wrapper { width: 100%; max-width: 450px; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; transition: opacity 0.2s ease-out, visibility 0.2s ease-out; background-color: var(--bg-main); z-index: 10; will-change: opacity, visibility; }
        .screen.active { z-index: 20; }
        .screen:not(.active) { opacity: 0; visibility: hidden; pointer-events: none; }
        #main-screen { flex-grow: 1; }
        #main-content-area { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 3rem 1rem 1rem 1rem; }
        .content-pane { display: none; }
        .content-pane.active { display: block; }
        h1 { font-size: 1.875rem; font-weight: 800; }
        h2 { font-size: 1.25rem; font-weight: 700; }
        p.subtitle { font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .swiper-container-wrapper { margin-top: 2rem; }
        .swiper-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .swiper-nav-arrows { display: flex; gap: 0.5rem; }
        .swiper-nav-arrow { width: 32px; height: 32px; background-color: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 0.2s, transform 0.1s; }
        .swiper-nav-arrow:active { transform: scale(0.9); }
        .swiper-nav-arrow.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .swiper-slide { width: 200px; height: 130px; cursor: pointer; }
        .tg-card { border-radius: 20px; overflow: hidden; height: 100%; }
        .carousel-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem; text-align: left; }
        .card-icon { font-size: 1.75rem; }
        .card-title { font-size: 1rem; font-weight: 700; color: #FFFFFF; }
        .card-description { font-size: 0.875rem; color: #FFFFFF; opacity: 0.85; margin-top: 0.25rem; }
        .palette-1 { background: linear-gradient(45deg, #FF416C, #FF4B2B); }
        .palette-2 { background: linear-gradient(45deg, #12C2E9, #C471ED, #F64F59); }
        .palette-3 { background: linear-gradient(45deg, #00C9FF, #92FE9D); }
        .palette-4 { background: linear-gradient(45deg, #FAD961, #F76B1C); }
        .palette-5 { background: linear-gradient(45deg, #4A00E0, #8E2DE2); }
        .palette-6 { background-color: #2D2D2D; }
        .full-screen-card-list { display: grid; gap: 1rem; margin-top: 1.5rem; }
        .full-screen-card { background-color: var(--bg-card); border-radius: 20px; padding: 1.5rem; display: flex; align-items: center; gap: 1.5rem; cursor: pointer; transition: transform 0.1s; }
        .full-screen-card:active { transform: scale(0.98); }
        .chat-header { flex-shrink: 0; padding: 0.75rem 1rem; background: rgba(20,20,20,0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 20; }
        .chat-header .title { font-weight: 600; text-align: center; flex-grow: 1; }
        .chat-header-btn { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
        .chat-header-btn:hover { background-color: var(--bg-card); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; }
        .ios-tab-bar { flex-shrink: 0; max-width: 400px; width: calc(100% - 2.5rem); margin: 0 auto 1.25rem auto; display: flex; background: rgba(20,20,20,0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .tab-item { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
        .tab-item.active { color: var(--gold-highlight); }
        .tab-item svg { width: 28px; height: 28px; margin-bottom: 2px; }
        .tab-item span { font-size: 0.625rem; font-weight: 500; }
        .ios-card { background-color: var(--bg-card); border-radius: 1rem; padding: 1rem; margin-top: 1.5rem; }
        .profile-header { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .profile-avatar { width: 64px; height: 64px; border-radius: 50%; margin-right: 1rem; background-color: #333; }
        .profile-gems { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; }
        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card); padding: 1.5rem; border-radius: 1rem; width: calc(100% - 2rem); max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .custom-select { width: 100%; background-color: var(--bg-select); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 1rem; margin-top: 0.5rem;}
        .chat-message { padding: 0.6rem 1rem; border-radius: 1.25rem; max-width: 85%; word-wrap: break-word; line-height: 1.4; opacity: 0; transform: translateY(10px); animation: pop-in 0.3s ease forwards; margin-top: 0.75rem; will-change: transform, opacity; }
        @keyframes pop-in { to { opacity: 1; transform: translateY(0); } }
        .message-bot { background-color: var(--bg-card); align-self: flex-start; }
        .message-user { background-color: var(--bg-user-msg); align-self: flex-end; }
        .message-bot.tailed { border-bottom-left-radius: 0.25rem; }
        .message-user.tailed { border-bottom-right-radius: 0.25rem; }
        .chat-message.grouped { margin-top: 0.25rem; }
        .chat-message.no-tail { border-bottom-left-radius: 1.25rem; border-bottom-right-radius: 1.25rem; }
        .message-bot.typing { color: var(--text-secondary); font-style: italic; }
        .typing .message-content::after { content: '.'; animation: dots 1.2s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: '...'; } }
        .message-meta { display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-secondary); float: right; margin-left: 0.75rem; margin-top: 0.25rem; line-height: 1; user-select: none; }
        .message-meta svg { width: 1rem; height: 1rem; }
        .message-status-read svg { color: #4fc3f7; }
        .chat-date-divider { text-align: center; margin: 1rem auto; background-color: rgba(44, 44, 46, 0.8); color: var(--text-primary); font-size: 0.8rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 1rem; width: fit-content; }
        .chat-input-area { flex-shrink: 0; padding: 0.5rem 0.75rem; border-top: 1px solid var(--border-color); background-color: var(--bg-main); display: flex; align-items: flex-end; gap: 0.5rem; }
        .chat-input-wrapper { flex-grow: 1; position: relative; }
        #chat-input { width: 100%; background-color: var(--bg-card); border-radius: 20px; padding: 0.75rem 1rem; border: none; color: var(--text-primary); font-size: 1rem; resize: none; line-height: 1.4; min-height: calc(0.75rem * 2 + 1.4em); max-height: 120px; overflow-y: auto; }
        #chat-input-shadow { position: absolute; top: 0; left: 0; width: 100%; visibility: hidden; pointer-events: none; z-index: -1; word-wrap: break-word; white-space: pre-wrap; font-size: 1rem; line-height: 1.4; padding: 0.75rem 1rem; }
        .chat-action-btn { width: 40px; height: 40px; background-color: var(--bg-card); color: var(--text-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s ease; }
        #attach-btn { background-color: transparent; }
        #send-mic-btn-container { background-color: var(--gold-highlight); color: black; position: relative; transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0.9); }
        #send-mic-btn-container.has-text { transform: scale(1); }
        #send-mic-btn-container > div { position: absolute; top: 50%; left: 50%; transition: opacity 0.15s ease, transform 0.15s ease; transform: translate(-50%, -50%); }
        #mic-btn-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        #send-btn-icon { opacity: 0; transform: translate(-50%, -50%) scale(0.5); color: black; }
        #send-mic-btn-container.has-text #mic-btn-icon { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        #send-mic-btn-container.has-text #send-btn-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .chat-action-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="main-screen" class="screen active">
            <div id="main-content-area">
                <div id="home-content" class="content-pane active">
                    <h1>–ì–ª–∞–≤–Ω–∞—è</h1><p class="subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
                    <div class="full-screen-card" style="margin-top: 1.5rem;">
                        <div class="icon" style="font-size: 2rem;">üé®</div><div class="info"><h3>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3><p>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é.</p></div>
                    </div>
                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>–ê–≥–µ–Ω—Ç—ã</h2><div class="swiper-nav-arrows"><div id="agents-nav-prev" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="2"/></svg></div><div id="agents-nav-next" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="2"/></svg></div></div></div>
                        <div class="swiper" id="agents-swiper"><div class="swiper-wrapper" id="agents-swiper-wrapper"></div></div>
                    </div>
                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>–ú–æ–¥–µ–ª–∏</h2><div class="swiper-nav-arrows"><div id="models-nav-prev" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="2"/></svg></div><div id="models-nav-next" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="2"/></svg></div></div></div>
                        <div class="swiper" id="models-swiper"><div class="swiper-wrapper" id="models-swiper-wrapper"></div></div>
                    </div>
                </div>
                <div id="tools-content" class="content-pane">
                    <h1>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h1><p class="subtitle">–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –±–∞–∑–µ –ò–ò</p>
                    <div id="tools-list" class="full-screen-card-list"></div>
                </div>
                <div id="profile-content" class="content-pane">
                    <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1><p class="subtitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ</p>
                    <div class="ios-card">
                       <div class="profile-header"><img id="profile-avatar-img" alt="Avatar" class="profile-avatar"><div class="profile-info"><h2 id="profile-name"></h2><p id="profile-id"></p></div></div>
                       <div class="profile-gems"><span>üíé –ë–∞–ª–∞–Ω—Å –≥–µ–º–æ–≤</span><span id="gem-balance" style="font-weight:700;">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span></div>
                    </div>
                </div>
            </div>
            <nav class="ios-tab-bar">
                <div class="tab-item active" data-tab="home"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 3H4a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1zm0 11H4a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1zm11-11h-6a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1zm-1 12h-6a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1z"/></svg><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
                <div class="tab-item" data-tab="tools"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83L19.5 9.5l1.21-2.46zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg><span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span></div>
                <div class="tab-item" data-tab="profile"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1c-1.29 1.92-3.5 3.2-6 3.2zM12 5a3 3 0 110 6 3 3 0 010-6zm0-3a10 10 0 100 20 10 10 0 000-20z"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
            </nav>
        </div>

        <div id="chat-screen" class="screen">
            <div class="chat-header">
                 <div id="chat-title" class="title"></div>
                 <div id="chat-settings-btn" class="chat-header-btn">
                     <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17-.47.41l.36 2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.21.08-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                 </div>
            </div>
            <div class="chat-messages" id="chat-messages-container"></div>
            <div class="chat-input-area">
                <div id="attach-btn" class="chat-action-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </div>
                <div class="chat-input-wrapper">
                    <div id="chat-input-shadow"></div>
                    <textarea id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                </div>
                <div id="send-mic-btn-container" class="chat-action-btn">
                    <div id="mic-btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14a2 2 0 0 0 2-2V6a2 2 0 0 0-4 0v6a2 2 0 0 0 2 2zm-1-10a3 3 0 0 1 6 0v6a3 3 0 0 1-6 0V4z"/><path d="M19 11a1 1 0 0 0-2 0 5 5 0 0 1-10 0 1 1 0 0 0-2 0 7 7 0 0 0 6 6.93V21h-2a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2h-2v-3.07A7 7 0 0 0 19 11z"/></svg>
                    </div>
                    <div id="send-btn-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3.49999 20.5C4.33332 21.3333 5.66666 21.1667 6.33332 20.5L21.3333 13C22.1667 12.5 22.1667 11.5 21.3333 11L6.33332 3.5C5.66666 2.83333 4.33332 2.66667 3.49999 3.5C2.66666 4.33333 2.83332 5.66667 3.49999 6.33333L16.1667 12L3.49999 17.6667C2.83332 18.3333 2.66666 19.6667 3.49999 20.5Z"/></svg>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="settings-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"><h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3><div class="modal-close-btn" style="cursor: pointer;">‚úï</div></div>
                <div><label for="agent-select">–ê–ì–ï–ù–¢</label><select id="agent-select" class="custom-select"></select></div>
                <div style="margin-top: 1rem;"><label for="model-select">–ú–û–î–ï–õ–¨</label><select id="model-select" class="custom-select"></select></div>
            </div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram.WebApp;
    let lastMessageInfo = { sender: null, date: null };

    // ... (–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã agents, models, tools –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ DOM –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    const agents = [ { key: "universal_ai_basic", name: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª", icon: "üåç", desc: "–û—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã", palette: "palette-5" }, { key: "idea_generator", name: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π", icon: "üí°", desc: "–ü–æ–º–æ—â—å –≤ –ø–æ–∏—Å–∫–µ –∏–¥–µ–π", palette: "palette-4" }, { key: "career_coach", name: "–ö–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ—É—á", icon: "üìà", desc: "–°–æ–≤–µ—Ç—ã –ø–æ –∫–∞—Ä—å–µ—Ä–µ", palette: "palette-3" }, { key: "programming_partner", name: "–ü–∞—Ä—Ç–Ω–µ—Ä-–ø—Ä–æ–≥–µ—Ä", icon: "üíª", desc: "–ü–æ–º–æ—â—å –≤ –∫–æ–¥–µ", palette: "palette-2" }, { key: "tutor_assistant", name: "–†–µ–ø–µ—Ç–∏—Ç–æ—Ä", icon: "üìö", desc: "–ü–æ–º–æ—â—å —Å —É—á–µ–±–æ–π", palette: "palette-1" }, { key: "literary_editor", name: "–†–µ–¥–∞–∫—Ç–æ—Ä", icon: "‚úçÔ∏è", desc: "–£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤", palette: "palette-6" } ];
    const models = [ { key: "google_gemini_2_0_flash", name: "Gemini 2.0", icon: "‚ö°Ô∏è", desc: "–ë—ã—Å—Ç—Ä–∞—è –∏ –¥–æ—Å—Ç—É–ø–Ω–∞—è", palette: "palette-6" }, { key: "google_gemini_2_5_flash_preview", name: "Gemini 2.5 Flash", icon: "‚ú®", desc: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å", palette: "palette-1" }, { key: "custom_api_gemini_2_5_pro", name: "Gemini Pro", icon: "üíé", desc: "–ú–æ—â–Ω–∞—è –∏ —Ç–æ—á–Ω–∞—è", palette: "palette-5" }, { key: "custom_api_grok_3", name: "Grok 3", icon: "üê∏", desc: "–° —é–º–æ—Ä–æ–º –∏ —Å–∞—Ä–∫–∞–∑–º–æ–º", palette: "palette-2" }, { key: "custom_api_gpt_4o_mini", name: "GPT-4o mini", icon: "üí°", desc: "–ë—ã—Å—Ç—Ä–∞—è –∏ –Ω–µ–¥–æ—Ä–æ–≥–∞—è", palette: "palette-3" } ];
    const tools = [ { key: "text_analyzer", name: "–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞", icon: "üîç", desc: "–ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤." }, { key: "translator_pro", name: "–ü—Ä–æ-–ø–µ—Ä–µ–≤–æ–¥—á–∏–∫", icon: "üåê", desc: "–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ä–µ—á–∏." }, { key: "summarizer", name: "–°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä", icon: "üìë", desc: "–ö—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –∏ –≤–∏–¥–µ–æ." } ];
    let selectedAgentKey = agents[0].key;
    let selectedModelKey = models[0].key;
    let agentsSwiper, modelsSwiper;
    const mainScreen = document.getElementById('main-screen');
    const chatScreen = document.getElementById('chat-screen');
    const chatTitle = document.getElementById('chat-title');
    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatInput = document.getElementById('chat-input');
    const chatInputShadow = document.getElementById('chat-input-shadow');
    const settingsModal = document.getElementById('settings-modal');
    const agentSelect = document.getElementById('agent-select');
    const modelSelect = document.getElementById('model-select');
    const sendMicContainer = document.getElementById('send-mic-btn-container');

    function formatTime(date) { return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }

    function sendDataToBot(data) {
        if (!tg.sendData) {
            console.error("Telegram.WebApp.sendData is not available.");
            return;
        }
        // –ú—ã –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ.
        tg.sendData(JSON.stringify(data));
    }

   // --- –ù–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

function saveChatToLocalStorage() {
    localStorage.setItem('miniAppChatHistory_' + selectedAgentKey, JSON.stringify(currentMiniAppChatHistory));
}

function loadChatFromLocalStorage() {
    const savedHistory = localStorage.getItem('miniAppChatHistory_' + selectedAgentKey);
    chatMessagesContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
    lastMessageInfo = { sender: null, date: null };
    currentMiniAppChatHistory = []; // –ù–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏

    if (savedHistory) {
        const parsedHistory = JSON.parse(savedHistory);
        parsedHistory.forEach(msg => {
            addMessageToChat(msg.sender, msg.text, { isRestoredFromHistory: true, timestamp: msg.timestamp });
        });
    }
}

function addMessageToChat(sender, text, options = {}) {
    const { isTyping = false, isRestoredFromHistory = false, timestamp: msgTimestamp } = options;
    const now = msgTimestamp ? new Date(msgTimestamp) : new Date(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ —Ç–µ–∫—É—â–µ–µ
    const currentDate = now.toDateString();

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –¥–∞—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if (!isTyping && (!lastMessageInfo.date || currentDate !== lastMessageInfo.date)) {
        const divider = document.createElement('div');
        divider.className = 'chat-date-divider';
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        if (currentDate === today) { divider.textContent = '–°–µ–≥–æ–¥–Ω—è'; }
        else if (currentDate === yesterday) { divider.textContent = '–í—á–µ—Ä–∞'; }
        else { divider.textContent = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }); }
        chatMessagesContainer.appendChild(divider);
    }
    
    const lastMessageElement = chatMessagesContainer.querySelector('.chat-message:last-of-type');
    if (!isTyping && lastMessageElement && sender === lastMessageInfo.sender && currentDate === lastMessageInfo.date) {
         lastMessageElement.classList.add('no-tail', 'grouped');
         lastMessageElement.classList.remove('tailed');
    }

    const msgDiv = document.createElement('div');
    msgDiv.className = `chat-message message-${sender} tailed`;
    
    const contentSpan = document.createElement('span');
    contentSpan.className = 'message-content';
    contentSpan.textContent = text;
    msgDiv.appendChild(contentSpan);

    if (!isTyping) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'message-meta';
        const timeSpan = document.createElement('span');
        timeSpan.textContent = formatTime(now);
        metaDiv.appendChild(timeSpan);
        msgDiv.appendChild(metaDiv);

        if (sender === 'bot' && !isRestoredFromHistory) { // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞
            const saveButton = document.createElement('button');
            saveButton.innerHTML = 'üíæ'; // –ò–∫–æ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            saveButton.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç';
            saveButton.className = 'save-to-bot-btn'; // –°—Ç–∏–ª–∏–∑—É–π—Ç–µ —ç—Ç—É –∫–Ω–æ–ø–∫—É
            saveButton.style.marginLeft = '8px';
            saveButton.style.padding = '2px 6px';
            saveButton.style.border = '1px solid var(--border-color)';
            saveButton.style.borderRadius = '4px';
            saveButton.style.background = 'var(--bg-card)';
            saveButton.style.color = 'var(--text-secondary)';
            saveButton.style.cursor = 'pointer';

            saveButton.onclick = () => {
                let userQueryText = "–ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                // –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –±–æ—Ç–∞
                const allMessages = Array.from(chatMessagesContainer.querySelectorAll('.chat-message'));
                const botMsgIndex = allMessages.findIndex(el => el === msgDiv);
                if (botMsgIndex > 0 && allMessages[botMsgIndex - 1].classList.contains('message-user')) {
                    userQueryText = allMessages[botMsgIndex - 1].querySelector('.message-content').textContent;
                }
                
                tg.sendData(JSON.stringify({
                    action: 'save_chat_to_telegram',
                    payload: { user_query: userQueryText, ai_response: text }
                }));
                saveButton.textContent = '‚úÖ';
                saveButton.disabled = true;
                tg.showAlert('–î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —Å –±–æ—Ç–æ–º!');
            };
            metaDiv.appendChild(saveButton);
        }
    } else {
        msgDiv.classList.add('typing');
    }
    
    chatMessagesContainer.appendChild(msgDiv);
    if (!isTyping && !isRestoredFromHistory) {
        currentMiniAppChatHistory.push({ sender, text, timestamp: now.toISOString() });
        saveChatToLocalStorage();
    }
    lastMessageInfo = { sender: sender, date: currentDate };

    requestAnimationFrame(() => {
        chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
    });
    return msgDiv;
}

async function submitMessageToBackend(userText, agentKey, modelKey) {
    const userId = tg.initDataUnsafe?.user?.id;
    if (!userId) {
        addMessageToChat('bot', "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
        return;
    }

    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –ø—É–±–ª–∏—á–Ω—ã–π URL —Å–µ—Ä–≤–µ—Ä–∞ (–∏–∑ CONFIG.WEBHOOK_URL –≤ Python)
    const backendProcessUrl = `${CONFIG.WEBHOOK_URL.rstrip('https://nwb-production.up.railway.app/')}/api/process_app_message/${userId}`;
    // –ï—Å–ª–∏ CONFIG.WEBHOOK_URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ JS, –≤–ø–∏—à–∏—Ç–µ URL –≤—Ä—É—á–Ω—É—é:
    // const backendProcessUrl = `https://your-app-name.onrender.com/api/process_app_message/${userId}`;

    try {
        const response = await fetch(backendProcessUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: userText, agentKey: agentKey, modelKey: modelKey })
        });
        if (!response.ok) {
            // –û—à–∏–±–∫–∞ –æ—Ç –Ω–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞, –µ–µ –Ω–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —á–∞—Ç,
            // —Ç–∞–∫ –∫–∞–∫ –æ—Ç–≤–µ—Ç –¥–ª—è —á–∞—Ç–∞ –ø—Ä–∏–¥–µ—Ç —á–µ—Ä–µ–∑ polling
            console.error("Error submitting message to backend:", response.statusText);
            tg.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.");
        }
        // –û—Ç–≤–µ—Ç –æ—Ç —ç—Ç–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è,
        // –æ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ. –û—Ç–≤–µ—Ç –ò–ò –ø—Ä–∏–¥–µ—Ç —á–µ—Ä–µ–∑ polling.
    } catch (error) {
        console.error("Network error submitting message to backend:", error);
        tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.");
        const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
        if (typingIndicator) typingIndicator.remove();
    }
}

function handleSendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    addMessageToChat('user', text); // –î–æ–±–∞–≤–ª—è–µ–º –≤ UI –∏ –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    chatInput.value = '';
    handleInput.call(chatInput); 

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏, –µ—Å–ª–∏ –±—ã–ª
    const oldTypingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
    if(oldTypingIndicator) oldTypingIndicator.remove();

    addMessageToChat('bot', '–ü–µ—á–∞—Ç–∞–µ—Ç', { isTyping: true }); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ò–ò
    submitMessageToBackend(text, selectedAgentKey, selectedModelKey);
}

// –§—É–Ω–∫—Ü–∏—è fetchUpdates –¥–ª—è –æ–ø—Ä–æ—Å–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ
// (–∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç /api/get_updates/{user_id})
function fetchUpdates() {
    const userId = tg.initDataUnsafe?.user?.id;
    if (!userId || !document.getElementById('chat-screen').classList.contains('active')) {
        // –ù–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ–º, –µ—Å–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∏–ª–∏ —ç–∫—Ä–∞–Ω —á–∞—Ç–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
        return;
    }
    const backendGetUpdatesUrl = `${CONFIG.WEBHOOK_URL.rstrip('/')}/api/get_updates/${userId}`;
    // –ò–ª–∏ –≤–∞—à –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π URL:
    // const backendGetUpdatesUrl = `https://your-app-name.onrender.com/api/get_updates/${userId}`;

    fetch(backendGetUpdatesUrl)
        .then(response => response.json())
        .then(data => {
            if (data && data.status === 'ok' && data.messages && data.messages.length > 0) {
                const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
                if (typingIndicator) typingIndicator.remove();
                
                data.messages.forEach(msg => {
                    addMessageToChat(msg.sender, msg.text, { timestamp: msg.timestamp });
                });
            }
        })
        .catch(error => console.error("Polling error:", error));
}

let pollingInterval = null;
function startPolling() {
    stopPolling(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
    fetchUpdates(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤
    pollingInterval = setInterval(fetchUpdates, 3000); // –û–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
}
function stopPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = null;
}

// –í openChat –∑–∞–ø—É—Å–∫–∞–µ–º polling –∏ –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ localStorage
function openChat() {
    agentSelect.value = selectedAgentKey;
    modelSelect.value = selectedModelKey;
    updateChatTitle();
    
    loadChatFromLocalStorage(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞

    if (currentMiniAppChatHistory.length === 0) { // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        const agent = agents.find(a => a.key === selectedAgentKey);
        addMessageToChat('bot', `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø - ${agent.name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
    }
    
    switchScreen(chatScreen);
    tg.BackButton.show();
    startPolling();
}

function closeChat() {
    stopPolling();
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å saveChatToLocalStorage() –∑–¥–µ—Å—å, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏,
    // –Ω–æ addMessageToChat —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ –º–µ—Ä–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.
    switchScreen(mainScreen);
    tg.BackButton.hide();
}

    function fetchUpdates() {
    const userId = tg.initDataUnsafe?.user?.id;
    if (!userId) return;

    // –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–∞—à–µ–º—É –Ω–æ–≤–æ–º—É API-—ç–Ω–¥–ø–æ–∏–Ω—Ç—É
    fetch(`https://nwb-production.up.railway.app/api/get_updates/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data && data.status === 'ok' && data.messages && data.messages.length > 0) {
                const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
                if (typingIndicator) typingIndicator.remove();
                
                data.messages.forEach(msg => {
                    addMessageToChat(msg.sender, msg.text);
                });
            }
        })
        .catch(error => console.error("Polling error:", error));
}

    
    function switchScreen(screenToShow) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); screenToShow.classList.add('active'); }
    function showTab(tabId) { document.querySelectorAll('.content-pane').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active')); document.getElementById(`${tabId}-content`).classList.add('active'); document.querySelector(`.tab-item[data-tab="${tabId}"]`).classList.add('active'); }
    function handleInput() { chatInputShadow.textContent = this.value + ' '; this.style.height = 'auto'; this.style.height = `${this.scrollHeight}px`; sendMicContainer.classList.toggle('has-text', this.value.trim().length > 0); }
    function populateCarousel(containerId, items, type) { const wrapper = document.getElementById(containerId); if (!wrapper) return; wrapper.innerHTML = ''; items.forEach(item => { const slide = document.createElement('div'); slide.className = 'swiper-slide'; slide.innerHTML = `<div class="tg-card"><div class="carousel-card ${item.palette}"><div class="card-icon">${item.icon}</div><div><h3 class="card-title">${item.name}</h3><p class="card-description">${item.desc}</p></div></div></div>`; slide.addEventListener('click', () => { if (type === 'agent') selectedAgentKey = item.key; if (type === 'model') selectedModelKey = item.key; openChat(); }); wrapper.appendChild(slide); }); }
    function populateToolsList() { const list = document.getElementById('tools-list'); if (!list) return; list.innerHTML = ''; tools.forEach(item => { const card = document.createElement('div'); card.className = 'full-screen-card'; card.innerHTML = `<div class="icon" style="font-size: 2rem;">${item.icon}</div><div class="info"><h3>${item.name}</h3><p>${item.desc}</p></div>`; list.appendChild(card); }); }
    function displayProfileData() { try { const user = tg.initDataUnsafe?.user; if (!user || !user.id) throw new Error("User data not found"); const avatar = document.getElementById('profile-avatar-img'); if (user.photo_url) { avatar.src = user.photo_url; } else { avatar.style.display = 'none'; } document.getElementById('profile-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; document.getElementById('profile-id').textContent = `ID: ${user.id}`; } catch (e) { document.getElementById('profile-name').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; document.getElementById('profile-id').textContent = 'ID: –ù/–î'; } }
    function updateNavArrows(swiper, prefix) { const prev = document.getElementById(`${prefix}-nav-prev`); const next = document.getElementById(`${prefix}-nav-next`); if(prev && next) { prev.classList.toggle('disabled', swiper.isBeginning); next.classList.toggle('disabled', swiper.isEnd); } }
    function openSettingsModal() { settingsModal.style.display = 'flex'; }
    function closeSettingsModal() { settingsModal.style.display = 'none'; }

    function init() {
    tg.ready();
    tg.expand();
    // tg.MainButton.setText("–ù–æ–≤–∞—è –ö–Ω–æ–ø–∫–∞").show().onClick(() => tg.showAlert("–ö–ª–∏–∫!")); // –ü—Ä–∏–º–µ—Ä –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    tg.MainButton.hide(); 
    tg.BackButton.onClick(closeChat);
    
    // –í–∞–∂–Ω–æ: –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ,
    // –∞ –¥–µ–ª–∞–µ–º —ç—Ç–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ –≤ openChat()
    // loadChatFromLocalStorage(); 

    populateCarousel('agents-swiper-wrapper', agents, 'agent');
    populateCarousel('models-swiper-wrapper', models, 'model');
    populateToolsList();
    displayProfileData();
    agents.forEach(a => agentSelect.appendChild(new Option(`${a.icon} ${a.name}`, a.key)));
    models.forEach(m => modelSelect.appendChild(new Option(m.name, m.key)));
    // ... (—Å–æ–∑–¥–∞–Ω–∏–µ Swiper-–æ–≤ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π)
    agentsSwiper = new Swiper("#agents-swiper", { slidesPerView: 'auto', spaceBetween: 12, on: { init(s){ updateNavArrows(s, 'agents') }, slideChange(s){ updateNavArrows(s, 'agents') } }});
    modelsSwiper = new Swiper("#models-swiper", { slidesPerView: 'auto', spaceBetween: 12, on: { init(s){ updateNavArrows(s, 'models') }, slideChange(s){ updateNavArrows(s, 'models') } }});
    document.querySelectorAll('.tab-item').forEach(tab => tab.addEventListener('click', () => showTab(tab.dataset.tab)));
    document.getElementById('agents-nav-prev').addEventListener('click', () => agentsSwiper.slidePrev());
    document.getElementById('agents-nav-next').addEventListener('click', () => agentsSwiper.slideNext());
    document.getElementById('models-nav-prev').addEventListener('click', () => modelsSwiper.slidePrev());
    document.getElementById('models-nav-next').addEventListener('click', () => modelsSwiper.slideNext());
    sendMicContainer.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
    chatInput.addEventListener('input', handleInput);
    document.getElementById('chat-settings-btn').addEventListener('click', openSettingsModal);
    document.querySelector('.modal-close-btn')?.addEventListener('click', closeSettingsModal);
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });
    agentSelect.addEventListener('change', (e) => { 
        selectedAgentKey = e.target.value; 
        updateChatTitle(); 
        // –¢–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∂–µ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ fetch –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏, 
        // –Ω–æ sendData —Ç–æ–∂–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (—Å —Å–µ—Ä–≤–∏—Å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
        tg.sendData(JSON.stringify({ action: 'set_agent', target: selectedAgentKey }));
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        loadChatFromLocalStorage(); 
        if (currentMiniAppChatHistory.length === 0) {
             const agent = agents.find(a => a.key === selectedAgentKey);
             addMessageToChat('bot', `–ê–≥–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${agent.name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
        }
    });
    modelSelect.addEventListener('change', (e) => { 
        selectedModelKey = e.target.value; 
        updateChatTitle();
        tg.sendData(JSON.stringify({ action: 'set_model', target: selectedModelKey }));
    });
    handleInput.call(chatInput);
}

init();
</script>
</body>
</html>
