<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
    <title>AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <style>
        :root {
            --bg-main: #000000; 
            --bg-card: #121212; 
            --bg-select: #2C2C2E;
            --bg-user-msg: #3E3E42;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --border-color: #282828; 
            --app-wrapper-border: #000000; 
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
            --gold-highlight: #d8ab4e; 
            --success-green: #4CAF50;
            --error-red: #F44336;
            --ios-tab-bar-bg: rgba(28, 28, 30, 0.85); 
        }
        html {
            height: 100%; 
        }
        body {
            height: 100%; 
            overflow: hidden; 
            font-family: var(--font-family);
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            overscroll-behavior-y: contain; 
            margin: 0;
            padding: 0;
        }
        .app-wrapper {
            width: 100%;
            max-width: 450px; 
            height: 100%; 
            position: relative; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--app-wrapper-border); 
            border-right: 1px solid var(--app-wrapper-border); 
        }
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column; 
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out;
            background-color: var(--bg-main);
            z-index: 10;
            will-change: opacity, visibility;
            padding-bottom: env(safe-area-inset-bottom); 
        }
        .screen.active { z-index: 20; opacity: 1; visibility: visible; }
        .screen:not(.active) { opacity: 0; visibility: hidden; pointer-events: none; }

        #main-screen, #image-generator-screen, #summarizer-screen, #chat-screen { flex-grow: 1; } 
        #main-content-area, .feature-content-area { 
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
         .fixed-header { 
            padding: 0.75rem 1rem;
            background: rgba(18,18,18,0.85); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            align-items: center; 
            gap: 0.5rem; 
            border-bottom: 1px solid var(--border-color);
            z-index: 25; 
            color: var(--text-primary);
            position: sticky; 
            top: 0;
            flex-shrink: 0;
            min-height: 56px; 
        }
        .fixed-header h1 { font-size: 1.125rem; font-weight: 600; margin: 0; flex-grow: 1; text-align: center; } 
        .fixed-header .back-btn {
            color: var(--gold-highlight); 
            cursor: pointer;
            padding: 0.25rem; 
        }
         .main-screen-header { 
            padding: 1rem 1rem 0.5rem 1rem;
            background-color: var(--bg-main);
            flex-shrink: 0;
        }
        .main-screen-header h1 { font-size: 1.875rem; font-weight: 800; margin-bottom: 0.25rem; }
        .main-screen-header p.subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; }


        .content-pane { display: none; }
        .content-pane.active { display: block; }

        h2 { font-size: 1.25rem; font-weight: 700; }


        .swiper-container-wrapper { margin-top: 0.75rem; flex-shrink: 0; } 
        .swiper-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 0.75rem; 
            padding: 0 0.25rem; 
        }
        .swiper-header h2 {
            font-size: 1.4rem; 
            font-weight: 700;
        }
        .swiper-nav-arrows { display: flex; gap: 0.5rem; }
        .swiper-nav-arrow { 
            width: 36px; 
            height: 36px; 
            background-color: var(--bg-card); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: opacity 0.2s, transform 0.1s; 
            color: var(--text-secondary); 
        }
        .swiper-nav-arrow svg { 
            width: 18px; 
            height: 18px;
        }
        .swiper-nav-arrow:hover { color: var(--text-primary); }
        .swiper-nav-arrow:active { transform: scale(0.9); }
        .swiper-nav-arrow.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        
        .swiper-slide { width: 180px; height: 120px; cursor: pointer; }
        .tg-card { border-radius: 16px; overflow: hidden; height: 100%; }
        .carousel-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 0.75rem; text-align: left; }
        .card-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .card-title { font-size: 0.9rem; font-weight: 600; color: #FFFFFF; }
        .card-description { font-size: 0.75rem; color: #FFFFFF; opacity: 0.80; margin-top: 0.1rem; line-height: 1.2; }

        .palette-grad-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .palette-grad-2 { background: linear-gradient(135deg, #ff8c00 0%, #ff0080 100%); }
        .palette-grad-3 { background: linear-gradient(135deg, #20bf55 0%, #01baef 100%); }
        .palette-grad-4 { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
        .palette-grad-5 { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); }
        .palette-grad-6 { background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%); }
        .palette-grad-7 { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .palette-grad-8 { background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); }
        .palette-grad-default { background-color: #2D2D2D; } 

        .full-screen-card-list { display: grid; gap: 0.75rem; margin-top: 1rem; }
        .full-screen-card { 
            background-color: var(--bg-card); 
            border-radius: 16px; 
            padding: 1rem; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            cursor: pointer; 
            transition: transform 0.1s; 
            margin-bottom: 0.75rem; 
        }
        .full-screen-card:last-child {
            margin-bottom: 0; 
        }
        .full-screen-card:active { transform: scale(0.98); }
        .full-screen-card .icon { font-size: 1.75rem; }
        .full-screen-card .info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.1rem;}
        .full-screen-card .info p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.3;}

        .ios-tab-bar {
            flex-shrink: 0;
            max-width: 400px;
            width: calc(100% - 2rem);
            margin: 0 auto 1rem auto; 
            display: flex;
            border-radius: 16px; 
            padding: 0.3rem; 
            background-color: var(--ios-tab-bar-bg); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 100;
            position: relative; 
        }
        .tab-item { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: color 0.2s, background-color 0.2s; 
            padding: 0.35rem 0; 
            border-radius: 12px; 
            background-color: transparent; 
            margin: 0.1rem; 
        }
        .tab-item.active { 
            color: var(--gold-highlight); 
            background-color: rgba(80, 80, 80, 0.5); 
        }
        .tab-item:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.05); 
        }
        .tab-item svg { width: 22px; height: 22px; margin-bottom: 2px; } 
        .tab-item span { font-size: 0.6rem; font-weight: 500; }

        .ios-card { background-color: var(--bg-card); border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
        .profile-header { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 1rem;
            background-color: #333;
            background-size: cover;
            background-position: center;
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; 
            font-weight: 500;
            color: var(--text-primary);
        }
        .profile-info h2 { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.2rem 0;}
        .profile-info p { font-size: 0.85rem; color: var(--text-secondary); margin:0;}
        .profile-gems { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; font-size: 0.9rem;}

        /* Chat Screen Specific Styles */
        #chat-screen { display: flex; flex-direction: column; }

        #chat-screen .chat-header { 
            justify-content: space-between; 
        }
        .chat-title-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            text-align: center;
            overflow: hidden; 
        }
        #chat-agent-name {
            font-size: 1.0rem; 
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
            display: block; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            max-width: 100%; 
        }
        #chat-model-name {
            font-size: 0.75rem; 
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.1;
            display: block; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        /* .dietitian-chat-active styles are now applied via JS for explicit control */
        
        .chat-header-btn { 
            width: 38px; 
            height: 38px; 
            border-radius: 50%; 
            display: flex; /* Ensures SVG is centered */
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            color: var(--text-secondary); 
            flex-shrink: 0; 
        }
        .chat-header-btn svg { /* Ensure SVG scales well within button */
            width: 20px; /* Adjusted for better visual fit */
            height: 20px; /* Adjusted for better visual fit */
        }

        .chat-header-btn#chat-back-btn { color: var(--gold-highlight); }
        .chat-header-btn#chat-back-btn svg { width: 22px; height: 22px; } /* Specific size for back arrow if needed */
        .chat-header-btn:hover { background-color: var(--bg-card); }
        
        .chat-messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 1rem; 
            display: flex; 
            flex-direction: column; 
            gap: 0.25rem; 
            -webkit-overflow-scrolling: touch; 
            cursor: default; 
        }
        
        .chat-input-area { 
            flex-shrink: 0; 
            padding: 0.75rem; 
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); 
            border-top: 1px solid var(--border-color); 
            background-color: var(--bg-main); 
            display: flex;
            align-items: flex-end; 
            gap: 0.75rem; 
            z-index: 15; 
        }
        #chat-attach-file-btn {
            flex-shrink: 0;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.25rem; 
        }
        #chat-attach-file-btn svg {
            width: 24px;
            height: 24px;
        }
        #chat-attach-file-btn:hover {
            color: var(--text-primary);
        }
        /* Hiding attach button is now done via JS in openChat */

        .image-preview-container {
            display: none; 
            padding: 0.5rem 0.75rem 0; 
            flex-shrink: 0;
        }
        .image-preview-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-card);
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .image-preview-item img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 0.5rem;
            object-fit: cover;
        }
        .remove-preview-btn {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        #chat-prompt-input { 
            flex-grow: 1; 
            background-color: var(--bg-card);
            border-radius: 20px; 
            padding: 0.65rem 1rem; 
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.95rem; 
            line-height: 1.4; 
            min-height: 40px; 
            max-height: 120px; 
            resize: none; 
            overflow-y: auto; 
        }
        #chat-prompt-input:focus {
            outline: none;
            border-color: var(--gold-highlight);
            box-shadow: 0 0 0 1px var(--gold-highlight);
        }
        #chat-send-message-btn { 
            flex-shrink: 0; 
            padding: 0.65rem 1rem; 
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 20px; 
            font-size: 0.95rem; 
            font-weight: 500; 
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            height: 40px; 
            line-height: 1; 
        }
        #chat-send-message-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .chat-message { 
            padding: 0.5rem 0.9rem; 
            border-radius: 1.1rem; 
            max-width: 85%; 
            word-wrap: break-word; 
            line-height: 1.4; 
            opacity: 0; 
            transform: translateY(10px); 
            animation: pop-in 0.3s ease forwards; 
            margin-top: 0.65rem; 
            will-change: transform, opacity; 
            font-size: 0.9rem; 
            display: flex; 
            flex-direction: column; 
        }
        .chat-message img.message-image { 
            max-width: 100%;
            max-height: 200px; 
            border-radius: 0.75rem; 
            margin-bottom: 0.5rem; 
            object-fit: cover;
            cursor: pointer; 
        }
        .message-content-text { 
            word-wrap: break-word; 
        }

        @keyframes pop-in { to { opacity: 1; transform: translateY(0); } }
        .message-bot { background-color: var(--bg-card); align-self: flex-start; color: var(--text-primary); }
        .message-user { background-color: var(--bg-user-msg); align-self: flex-end; color: var(--text-primary); }
        .message-bot.tailed { border-bottom-left-radius: 0.25rem; }
        .message-user.tailed { border-bottom-right-radius: 0.25rem; }
        .chat-message.grouped { margin-top: 0.25rem; }
        .chat-message.no-tail { border-bottom-left-radius: 1.1rem; border-bottom-right-radius: 1.1rem; }
        
        .message-bot.typing .message-content-text::after { 
            content: '.'; 
            animation: dots 1.2s steps(5, end) infinite; 
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: '...'; } }
        
        .message-meta { 
            font-size: 0.7rem; 
            color: var(--text-secondary); 
            line-height: 1; 
            user-select: none; 
            margin-top: 0.2rem; 
            text-align: right; 
        }
        .message-user .message-meta { 
            align-self: flex-end;
        }
        .message-bot .message-meta { 
            align-self: flex-end; 
        }


        .chat-date-divider { text-align: center; margin: 1rem auto; background-color: rgba(44, 44, 46, 0.8); color: var(--text-primary); font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.6rem; border-radius: 1rem; width: fit-content; }

        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card); padding: 1.5rem; border-radius: 1rem; width: calc(100% - 2rem); max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .custom-select { width: 100%; background-color: var(--bg-select); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 1rem; margin-top: 0.5rem;}

        .feature-input-area { margin-bottom: 1rem; }
        .feature-input-area textarea, .feature-input-area input[type="text"] {
            width: 100%;
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 44px;
        }
        .feature-input-area textarea { min-height: 100px; }
        .feature-submit-btn { 
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }
        .feature-submit-btn:hover { background-color: #c89a3e; }
        .feature-submit-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }
        .generated-image-container { margin-top: 1rem; text-align: center; }
        .generated-image-container img { max-width: 100%; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-card); }
        .generated-image-container button { 
            margin-top: 0.75rem;
            background-color: var(--bg-select);
            color: var(--text-primary);
        }
        .summarizer-output { margin-top: 1rem; padding: 1rem; background-color: var(--bg-card); border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-primary); font-size: 0.9rem; }
        .error-message { color: var(--error-red); text-align: center; margin-top: 1rem; }

        #fullscreen-image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 2000; 
            padding: 1rem;
            box-sizing: border-box;
        }
        #fullscreen-image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        #fullscreen-image-viewer .close-fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        ::-webkit-scrollbar {
            width: 6px; 
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-main); 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #2a2a2a; 
            border-radius: 10px;
            border: 1px solid var(--bg-main); 
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #4a4a4a; 
        }
        * {
           scrollbar-width: thin;
           scrollbar-color: #2a2a2a var(--bg-main);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="main-screen" class="screen active"> 
            <div id="main-content-area"> 
                <div id="home-content" class="content-pane active">
                    <div class="main-screen-header">
                        <h1>Главная</h1>
                        <p class="subtitle">Панель управления ассистентом</p>
                    </div>
                    <div class="full-screen-card" id="image-generator-card">
                        <div class="icon" style="font-size: 2rem;">🎨</div>
                        <div class="info"><h3>Генератор изображений ✨</h3><p>Создание картинок по описанию.</p></div>
                    </div>
                    <div class="full-screen-card" id="dietitian-agent-card">
                        <div class="icon" style="font-size: 2rem;">🥑</div>
                        <div class="info"><h3>Диетолог (анализ фото)</h3><p>Анализ КБЖУ по фото блюда.</p></div>
                    </div>

                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>Агенты</h2><div class="swiper-nav-arrows"><div id="agents-nav-prev" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="agents-nav-next" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="agents-swiper"><div class="swiper-wrapper" id="agents-swiper-wrapper"></div></div>
                    </div>
                     <div class="swiper-container-wrapper"> <div class="swiper-header"><h2>Модели</h2><div class="swiper-nav-arrows"><div id="models-nav-prev" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="models-nav-next" class="swiper-nav-arrow"><svg width="18" height="18" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="models-swiper"><div class="swiper-wrapper" id="models-swiper-wrapper"></div></div>
                    </div>
                </div>
                <div id="tools-content" class="content-pane">
                    <div class="main-screen-header">
                        <h1>Инструменты</h1>
                        <p class="subtitle">Полезные функции на базе ИИ</p>
                    </div>
                    <div id="tools-list" class="full-screen-card-list">
                        </div>
                </div>
                <div id="profile-content" class="content-pane">
                     <div class="main-screen-header">
                        <h1>Профиль</h1>
                        <p class="subtitle">Информация о вашем аккаунте</p>
                    </div>
                    <div class="ios-card">
                       <div class="profile-header">
                           <div id="profile-avatar-img" class="profile-avatar"></div>
                           <div class="profile-info">
                               <h2 id="profile-name">Пользователь</h2>
                               <p id="profile-id">ID: Неизвестно</p>
                           </div>
                       </div>
                       <div class="profile-gems"><span>💎 Баланс гемов</span><span id="gem-balance" style="font-weight:700;">Загрузка...</span></div>
                    </div>
                </div>
            </div>
            <nav class="ios-tab-bar">
                <div class="tab-item active" data-tab="home">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>Главная</span>
                </div>
                <div class="tab-item" data-tab="tools">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Инструменты</span>
                </div>
                <div class="tab-item" data-tab="profile">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Профиль</span>
                </div>
            </nav>
        </div>

        <div id="chat-screen" class="screen"> 
            <div class="chat-header fixed-header"> 
                <div id="chat-back-btn" class="chat-header-btn">
                     <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 </div>
                 <div class="chat-title-container">
                    <span id="chat-agent-name">Агент</span>
                    <span id="chat-model-name">Модель</span> </div>
                 <div id="chat-settings-btn" class="chat-header-btn">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .54 1.85v.19a2 2 0 0 1-.54 1.85l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.54-1.85v-.19a2 2 0 0 1 .54 1.85l.15-.1a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                 </div>
            </div>
            <div class="chat-messages" id="chat-messages-container"></div>
            <div id="image-preview-container" class="image-preview-container"></div>
            <div class="chat-input-area"> 
                <input type="file" id="chat-file-input" accept="image/*" style="display: none;">
                <button id="chat-attach-file-btn" title="Прикрепить фото">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                </button>
                <textarea id="chat-prompt-input" placeholder="Сообщение..." rows="1"></textarea>
                <button id="chat-send-message-btn" disabled>Отправить</button> 
            </div>
        </div>

        <div id="image-generator-screen" class="screen">
            <div class="fixed-header">
                <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </div>
                <h1>Генератор изображений ✨</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <input type="text" id="image-prompt-input" placeholder="Введите описание изображения...">
                </div>
                <button id="generate-image-btn" class="feature-submit-btn">Сгенерировать</button>
                <div id="image-loading-indicator" class="loading-indicator" style="display: none;">Генерация изображения...</div>
                <div id="generated-image-container" class="generated-image-container"></div>
                <div id="image-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="summarizer-screen" class="screen">
            <div class="fixed-header">
                 <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 </div>
                <h1>Суммаризатор текста ✨</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <textarea id="summarizer-input" placeholder="Вставьте текст для суммирования..."></textarea>
                </div>
                <button id="summarize-text-btn" class="feature-submit-btn">Суммировать</button>
                <div id="summarizer-loading-indicator" class="loading-indicator" style="display: none;">Обработка текста...</div>
                <div id="summarizer-output" class="summarizer-output" style="display: none;"></div>
                <div id="summarizer-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="settings-modal"> 
            <div class="modal-content">
                <div class="modal-header"><h3>Настройки чата</h3><div class="modal-close-btn" style="cursor: pointer;">✕</div></div>
                <div><label for="agent-select">АГЕНТ</label><select id="agent-select" class="custom-select"></select></div>
                <div style="margin-top: 1rem;"><label for="model-select">МОДЕЛЬ</label><select id="model-select" class="custom-select"></select></div>
            </div>
        </div>
    </div>
    <div id="fullscreen-image-viewer">
        <button class="close-fullscreen-btn">&times;</button>
        <img src="" alt="Просмотр изображения">
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp || {};
    let currentMiniAppChatHistory = []; 
    let lastMessageInfo = { sender: null, date: null }; 
    let agentsSwiper, modelsSwiper;
    let selectedFileBase64 = null; 
    let selectedFileMimeType = null; 

    const API_KEY = "AIzaSyCdDMpgLJyz6aYdwT9q4sbBk7sHVID4BTI"; 
    const APP_BACKEND_URL = "https://nwb-production.up.railway.app"; 

    const logger = {
        info: (message, ...optionalParams) => console.log(`[INFO] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        warn: (message, ...optionalParams) => console.warn(`[WARN] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        error: (message, ...optionalParams) => console.error(`[ERROR] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        debug: (message, ...optionalParams) => console.debug(`[DEBUG] ${new Date().toISOString()}: ${message}`, ...optionalParams),
    };

    const generalAgents = [ 
        { key: "universal_ai_basic", name: "Универсальный", icon: "🌐", desc: "Ответы на любые темы", palette: "palette-grad-1", systemPrompt: "Ты — полезный ИИ-ассистент." }, 
        { key: "idea_generator", name: "Генератор идей", icon: "💡", desc: "Помощь в поиске идей", palette: "palette-grad-2", systemPrompt: "Ты — ИИ, специализирующийся на генерации креативных идей. Помоги пользователю придумать что-то новое." }, 
        { key: "career_coach", name: "Карьерный консультант", icon: "📈", desc: "Советы по карьере", palette: "palette-grad-3", systemPrompt: "Ты — опытный карьерный коуч. Давай конструктивные советы и рекомендации по развитию карьеры." }, 
        { key: "programming_partner", name: "Партнер программиста", icon: "💻", desc: "Помощь в коде", palette: "palette-grad-4", systemPrompt: "Ты — ИИ-ассистент для программистов. Помогай с кодом, объясняй концепции и предлагай решения." }, 
        { key: "tutor_assistant", name: "Внешкольный наставник", icon: "�", desc: "Помощь с учебой", palette: "palette-grad-5", systemPrompt: "Ты — дружелюбный и терпеливый ИИ-репетитор. Помогай пользователю разбираться в учебных материалах." }, 
        { key: "literary_editor", name: "Литературный редактор", icon: "✍️", desc: "Улучшение текстов", palette: "palette-grad-6", systemPrompt: "Ты — ИИ-редактор. Помогай улучшать тексты, исправлять ошибки и делать их более выразительными." }
    ];

    const models = [ 
        { key: "google_gemini_2_0_flash", name: "Gemini 2.0 Flash", icon: "⚡️", desc: "Быстрая и доступная", palette: "palette-grad-default" },
        { key: "google_gemini_2_5_flash_preview", name: "Gemini 2.5 Flash", icon: "👁️‍🗨️", desc: "Быстрый и способный", palette: "palette-grad-1" },
        { key: "custom_api_gemini_2_5_pro", name: "Gemini 2.5 Pro", icon: "🚀", desc: "Продвинутая модель", palette: "palette-grad-2" }, 
        { key: "custom_api_grok_3", name: "Grok 3", icon: "🌀", desc: "Модель Grok", palette: "palette-grad-3" },
        { key: "custom_api_gpt_4o_mini", name: "GPT-4o mini", icon: "🧠", desc: "Компактная GPT-4o", palette: "palette-grad-4" }
    ];
    
    const toolConfigs = {
        "photo_dietitian_analyzer": { 
            key: "photo_dietitian_analyzer", 
            name: "🥑 Диетолог (анализ фото)", 
            icon: "🥑", 
            desc: "Анализ КБЖУ по фото блюда.", 
            forced_model_key: "google_gemini_2_5_flash_preview", 
            systemPrompt: "Ты — Диетолог-Профессионал, эксперт по здоровому питанию, работающий с продвинутой мультимодальной ИИ-моделью, способной анализировать изображения еды. Твоя главная задача — детальный анализ ФОТОГРАФИЙ еды, присланных пользователем, и предоставление развернутых рекомендаций. Твой рабочий процесс СТРОГО следующий: 1. Пользователь присылает ФОТО блюда. 2. Ты получаешь это фото. Твоя задача на этом этапе: ТОЛЬКО вежливо и профессионально попросить пользователя указать ПРИМЕРНЫЙ ВЕС порции в граммах. Не делай никаких предположений о калорийности или составе до получения веса! Пример твоего ответа: 'Прекрасное фото! Чтобы я мог провести точный анализ и рассчитать КБЖУ, пожалуйста, уточните примерный вес этой порции в граммах.' 3. Пользователь присылает ВЕС порции текстом. 4. Теперь, имея ФОТО и ВЕС, ты должен: а) Максимально точно определить все ингредиенты блюда по фото. Если есть сомнения, лучше задать уточняющий вопрос пользователю о составе. б) Учитывая указанный вес, рассчитать примерное количество калорий (Ккал), содержание белков (Б), жиров (Ж) и углеводов (У) для всей порции. в) Представить результат в четком, структурированном виде. Например: 'Анализ вашего блюда (примерный вес: [вес] г): - Блюдо/Продукты: [Детальное перечисление распознанных ингредиентов] - Калорийность: ~[X] Ккал - Белки: ~[Y] г - Жиры: ~[Z] г - Углеводы: ~[W] г Рекомендации: [1-2 кратких, полезных совета по данному блюду/приему пищи, например, о его полезности, возможных заменах, сочетаемости или влиянии на цели пользователя, если они известны].' г) Будь внимателен, дружелюбен и профессионален, как настоящий диетолог. Используй эмодзи уместно для создания приятного впечатления. Если пользователь вместо фото или веса задает ОБЩИЙ текстовый вопрос по диетологии (например, 'польза авокадо'), отвечай на него как эксперт-диетолог, основываясь на своих знаниях, без упоминания анализа фото и запроса веса."
        }
    };

    const appTools = [
        { key: "image_generator_tool", name: "Генератор изображений ✨", icon: "🎨", desc: "Создание картинок по описанию.", screenId: "image-generator-screen" },
        { key: "photo_dietitian_analyzer", name: "Диетолог (анализ фото)", icon: "🥑", desc: "Анализ КБЖУ по фото блюда.", isChatTool: true }, 
        { key: "summarizer_tool", name: "Суммаризатор текста ✨", icon: "📑", desc: "Краткий пересказ длинных статей и видео.", screenId: "summarizer-screen" },
    ];

    let selectedAgentKey = generalAgents[0].key; 
    let selectedModelKey = models[0].key; 

    const mainScreen = document.getElementById('main-screen');
    const chatScreen = document.getElementById('chat-screen');
    const imageGeneratorScreen = document.getElementById('image-generator-screen');
    const summarizerScreen = document.getElementById('summarizer-screen');
    const dietitianAgentCard = document.getElementById('dietitian-agent-card'); 
    const imageGeneratorCard = document.getElementById('image-generator-card');

    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatPromptInput = document.getElementById('chat-prompt-input'); 
    const chatSendMessageBtn = document.getElementById('chat-send-message-btn'); 
    const chatAttachFileBtn = document.getElementById('chat-attach-file-btn');
    const chatFileInput = document.getElementById('chat-file-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    const chatAgentNameEl = document.getElementById('chat-agent-name');
    const chatModelNameEl = document.getElementById('chat-model-name');

    const chatBackButton = document.getElementById('chat-back-btn'); // In-app back button
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const agentSelect = document.getElementById('agent-select'); 
    const modelSelect = document.getElementById('model-select'); 
    const mainContentArea = document.getElementById('main-content-area');

    const imagePromptInputEl = document.getElementById('image-prompt-input'); 
    const generateImageBtn = document.getElementById('generate-image-btn');
    const imageLoadingIndicator = document.getElementById('image-loading-indicator');
    const generatedImageContainer = document.getElementById('generated-image-container');
    const imageErrorMessage = document.getElementById('image-error-message');

    const summarizerInput = document.getElementById('summarizer-input');
    const summarizeTextBtn = document.getElementById('summarize-text-btn');
    const summarizerLoadingIndicator = document.getElementById('summarizer-loading-indicator');
    const summarizerOutput = document.getElementById('summarizer-output');
    const summarizerErrorMessage = document.getElementById('summarizer-error-message');
    
    const fullscreenImageViewer = document.getElementById('fullscreen-image-viewer');
    const fullscreenImage = fullscreenImageViewer.querySelector('img');
    const closeFullscreenBtn = fullscreenImageViewer.querySelector('.close-fullscreen-btn');

    let pollingInterval = null;

    function formatTime(date) { return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }

    function switchScreen(screenToShow) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        screenToShow.classList.add('active');
        if (tg.BackButton) {
            if (screenToShow !== mainScreen) { tg.BackButton.show(); }
            else { tg.BackButton.hide(); }
        }
        if (screenToShow === chatScreen) { startPolling(); chatPromptInput.focus(); } 
        else { stopPolling(); }
    }

    if (tg.BackButton) {
        tg.BackButton.onClick(() => {
            const activeScreenEl = document.querySelector('.screen.active');
            if (!activeScreenEl) return; 
            const activeScreenId = activeScreenEl.id;

            if (activeScreenId === 'chat-screen') {
                closeChat(); 
            } else if (activeScreenId === 'image-generator-screen' || activeScreenId === 'summarizer-screen') {
                switchScreen(mainScreen);
            } else if (activeScreenId !== 'main-screen') {
                switchScreen(mainScreen);
            }
        });
    }

    document.querySelectorAll('.back-btn[data-target-screen]').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetScreenId = btn.dataset.targetScreen;
            const targetScreen = document.getElementById(targetScreenId);
            if (targetScreen) switchScreen(targetScreen);
        });
    });

    function showTab(tabId) {
        document.querySelectorAll('.content-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        const pane = document.getElementById(`${tabId}-content`);
        const tab = document.querySelector(`.tab-item[data-tab="${tabId}"]`);
        if (pane) pane.classList.add('active');
        if (tab) tab.classList.add('active');
        mainContentArea.scrollTop = 0;
        if (tabId === 'profile') { 
            displayProfileData(); 
        }
    }

    function saveChatToLocalStorage() { 
        try { 
            const displayHistory = Array.from(chatMessagesContainer.children)
                .filter(el => el.classList.contains('chat-message') && !el.classList.contains('typing'))
                .map(msgEl => {
                    const sender = msgEl.classList.contains('message-user') ? 'user' : 'bot';
                    const textContent = msgEl.querySelector('.message-content-text')?.textContent || '';
                    const imageEl = msgEl.querySelector('.message-image');
                    const imageDataUrl = imageEl ? imageEl.src : null;
                    let timestamp = msgEl.dataset.timestamp || new Date().toISOString();
                    return { sender, content: { text: textContent, imageDataUrl: imageDataUrl }, timestamp }; 
                });
            setTimeout(() => {
                localStorage.setItem('uiChatHistory_' + selectedAgentKey, JSON.stringify(displayHistory)); 
            },0);
        }
        catch (e) { console.error("Error saving UI chat history:", e); }
    }

    function loadChatFromLocalStorage() { 
        chatMessagesContainer.innerHTML = '';
        lastMessageInfo = { sender: null, date: null };
        currentMiniAppChatHistory = []; 
        try {
            const savedUiHistory = localStorage.getItem('uiChatHistory_' + selectedAgentKey);
            if (savedUiHistory) {
                const parsedUiHistory = JSON.parse(savedUiHistory);
                if (parsedUiHistory.length === 0) return; 

                parsedUiHistory.forEach(msg => {
                    if (msg.content && (msg.content.text || msg.content.imageDataUrl)) {
                        addMessageToChat(msg.sender, msg.content, { 
                            isRestoredFromHistory: true, 
                            timestamp: msg.timestamp 
                        });
                        const historyEntryParts = [];
                        if (msg.content.text) historyEntryParts.push({text: msg.content.text});
                        currentMiniAppChatHistory.push({role: msg.sender === 'user' ? 'user' : 'model', parts: historyEntryParts});
                    }
                });
            }
        } catch (e) {
            console.error("Error loading UI chat history:", e);
        }
    }
    
    function openFullscreenImage(src) {
        fullscreenImage.src = src;
        fullscreenImageViewer.style.display = 'flex';
    }
    closeFullscreenBtn.addEventListener('click', () => {
        fullscreenImageViewer.style.display = 'none';
        fullscreenImage.src = ''; 
    });
    fullscreenImageViewer.addEventListener('click', (e) => { 
        if (e.target === fullscreenImageViewer) {
            fullscreenImageViewer.style.display = 'none';
            fullscreenImage.src = '';
        }
    });

    function addMessageToChat(sender, content, options = {}) {
        const { isTyping = false, isRestoredFromHistory = false, timestamp: msgTimestampStr } = options;
        
        let textContent = '';
        let imageDataUrl = null;

        if (typeof content === 'string') {
            textContent = content;
        } else if (typeof content === 'object' && content !== null) {
            textContent = content.text || '';
            imageDataUrl = content.imageDataUrl || null;
        }

        if (!isTyping && !textContent && !imageDataUrl) {
            return null; 
        }

        const now = msgTimestampStr ? new Date(msgTimestampStr) : new Date(); 
        const currentDate = now.toDateString();

        if (!isTyping && (!lastMessageInfo.date || currentDate !== lastMessageInfo.date)) {
            const divider = document.createElement('div');
            divider.className = 'chat-date-divider';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (currentDate === today) { divider.textContent = 'Сегодня'; }
            else if (currentDate === yesterday) { divider.textContent = 'Вчера'; }
            else { divider.textContent = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }); }
            chatMessagesContainer.appendChild(divider);
        }

        const lastMessageElement = chatMessagesContainer.querySelector('.chat-message:last-of-type');
        if (!isTyping && lastMessageElement && sender === lastMessageInfo.sender && currentDate === lastMessageInfo.date) {
             lastMessageElement.classList.add('no-tail', 'grouped');
             lastMessageElement.classList.remove('tailed');
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message message-${sender} tailed`;
        msgDiv.dataset.timestamp = now.toISOString(); 
        
        if (imageDataUrl) {
            const imgElement = document.createElement('img');
            imgElement.src = imageDataUrl;
            imgElement.alt = "Изображение в чате";
            imgElement.className = 'message-image';
            imgElement.addEventListener('click', () => openFullscreenImage(imageDataUrl));
            msgDiv.appendChild(imgElement);
        }

        if (textContent || isTyping) { 
            const contentSpan = document.createElement('span');
            contentSpan.className = 'message-content-text'; 
            contentSpan.textContent = textContent || (isTyping ? 'Печатает...' : ''); 
            msgDiv.appendChild(contentSpan);
            if (isTyping) { 
                 contentSpan.classList.add('message-content'); 
            }
        }
        
        if (isTyping) {
            msgDiv.classList.add('typing');
        } else {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const timeSpan = document.createElement('span');
            timeSpan.textContent = formatTime(now);
            metaDiv.appendChild(timeSpan);
            msgDiv.appendChild(metaDiv);
        }
        chatMessagesContainer.appendChild(msgDiv);

        if (!isTyping && !isRestoredFromHistory) {
            const historyEntryParts = [];
            if (textContent) historyEntryParts.push({ text: textContent });
            currentMiniAppChatHistory.push({ role: (sender === 'user' ? 'user' : 'model'), parts: historyEntryParts });
            saveChatToLocalStorage(); 
        }
        lastMessageInfo = { sender: sender, date: currentDate };
        chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
        return msgDiv;
    }

    async function submitMessageToBackend(userText, agentKeyForBackend, modelKeyToSubmit, imageBase64, imageMimeType) { 
        let userId = tg.initDataUnsafe?.user?.id;
        if (!userId) {
            addMessageToChat('bot', { text: "Ошибка: ID пользователя Telegram не найден." });
            const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
            if (typingIndicator) typingIndicator.remove();
            return;
        }
        
        const backendProcessUrl = `${APP_BACKEND_URL}/api/process_app_message/${userId}`;
        const payload = { 
            text: userText, 
            agentKey: agentKeyForBackend, 
            modelKey: modelKeyToSubmit 
        };

        if (imageBase64 && imageMimeType) {
            payload.image_base64 = imageBase64;
            payload.image_mime_type = imageMimeType;
        } 

        try {
            const response = await fetch(backendProcessUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) 
            });
            if (!response.ok) {
                let errorText = `Ошибка бэкенда: ${response.status} ${response.statusText}`;
                try {
                    const errorResult = await response.json();
                    errorText = errorResult.message || (errorResult.detail ? JSON.stringify(errorResult.detail) : errorText);
                } catch (e) { /* ignore */ }
                addMessageToChat('bot', { text: errorText });
            } else {
                 const result = await response.json();
                 logger.info("Message submitted to backend successfully:", result);
            }
        } catch (error) {
            addMessageToChat('bot', { text: "Сетевая ошибка при отправке сообщения на бэкенд." });
        } finally {
            const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
            if (typingIndicator) typingIndicator.remove();
        }
    }

    async function handleSendMessage() {
        const text = chatPromptInput.value.trim(); 
        if (!text && !selectedFileBase64) { 
            if (selectedAgentKey === "photo_dietitian_analyzer") { 
                tg.showAlert("Пожалуйста, прикрепите фото или введите текстовый запрос.");
            }
            return;
        }

        let messageContentForChat = { text: text }; 
        if (selectedFileBase64 && selectedFileMimeType) {
            const imageDataUrl = `data:${selectedFileMimeType};base64,${selectedFileBase64}`;
            messageContentForChat.imageDataUrl = imageDataUrl; 
        }
        addMessageToChat('user', messageContentForChat); 
        
        const imageToSend = selectedFileBase64; 
        const mimeTypeToSend = selectedFileMimeType; 

        chatPromptInput.value = ''; 
        autoResizeTextarea.call(chatPromptInput); 
        clearImagePreview(); 
        chatSendMessageBtn.disabled = true; 

        const oldTypingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
        if(oldTypingIndicator) oldTypingIndicator.remove();
        addMessageToChat('bot', { text: 'Печатает...' }, { isTyping: true }); 
        
        let modelKeyForBackend = selectedModelKey; 
        if (selectedAgentKey === "photo_dietitian_analyzer") {
            const dietitianConfig = toolConfigs["photo_dietitian_analyzer"];
            if (dietitianConfig?.forced_model_key) {
                modelKeyForBackend = dietitianConfig.forced_model_key;
            }
        }
        await submitMessageToBackend(text, selectedAgentKey, modelKeyForBackend, imageToSend, mimeTypeToSend);
    }

    function autoResizeTextarea() {
        this.style.height = 'auto'; 
        let newHeight = this.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(this).maxHeight);
        if (newHeight > maxHeight) { newHeight = maxHeight; this.style.overflowY = 'auto';  } 
        else { this.style.overflowY = 'hidden'; }
        this.style.height = newHeight + 'px';
        chatSendMessageBtn.disabled = this.value.trim().length === 0 && !selectedFileBase64; 
    }
    chatPromptInput.addEventListener('input', autoResizeTextarea);

    let isInputRecentlyFocused = false; 
    function hideKeyboardIfFocused() {
        if (document.activeElement === chatPromptInput) { chatPromptInput.blur(); }
    }
    chatPromptInput.addEventListener('focus', () => { isInputRecentlyFocused = true; setTimeout(() => { isInputRecentlyFocused = false; }, 300); });
    chatMessagesContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('message-image')) { return; }
        if (event.target !== chatPromptInput && !chatPromptInput.contains(event.target) && 
            event.target !== chatSendMessageBtn && !chatSendMessageBtn.contains(event.target) && 
            event.target !== chatAttachFileBtn && !chatAttachFileBtn.contains(event.target)) {
            hideKeyboardIfFocused();
        }
    });
    let scrollTimeout;
    chatMessagesContainer.addEventListener('scroll', () => {
        if (isInputRecentlyFocused) { return; }
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => { hideKeyboardIfFocused(); }, 150); 
    });

    chatAttachFileBtn.addEventListener('click', () => { chatFileInput.click(); });
    chatFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFileBase64 = e.target.result.split(',')[1]; 
                selectedFileMimeType = file.type;
                displayImagePreview(e.target.result, file.name);
                chatSendMessageBtn.disabled = false; 
            };
            reader.onerror = () => { tg.showAlert("Не удалось прочитать файл."); clearImagePreview(); };
            reader.readAsDataURL(file);
        } else if (file) { tg.showAlert("Пожалуйста, выберите файл изображения."); clearImagePreview(); }
        chatFileInput.value = ''; 
    });

    function displayImagePreview(imageDataUrl, fileName) {
        imagePreviewContainer.innerHTML = `
            <div class="image-preview-item">
                <img src="${imageDataUrl}" alt="Preview">
                <span>${fileName.length > 20 ? fileName.substring(0, 17) + '...' : fileName}</span>
                <button type="button" class="remove-preview-btn" title="Удалить">&times;</button>
            </div>`;
        imagePreviewContainer.style.display = 'block';
        imagePreviewContainer.querySelector('.remove-preview-btn').addEventListener('click', clearImagePreview);
    }
    function clearImagePreview() {
        selectedFileBase64 = null; selectedFileMimeType = null;
        imagePreviewContainer.innerHTML = ''; imagePreviewContainer.style.display = 'none';
        chatSendMessageBtn.disabled = chatPromptInput.value.trim().length === 0; 
    }

    async function fetchUpdates() {
        let userId = tg.initDataUnsafe?.user?.id;
        if (!userId || !chatScreen.classList.contains('active')) { return; }
        const backendGetUpdatesUrl = `${APP_BACKEND_URL}/api/get_updates/${userId}`;
        try {
            const response = await fetch(backendGetUpdatesUrl);
            if (!response.ok) { return; }
            const data = await response.json();
            if (data?.status === 'ok' && data.messages?.length > 0) {
                const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
                if (typingIndicator) typingIndicator.remove();
                data.messages.forEach(msg => addMessageToChat(msg.sender, { text: msg.text }, { timestamp: msg.timestamp }));
            }
        } catch (error) { /* ignore */ }
    }
    function startPolling() { stopPolling(); fetchUpdates(); pollingInterval = setInterval(fetchUpdates, 3000); }
    function stopPolling() { if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; } }

    function populateCarousel(containerId, items, type) {
        const wrapper = document.getElementById(containerId);
        if (!wrapper) return;
        wrapper.innerHTML = '';
        items.forEach(item => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `<div class="tg-card"><div class="carousel-card ${item.palette || 'palette-grad-default'}"><div class="card-icon">${item.icon}</div><div><h3 class="card-title">${item.name}</h3><p class="card-description">${item.desc}</p></div></div></div>`;
            slide.addEventListener('click', () => {
                if (type === 'agent') { 
                    const agentConfig = generalAgents.find(a => a.key === item.key);
                    if (agentConfig) openChat(agentConfig); 
                } else if (type === 'model') { 
                    selectedModelKey = item.key; 
                    if (chatScreen.classList.contains('active') && !chatScreen.classList.contains('dietitian-chat-active')) {
                         const modelDetails = models.find(m => m.key === selectedModelKey);
                         if (chatModelNameEl) chatModelNameEl.textContent = modelDetails?.name || selectedModelKey;
                         addMessageToChat('bot', {text: `Модель изменена на ${modelDetails?.name || selectedModelKey}.`});
                         modelSelect.value = selectedModelKey;
                    } else { tg.showPopup?.({message: `Модель ${item.name} выбрана.`}); }
                }
            });
            wrapper.appendChild(slide);
        });
    }

    function populateToolsList() {
        const list = document.getElementById('tools-list');
        if (!list) return;
        list.innerHTML = '';
        appTools.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'full-screen-card';
            card.innerHTML = `<div class="icon">${tool.icon}</div><div class="info"><h3>${tool.name}</h3><p>${tool.desc}</p></div>`;
            card.addEventListener('click', () => {
                if (tool.isChatTool) {
                    const toolChatConfig = toolConfigs[tool.key];
                    if (toolChatConfig) openChat(toolChatConfig);
                } else if (tool.screenId) {
                    const targetScreen = document.getElementById(tool.screenId);
                    if (targetScreen) switchScreen(targetScreen);
                } else { tg.showAlert?.(`Инструмент "${tool.name}" не настроен.`); }
            });
            list.appendChild(card);
        });
    }
    
    imageGeneratorCard?.addEventListener('click', () => switchScreen(imageGeneratorScreen));
    dietitianAgentCard?.addEventListener('click', () => {
        const dietitianConfig = toolConfigs["photo_dietitian_analyzer"];
        if (dietitianConfig) openChat(dietitianConfig); 
        else { tg.showAlert?.('Диетолог не настроен.'); }
    });

    async function handleGenerateImage() { /* ... same as before ... */ }
    generateImageBtn?.addEventListener('click', handleGenerateImage);
    imagePromptInputEl?.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleGenerateImage(); });
    async function handleSummarizeText() { /* ... same as before ... */ }
    summarizeTextBtn?.addEventListener('click', handleSummarizeText);

    function displayProfileData() {
        const user = tg.initDataUnsafe?.user;
        const avatarImg = document.getElementById('profile-avatar-img');
        const profileNameEl = document.getElementById('profile-name');
        const profileIdEl = document.getElementById('profile-id');
        const gemBalanceEl = document.getElementById('gem-balance');

        if (user && user.id) {
            if (user.photo_url) {
                avatarImg.style.backgroundImage = `url(${user.photo_url})`;
                avatarImg.innerHTML = ''; 
            } else {
                avatarImg.style.backgroundImage = '';
                avatarImg.style.backgroundColor = '#444'; 
                avatarImg.innerHTML = (user.first_name || 'U').charAt(0).toUpperCase();
            }
            profileNameEl.textContent = `${user.first_name || 'Пользователь'} ${user.last_name || ''}`.trim();
            profileIdEl.textContent = `ID: ${user.id}`;
        } else {
            avatarImg.style.backgroundImage = '';
            avatarImg.style.backgroundColor = '#444';
            avatarImg.innerHTML = '?'; 
            profileNameEl.textContent = 'Нет данных';
            profileIdEl.textContent = 'ID: Н/Д';
        }
        gemBalanceEl.textContent = "0.0"; // Placeholder
    }

    function updateNavArrows(swiperInstance, prefix) { /* ... same as before ... */ }

    function openChat(config) { 
        selectedAgentKey = config.key; 
        if (chatAgentNameEl) chatAgentNameEl.textContent = config.name;
        let modelToDisplay, currentModelForBackend;

        // Explicitly manage visibility of chat header elements based on chat type
        if (config.key === "photo_dietitian_analyzer") { 
            chatScreen.classList.add('dietitian-chat-active'); // Used for attach button visibility
            chatPromptInput.placeholder = "Фото: вес, детали..."; // Shortened placeholder
            currentModelForBackend = config.forced_model_key || models[0].key;
            const dietitianModelDetails = models.find(m => m.key === currentModelForBackend);
            modelToDisplay = dietitianModelDetails?.name || currentModelForBackend;
            
            chatModelNameEl.style.display = 'none';
            chatSettingsBtn.style.display = 'none';
            chatAttachFileBtn.style.display = 'flex'; // Show attach for dietitian
        } else { 
            chatScreen.classList.remove('dietitian-chat-active');
            chatPromptInput.placeholder = "Сообщение...";
            currentModelForBackend = selectedModelKey; 
            const generalAgentModelDetails = models.find(m => m.key === currentModelForBackend);
            modelToDisplay = generalAgentModelDetails?.name || currentModelForBackend;

            chatModelNameEl.style.display = 'block';
            chatSettingsBtn.style.display = 'flex'; // Ensure it's flex for proper centering
            chatAttachFileBtn.style.display = 'none'; // Hide attach for general agents
        }
        if (chatModelNameEl) chatModelNameEl.textContent = modelToDisplay; // This will be hidden for dietitian by style.display
        
        agentSelect.value = selectedAgentKey; 
        modelSelect.value = currentModelForBackend; 

        clearImagePreview();
        loadChatFromLocalStorage(); 

        if (chatMessagesContainer.children.length === 0) { 
            let welcomeMessageText = `Привет! Я ${config.name}. Чем могу помочь?`;
            if (config.key === "photo_dietitian_analyzer") {
                welcomeMessageText = `Привет! Я ${config.name}. Прикрепите фото блюда и укажите примерный вес порции для анализа КБЖУ.`;
            }
            if (welcomeMessageText) {
                addMessageToChat('bot', { text: welcomeMessageText });
            }
        }
        switchScreen(chatScreen);
    }

    function closeChat() { 
        stopPolling();
        // No need to remove dietitian-chat-active here, openChat will set it correctly.
        clearImagePreview();
        switchScreen(mainScreen); 
     }
    function openSettingsModal() { 
        // This modal is only for general agent chats.
        // Ensure agentSelect reflects the current general agent and modelSelect the global model.
        if (!chatScreen.classList.contains('dietitian-chat-active')) {
            agentSelect.value = selectedAgentKey; 
            modelSelect.value = selectedModelKey;
            settingsModal.style.display = 'flex';
        }
    }
    function closeSettingsModal() { settingsModal.style.display = 'none'; }
    function viewportChangedHandler() { /* ... same as before ... */ }

    function init() {
        if (tg.ready) tg.ready();
        if (tg.expand) tg.expand(); 
        if (tg.MainButton) tg.MainButton.hide();
        if (tg.onEvent) tg.onEvent('viewportChanged', viewportChangedHandler);
        setTimeout(viewportChangedHandler, 200); 

        populateCarousel('agents-swiper-wrapper', generalAgents, 'agent'); 
        populateCarousel('models-swiper-wrapper', models, 'model');
        
        agentsSwiper = new Swiper("#agents-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'agents') }, slideChange(s){ updateNavArrows(s, 'agents') } }});
        modelsSwiper = new Swiper("#models-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'models') }, slideChange(s){ updateNavArrows(s, 'models') } }});
        document.getElementById('agents-nav-prev')?.addEventListener('click', () => agentsSwiper?.slidePrev());
        document.getElementById('agents-nav-next')?.addEventListener('click', () => agentsSwiper?.slideNext());
        document.getElementById('models-nav-prev')?.addEventListener('click', () => modelsSwiper?.slidePrev());
        document.getElementById('models-nav-next')?.addEventListener('click', () => modelsSwiper?.slideNext());

        populateToolsList(); 
        displayProfileData(); 

        agentSelect.innerHTML = ''; 
        generalAgents.forEach(a => { 
            const icon = a.icon || "👤";
            agentSelect.appendChild(new Option(`${icon} ${a.name}`, a.key));
        });
        modelSelect.innerHTML = ''; 
        models.forEach(m => modelSelect.appendChild(new Option(m.name, m.key))); 

        document.querySelectorAll('.tab-item').forEach(tab => tab.addEventListener('click', () => showTab(tab.dataset.tab)));
        
        chatSendMessageBtn.addEventListener('click', handleSendMessage);
        chatPromptInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey && !chatSendMessageBtn.disabled) { 
                e.preventDefault(); handleSendMessage(); 
            } 
        });

        chatBackButton?.addEventListener('click', closeChat); // This is the in-app back button
        chatSettingsBtn?.addEventListener('click', openSettingsModal); 
        document.querySelector('.modal-close-btn')?.addEventListener('click', closeSettingsModal);
        settingsModal?.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

        agentSelect.addEventListener('change', (e) => {
            const newAgentKey = e.target.value;
            const agentConfig = generalAgents.find(a => a.key === newAgentKey); 
            if (agentConfig) { 
                selectedAgentKey = newAgentKey; 
                if (chatAgentNameEl) chatAgentNameEl.textContent = agentConfig.name;
                const modelDetails = models.find(m => m.key === selectedModelKey); // Use current global selectedModelKey
                if (chatModelNameEl) chatModelNameEl.textContent = modelDetails?.name || selectedModelKey; 
                modelSelect.value = selectedModelKey; 
                
                // Ensure chat is configured as general agent chat
                chatScreen.classList.remove('dietitian-chat-active'); 
                chatPromptInput.placeholder = "Сообщение...";
                chatModelNameEl.style.display = 'block';
                chatSettingsBtn.style.display = 'flex';
                chatAttachFileBtn.style.display = 'none';

                clearImagePreview();
                loadChatFromLocalStorage(); 
                if (chatMessagesContainer.children.length === 0) {
                    addMessageToChat('bot', { text: `Агент изменен на ${agentConfig.name}. Чем могу помочь?` });
                }
            }
        });
        
        modelSelect.addEventListener('change', (e) => { 
            selectedModelKey = e.target.value; 
            const modelDetails = models.find(m => m.key === selectedModelKey);
            if (chatModelNameEl) chatModelNameEl.textContent = modelDetails?.name || selectedModelKey; 
            if (chatScreen.classList.contains('active') && !chatScreen.classList.contains('dietitian-chat-active')) {
                addMessageToChat('bot', { text: `Модель изменена на ${modelDetails?.name || selectedModelKey}.`});
            }
        });

        autoResizeTextarea.call(chatPromptInput); 
        showTab('home');
        if (tg.BackButton) tg.BackButton.hide();

        const initialAgentDisplay = generalAgents.find(a => a.key === selectedAgentKey);
        const initialModelDisplay = models.find(m => m.key === selectedModelKey);
        if (initialAgentDisplay && chatAgentNameEl) chatAgentNameEl.textContent = initialAgentDisplay.name;
        if (initialModelDisplay && chatModelNameEl) chatModelNameEl.textContent = initialModelDisplay.name;
    }
    init();
});
</script>
</body>
</html>
