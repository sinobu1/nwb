<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
    <title>AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <style>
        :root {
            --bg-main: #101010;
            --bg-card: #1E1E1E;
            --bg-select: #2C2C2E;
            --bg-user-msg: #3E3E42;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --border-color: #3A3A3C;
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
            --gold-highlight: #d8ab4e;
            --success-green: #4CAF50;
            --error-red: #F44336;
        }
        html, body {
            position: fixed;
            inset: 0;
            overflow: hidden;
            font-family: var(--font-family);
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            overscroll-behavior-y: contain;
            margin: 0;
            padding: 0;
        }
        .app-wrapper {
            width: 100%;
            max-width: 450px; /* Max width for the app */
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color); /* Optional border for app frame */
            border-right: 1px solid var(--border-color); /* Optional border for app frame */
        }
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out;
            background-color: var(--bg-main);
            z-index: 10;
            will-change: opacity, visibility;
        }
        .screen.active { z-index: 20; opacity: 1; visibility: visible; }
        .screen:not(.active) { opacity: 0; visibility: hidden; pointer-events: none; }

        #main-screen, #image-generator-screen, #summarizer-screen { flex-grow: 1; }
        #main-content-area, .feature-content-area { /* Common class for content areas */
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
         .fixed-header {
            padding: 0.75rem 1rem;
            background: rgba(20,20,20,0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center; /* Vertically center items */
            gap: 0.5rem; /* Space between back button and title */
            border-bottom: 1px solid var(--border-color);
            z-index: 25; /* Above screen content */
            color: var(--text-primary);
            position: sticky; /* Make header sticky for feature screens */
            top: 0;
        }
        .fixed-header h1 { font-size: 1.25rem; font-weight: 600; margin: 0; flex-grow: 1; text-align: center; }
        .fixed-header .back-btn {
            color: var(--gold-highlight);
            cursor: pointer;
            padding: 0.25rem; /* Clickable area */
        }
         .main-screen-header { /* Specific for main screen's non-sticky header */
            padding: 1rem 1rem 0.5rem 1rem;
            background-color: var(--bg-main);
        }
        .main-screen-header h1 { font-size: 1.875rem; font-weight: 800; margin-bottom: 0.25rem; }
        .main-screen-header p.subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; }


        .content-pane { display: none; }
        .content-pane.active { display: block; }

        h2 { font-size: 1.25rem; font-weight: 700; }


        .swiper-container-wrapper { margin-top: 1.5rem; }
        .swiper-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0 0.25rem; }
        .swiper-nav-arrows { display: flex; gap: 0.5rem; }
        .swiper-nav-arrow { width: 32px; height: 32px; background-color: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 0.2s, transform 0.1s; color: var(--text-secondary); }
        .swiper-nav-arrow:hover { color: var(--text-primary); }
        .swiper-nav-arrow:active { transform: scale(0.9); }
        .swiper-nav-arrow.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .swiper-slide { width: 180px; height: 120px; cursor: pointer; }
        .tg-card { border-radius: 16px; overflow: hidden; height: 100%; }
        .carousel-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 0.75rem; text-align: left; }
        .card-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .card-title { font-size: 0.9rem; font-weight: 600; color: #FFFFFF; }
        .card-description { font-size: 0.75rem; color: #FFFFFF; opacity: 0.80; margin-top: 0.1rem; line-height: 1.2; }

        .palette-1 { background: linear-gradient(45deg, #FF416C, #FF4B2B); }
        .palette-2 { background: linear-gradient(45deg, #12C2E9, #C471ED, #F64F59); }
        .palette-3 { background: linear-gradient(45deg, #00C9FF, #92FE9D); }
        .palette-4 { background: linear-gradient(45deg, #FAD961, #F76B1C); }
        .palette-5 { background: linear-gradient(45deg, #4A00E0, #8E2DE2); }
        .palette-6 { background-color: #2D2D2D; }

        .full-screen-card-list { display: grid; gap: 0.75rem; margin-top: 1rem; }
        .full-screen-card { background-color: var(--bg-card); border-radius: 16px; padding: 1rem; display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: transform 0.1s; }
        .full-screen-card:active { transform: scale(0.98); }
        .full-screen-card .icon { font-size: 1.75rem; }
        .full-screen-card .info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.1rem;}
        .full-screen-card .info p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.3;}

        .ios-tab-bar { flex-shrink: 0; max-width: 400px; width: calc(100% - 2rem); margin: 0 auto 1rem auto; display: flex; background: rgba(28,28,30,0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 0.4rem; border: 1px solid rgba(255,255,255,0.08); z-index: 100; }
        .tab-item { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; padding: 0.25rem 0; }
        .tab-item.active { color: var(--gold-highlight); }
        .tab-item svg { width: 26px; height: 26px; margin-bottom: 1px; }
        .tab-item span { font-size: 0.6rem; font-weight: 500; }

        .ios-card { background-color: var(--bg-card); border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
        .profile-header { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .profile-avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 1rem; background-color: #333; background-size: cover; background-position: center; }
        .profile-info h2 { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.2rem 0;}
        .profile-info p { font-size: 0.85rem; color: var(--text-secondary); margin:0;}
        .profile-gems { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; font-size: 0.9rem;}

        .chat-header { flex-shrink: 0; padding: 0.75rem 1rem; background: rgba(20,20,20,0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 20; }
        .chat-header .title { font-weight: 600; font-size: 1.125rem; text-align: center; flex-grow: 1; color: var(--text-primary); margin-left: 38px; }
        .chat-header-btn { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; color: var(--text-secondary); }
        .chat-header-btn#chat-back-btn { color: var(--gold-highlight); }
        .chat-header-btn:hover { background-color: var(--bg-card); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; -webkit-overflow-scrolling: touch; }
        .chat-message { padding: 0.5rem 0.9rem; border-radius: 1.1rem; max-width: 85%; word-wrap: break-word; line-height: 1.4; opacity: 0; transform: translateY(10px); animation: pop-in 0.3s ease forwards; margin-top: 0.65rem; will-change: transform, opacity; font-size: 0.9rem; }
        @keyframes pop-in { to { opacity: 1; transform: translateY(0); } }
        .message-bot { background-color: var(--bg-card); align-self: flex-start; color: var(--text-primary); }
        .message-user { background-color: var(--bg-user-msg); align-self: flex-end; color: var(--text-primary); }
        .message-bot.tailed { border-bottom-left-radius: 0.25rem; }
        .message-user.tailed { border-bottom-right-radius: 0.25rem; }
        .chat-message.grouped { margin-top: 0.25rem; }
        .chat-message.no-tail { border-bottom-left-radius: 1.1rem; border-bottom-right-radius: 1.1rem; }
        .message-bot.typing { color: var(--text-secondary); font-style: italic; }
        .typing .message-content::after { content: '.'; animation: dots 1.2s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: '...'; } }
        .message-meta { display: flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; color: var(--text-secondary); float: right; margin-left: 0.5rem; margin-top: 0.2rem; line-height: 1; user-select: none; }
        .chat-date-divider { text-align: center; margin: 1rem auto; background-color: rgba(44, 44, 46, 0.8); color: var(--text-primary); font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.6rem; border-radius: 1rem; width: fit-content; }

        .chat-input-area { flex-shrink: 0; padding: 0.4rem 0.6rem; border-top: 1px solid var(--border-color); background-color: var(--bg-main); display: flex; align-items: flex-end; gap: 0.4rem; }
        .chat-input-wrapper { flex-grow: 1; position: relative; }
        #chat-input { width: 100%; background-color: var(--bg-card); border-radius: 18px; padding: 0.5rem 0.9rem; border: none; color: var(--text-primary); font-size: 0.9rem; resize: none; line-height: 1.3; min-height: calc(0.5rem * 2 + 1.3em); max-height: 100px; overflow-y: auto; }
        #chat-input:focus { outline: none; box-shadow: 0 0 0 1.5px var(--gold-highlight); }
        #send-btn { width: 36px; height: 36px; background-color: var(--gold-highlight); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: opacity 0.2s, transform 0.15s ease; }
        #send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1); }
        #send-btn:not(:disabled):active { transform: scale(0.92); }
        #send-btn svg { width: 18px; height: 18px; }
        #attach-btn { width: 36px; height: 36px; }
        #attach-btn svg { width: 20px; height: 20px; }

        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card); padding: 1.5rem; border-radius: 1rem; width: calc(100% - 2rem); max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .custom-select { width: 100%; background-color: var(--bg-select); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 1rem; margin-top: 0.5rem;}
        .save-to-bot-btn { margin-left: 6px; padding: 1px 5px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-card); color: var(--text-secondary); cursor: pointer; font-size: 0.65rem; }
        .save-to-bot-btn:hover { background-color: var(--bg-select); color: var(--text-primary); }
        .save-to-bot-btn:disabled { cursor: default; opacity: 0.6; }

        /* Styles for Image Generator and Summarizer Screens */
        .feature-input-area { margin-bottom: 1rem; }
        .feature-input-area textarea, .feature-input-area input[type="text"] {
            width: 100%;
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 44px;
        }
        .feature-input-area textarea { min-height: 100px; }
        .feature-submit-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }
        .feature-submit-btn:hover { background-color: #c89a3e; }
        .feature-submit-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }
        .generated-image-container { margin-top: 1rem; text-align: center; }
        .generated-image-container img { max-width: 100%; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-card); }
        .summarizer-output { margin-top: 1rem; padding: 1rem; background-color: var(--bg-card); border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-primary); font-size: 0.9rem; }
        .error-message { color: var(--error-red); text-align: center; margin-top: 1rem; }

    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="main-screen" class="screen active">
            <div id="main-content-area">
                <div id="home-content" class="content-pane active">
                    <div class="main-screen-header">
                        <h1>–ì–ª–∞–≤–Ω–∞—è</h1>
                        <p class="subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
                    </div>
                    <div class="full-screen-card" id="image-generator-card">
                        <div class="icon" style="font-size: 2rem;">üé®</div>
                        <div class="info"><h3>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚ú®</h3><p>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é.</p></div>
                    </div>
                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>–ê–≥–µ–Ω—Ç—ã</h2><div class="swiper-nav-arrows"><div id="agents-nav-prev" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="agents-nav-next" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="agents-swiper"><div class="swiper-wrapper" id="agents-swiper-wrapper"></div></div>
                    </div>
                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>–ú–æ–¥–µ–ª–∏</h2><div class="swiper-nav-arrows"><div id="models-nav-prev" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="models-nav-next" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="models-swiper"><div class="swiper-wrapper" id="models-swiper-wrapper"></div></div>
                    </div>
                </div>
                <div id="tools-content" class="content-pane">
                    <div class="main-screen-header">
                        <h1>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h1>
                        <p class="subtitle">–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –±–∞–∑–µ –ò–ò</p>
                    </div>
                    <div id="tools-list" class="full-screen-card-list"></div>
                </div>
                <div id="profile-content" class="content-pane">
                     <div class="main-screen-header">
                        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
                        <p class="subtitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ</p>
                    </div>
                    <div class="ios-card">
                       <div class="profile-header">
                           <div id="profile-avatar-img" class="profile-avatar"></div>
                           <div class="profile-info">
                               <h2 id="profile-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                               <p id="profile-id">ID: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</p>
                           </div>
                       </div>
                       <div class="profile-gems"><span>üíé –ë–∞–ª–∞–Ω—Å –≥–µ–º–æ–≤</span><span id="gem-balance" style="font-weight:700;">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span></div>
                    </div>
                </div>
            </div>
            <nav class="ios-tab-bar">
                <div class="tab-item active" data-tab="home"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 3H4a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1zm0 11H4a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1zm11-11h-6a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1zm-1 12h-6a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1z"/></svg><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
                <div class="tab-item" data-tab="tools"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83L19.5 9.5l1.21-2.46zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg><span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span></div>
                <div class="tab-item" data-tab="profile"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1c-1.29 1.92-3.5 3.2-6 3.2zM12 5a3 3 0 110 6 3 3 0 010-6zm0-3a10 10 0 100 20 10 10 0 000-20z"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
            </nav>
        </div>

        <div id="chat-screen" class="screen">
            <div class="chat-header">
                 <div id="chat-back-btn" class="chat-header-btn">
                     <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 </div>
                 <div id="chat-title" class="title">–ß–∞—Ç</div>
                 <div id="chat-settings-btn" class="chat-header-btn"> <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12-.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17-.47.41l.36 2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.21.08-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                 </div>
            </div>
            <div class="chat-messages" id="chat-messages-container"></div>
            <div class="chat-input-area">
                <div id="attach-btn" class="chat-action-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </div>
                <div class="chat-input-wrapper">
                    <textarea id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                </div>
                <button id="send-btn" class="chat-action-btn" disabled> <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3.49999 20.5C4.33332 21.3333 5.66666 21.1667 6.33332 20.5L21.3333 13C22.1667 12.5 22.1667 11.5 21.3333 11L6.33332 3.5C5.66666 2.83333 4.33332 2.66667 3.49999 3.5C2.66666 4.33333 2.83332 5.66667 3.49999 6.33333L16.1667 12L3.49999 17.6667C2.83332 18.3333 2.66666 19.6667 3.49999 20.5Z"/></svg>
                </button>
            </div>
        </div>

        <div id="image-generator-screen" class="screen">
            <div class="fixed-header">
                <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </div>
                <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚ú®</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <input type="text" id="image-prompt-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...">
                </div>
                <button id="generate-image-btn" class="feature-submit-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <div id="image-loading-indicator" class="loading-indicator" style="display: none;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</div>
                <div id="generated-image-container" class="generated-image-container"></div>
                <div id="image-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="summarizer-screen" class="screen">
            <div class="fixed-header">
                 <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </div>
                <h1>–°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ ‚ú®</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <textarea id="summarizer-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
                </div>
                <button id="summarize-text-btn" class="feature-submit-btn">–°—É–º–º–∏—Ä–æ–≤–∞—Ç—å</button>
                <div id="summarizer-loading-indicator" class="loading-indicator" style="display: none;">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞...</div>
                <div id="summarizer-output" class="summarizer-output" style="display: none;"></div>
                <div id="summarizer-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>


        <div id="settings-modal"> <div class="modal-content">
                <div class="modal-header"><h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3><div class="modal-close-btn" style="cursor: pointer;">‚úï</div></div>
                <div><label for="agent-select">–ê–ì–ï–ù–¢</label><select id="agent-select" class="custom-select"></select></div>
                <div style="margin-top: 1rem;"><label for="model-select">–ú–û–î–ï–õ–¨</label><select id="model-select" class="custom-select"></select></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp || {};
    let currentMiniAppChatHistory = [];
    let lastMessageInfo = { sender: null, date: null };
    let agentsSwiper, modelsSwiper;

    const API_KEY = ""; // IMPORTANT: Leave empty for Canvas to inject.

    const agents = [ { key: "universal_ai_basic", name: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª", icon: "üåç", desc: "–û—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã", palette: "palette-5", systemPrompt: "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç." }, { key: "idea_generator", name: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π", icon: "üí°", desc: "–ü–æ–º–æ—â—å –≤ –ø–æ–∏—Å–∫–µ –∏–¥–µ–π", palette: "palette-4", systemPrompt: "–¢—ã ‚Äî –ò–ò, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –∏–¥–µ–π. –ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–¥—É–º–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ." }, { key: "career_coach", name: "–ö–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ—É—á", icon: "üìà", desc: "–°–æ–≤–µ—Ç—ã –ø–æ –∫–∞—Ä—å–µ—Ä–µ", palette: "palette-3", systemPrompt: "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ—É—á. –î–∞–≤–∞–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –∫–∞—Ä—å–µ—Ä—ã." }, { key: "programming_partner", name: "–ü–∞—Ä—Ç–Ω–µ—Ä-–ø—Ä–æ–≥–µ—Ä", icon: "üíª", desc: "–ü–æ–º–æ—â—å –≤ –∫–æ–¥–µ", palette: "palette-2", systemPrompt: "–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤. –ü–æ–º–æ–≥–∞–π —Å –∫–æ–¥–æ–º, –æ–±—ä—è—Å–Ω—è–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏—è." }, { key: "tutor_assistant", name: "–†–µ–ø–µ—Ç–∏—Ç–æ—Ä", icon: "üìö", desc: "–ü–æ–º–æ—â—å —Å —É—á–µ–±–æ–π", palette: "palette-1", systemPrompt: "–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π –ò–ò-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä. –ü–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —É—á–µ–±–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö." }, { key: "literary_editor", name: "–†–µ–¥–∞–∫—Ç–æ—Ä", icon: "‚úçÔ∏è", desc: "–£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤", palette: "palette-6", systemPrompt: "–¢—ã ‚Äî –ò–ò-—Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü–æ–º–æ–≥–∞–π —É–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç—ã, –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏ –∏ –¥–µ–ª–∞—Ç—å –∏—Ö –±–æ–ª–µ–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–º–∏." } ];
    const models = [ { key: "gemini-2.0-flash", name: "Gemini Flash", icon: "‚ö°Ô∏è", desc: "–ë—ã—Å—Ç—Ä–∞—è –∏ –¥–æ—Å—Ç—É–ø–Ω–∞—è", palette: "palette-6" } ]; // Simplified to one reliable model for text
    const tools = [
        { key: "summarizer", name: "–°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ ‚ú®", icon: "üìë", desc: "–ö—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –∏ –≤–∏–¥–µ–æ." },
        { key: "text_analyzer", name: "–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞", icon: "üîç", desc: "–ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤." },
        { key: "translator_pro", name: "–ü—Ä–æ-–ø–µ—Ä–µ–≤–æ–¥—á–∏–∫", icon: "üåê", desc: "–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ä–µ—á–∏." }
    ];

    let selectedAgentKey = agents[0].key;
    let selectedModelKey = models[0].key; // Default to Gemini Flash

    const mainScreen = document.getElementById('main-screen');
    const chatScreen = document.getElementById('chat-screen');
    const imageGeneratorScreen = document.getElementById('image-generator-screen');
    const summarizerScreen = document.getElementById('summarizer-screen');

    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const attachBtn = document.getElementById('attach-btn');
    const chatTitle = document.getElementById('chat-title');
    const chatBackButton = document.getElementById('chat-back-btn');
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const agentSelect = document.getElementById('agent-select');
    const modelSelect = document.getElementById('model-select');
    const mainContentArea = document.getElementById('main-content-area');

    // Image Generator Elements
    const imageGeneratorCard = document.getElementById('image-generator-card');
    const imagePromptInput = document.getElementById('image-prompt-input');
    const generateImageBtn = document.getElementById('generate-image-btn');
    const imageLoadingIndicator = document.getElementById('image-loading-indicator');
    const generatedImageContainer = document.getElementById('generated-image-container');
    const imageErrorMessage = document.getElementById('image-error-message');

    // Summarizer Elements
    // Note: Summarizer card click is handled in populateToolsList
    const summarizerInput = document.getElementById('summarizer-input');
    const summarizeTextBtn = document.getElementById('summarize-text-btn');
    const summarizerLoadingIndicator = document.getElementById('summarizer-loading-indicator');
    const summarizerOutput = document.getElementById('summarizer-output');
    const summarizerErrorMessage = document.getElementById('summarizer-error-message');


    function formatTime(date) { return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }

    function switchScreen(screenToShow) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        screenToShow.classList.add('active');
        if (tg.BackButton) {
            // Show back button only if not on main screen
            if (screenToShow !== mainScreen) {
                tg.BackButton.show();
            } else {
                tg.BackButton.hide();
            }
        }
    }
    // Global back button handler for Telegram
    if (tg.BackButton) {
        tg.BackButton.onClick(() => {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen && activeScreen.id !== 'main-screen') {
                switchScreen(mainScreen); // Default back action
            }
        });
    }
    // Specific back buttons within feature screens
    document.querySelectorAll('.back-btn[data-target-screen]').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetScreenId = btn.dataset.targetScreen;
            const targetScreen = document.getElementById(targetScreenId);
            if (targetScreen) switchScreen(targetScreen);
        });
    });


    function showTab(tabId) {
        document.querySelectorAll('.content-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        const pane = document.getElementById(`${tabId}-content`);
        const tab = document.querySelector(`.tab-item[data-tab="${tabId}"]`);
        if (pane) pane.classList.add('active');
        if (tab) tab.classList.add('active');
        mainContentArea.scrollTop = 0;
    }

    function saveChatToLocalStorage() {
        try { localStorage.setItem('miniAppChatHistory_' + selectedAgentKey, JSON.stringify(currentMiniAppChatHistory)); }
        catch (e) { console.error("Error saving chat to localStorage:", e); }
    }

    function loadChatFromLocalStorage() {
        try {
            const savedHistory = localStorage.getItem('miniAppChatHistory_' + selectedAgentKey);
            chatMessagesContainer.innerHTML = '';
            lastMessageInfo = { sender: null, date: null };
            currentMiniAppChatHistory = [];
            if (savedHistory) {
                const parsedHistory = JSON.parse(savedHistory);
                parsedHistory.forEach(msg => addMessageToChat(msg.sender, msg.text, { isRestoredFromHistory: true, timestamp: msg.timestamp }));
            }
        } catch (e) { console.error("Error loading chat from localStorage:", e); currentMiniAppChatHistory = []; }
    }

    function addMessageToChat(sender, text, options = {}) {
        const { isTyping = false, isRestoredFromHistory = false, timestamp: msgTimestamp } = options;
        const now = msgTimestamp ? new Date(msgTimestamp) : new Date();
        const currentDate = now.toDateString();

        if (!isTyping && (!lastMessageInfo.date || currentDate !== lastMessageInfo.date)) {
            const divider = document.createElement('div');
            divider.className = 'chat-date-divider';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (currentDate === today) { divider.textContent = '–°–µ–≥–æ–¥–Ω—è'; }
            else if (currentDate === yesterday) { divider.textContent = '–í—á–µ—Ä–∞'; }
            else { divider.textContent = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }); }
            chatMessagesContainer.appendChild(divider);
        }

        const lastMessageElement = chatMessagesContainer.querySelector('.chat-message:last-of-type');
        if (!isTyping && lastMessageElement && sender === lastMessageInfo.sender && currentDate === lastMessageInfo.date) {
             lastMessageElement.classList.add('no-tail', 'grouped');
             lastMessageElement.classList.remove('tailed');
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message message-${sender} tailed`;
        const contentSpan = document.createElement('span');
        contentSpan.className = 'message-content';
        contentSpan.textContent = text;
        msgDiv.appendChild(contentSpan);

        if (isTyping) {
            msgDiv.classList.add('typing');
        } else {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const timeSpan = document.createElement('span');
            timeSpan.textContent = formatTime(now);
            metaDiv.appendChild(timeSpan);
            msgDiv.appendChild(metaDiv);

            if (sender === 'bot' && !isRestoredFromHistory && tg.sendData) {
                const saveButton = document.createElement('button');
                saveButton.innerHTML = 'üíæ';
                saveButton.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç';
                saveButton.className = 'save-to-bot-btn';
                saveButton.onclick = () => {
                    let userQueryText = "–ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    const allMessages = Array.from(chatMessagesContainer.querySelectorAll('.chat-message'));
                    const botMsgIndex = allMessages.findIndex(el => el === msgDiv);
                    if (botMsgIndex > 0 && allMessages[botMsgIndex - 1].classList.contains('message-user')) {
                        userQueryText = allMessages[botMsgIndex - 1].querySelector('.message-content').textContent;
                    }
                    tg.sendData(JSON.stringify({ action: 'save_chat_to_telegram', payload: { user_query: userQueryText, ai_response: text } }));
                    saveButton.textContent = '‚úÖ';
                    saveButton.disabled = true;
                    if (tg.showAlert) tg.showAlert('–î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —Å –±–æ—Ç–æ–º!');
                };
                metaDiv.appendChild(saveButton);
            }
        }
        chatMessagesContainer.appendChild(msgDiv);
        if (!isTyping && !isRestoredFromHistory) {
            // Add to current session history for API context
            const role = sender === 'user' ? 'user' : 'model';
            currentMiniAppChatHistory.push({ role: role, parts: [{ text: text }] });
            saveChatToLocalStorage(); // This saves the display history, not API history
        }
        lastMessageInfo = { sender: sender, date: currentDate };
        requestAnimationFrame(() => chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' }));
        return msgDiv;
    }

    async function callGeminiChatAPI(promptText, agentKey) {
        const agentConfig = agents.find(a => a.key === agentKey) || agents[0];
        let historyForAPI = [];

        if (agentConfig.systemPrompt) {
            historyForAPI.push({ role: "user", parts: [{ text: agentConfig.systemPrompt }] });
            historyForAPI.push({ role: "model", parts: [{ text: "–ü–æ–Ω—è–ª. –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å." }] });
        }
        // Add recent chat history, excluding the system prompt part if it was just added
        const relevantChatHistory = currentMiniAppChatHistory.slice(agentConfig.systemPrompt ? 2 : 0);
        historyForAPI = historyForAPI.concat(relevantChatHistory);


        // The last user message is already part of `historyForAPI` if added via addMessageToChat
        // So, we don't need to add `promptText` separately if it's the last item.
        // Ensure the last item is the user's current prompt if not already there.
        if (historyForAPI.length === 0 || historyForAPI[historyForAPI.length - 1].parts[0].text !== promptText) {
             historyForAPI.push({ role: "user", parts: [{ text: promptText }] });
        }


        const payload = { contents: historyForAPI };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModelKey}:generateContent?key=${API_KEY}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else if (result.error) {
                console.error("Gemini API Error:", result.error);
                return `–û—à–∏–±–∫–∞ API: ${result.error.message}`;
            } else {
                console.error("Unexpected Gemini API response structure:", result);
                return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            return "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.";
        }
    }


    async function handleSendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        addMessageToChat('user', text); // Adds to UI and historyForAPI via currentMiniAppChatHistory
        chatInput.value = '';
        handleInputStyling.call(chatInput);

        const oldTypingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
        if(oldTypingIndicator) oldTypingIndicator.remove();
        addMessageToChat('bot', '–ü–µ—á–∞—Ç–∞–µ—Ç...', { isTyping: true });

        const botResponseText = await callGeminiChatAPI(text, selectedAgentKey);

        const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
        if (typingIndicator) typingIndicator.remove();
        addMessageToChat('bot', botResponseText);
    }


    function handleInputStyling() {
        this.style.height = 'auto';
        this.style.height = `${Math.max(this.scrollHeight, parseFloat(getComputedStyle(this).minHeight))}px`;
        sendBtn.disabled = this.value.trim().length === 0;
    }

    function populateCarousel(containerId, items, type) {
        const wrapper = document.getElementById(containerId);
        if (!wrapper) return;
        wrapper.innerHTML = '';
        items.forEach(item => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `<div class="tg-card"><div class="carousel-card ${item.palette}"><div class="card-icon">${item.icon}</div><div><h3 class="card-title">${item.name}</h3><p class="card-description">${item.desc}</p></div></div></div>`;
            slide.addEventListener('click', () => {
                if (type === 'agent') selectedAgentKey = item.key;
                else if (type === 'model') selectedModelKey = item.key; // This might be removed if only one model
                const agentForChat = agents.find(a => a.key === (type === 'agent' ? item.key : selectedAgentKey));
                openChat(agentForChat);
            });
            wrapper.appendChild(slide);
        });
    }

    function populateToolsList() {
        const list = document.getElementById('tools-list');
        if (!list) return;
        list.innerHTML = '';
        tools.forEach(item => {
            const card = document.createElement('div');
            card.className = 'full-screen-card';
            card.innerHTML = `<div class="icon">${item.icon}</div><div class="info"><h3>${item.name}</h3><p>${item.desc}</p></div>`;
            card.addEventListener('click', () => {
                if (item.key === "summarizer") {
                    switchScreen(summarizerScreen);
                } else {
                    if (tg.showAlert) tg.showAlert(`–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${item.name}" –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.`);
                }
            });
            list.appendChild(card);
        });
    }

    imageGeneratorCard?.addEventListener('click', () => {
        switchScreen(imageGeneratorScreen);
    });

    async function handleGenerateImage() {
        const prompt = imagePromptInput.value.trim();
        if (!prompt) {
            imageErrorMessage.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.";
            imageErrorMessage.style.display = 'block';
            generatedImageContainer.innerHTML = '';
            return;
        }
        imageErrorMessage.style.display = 'none';
        imageLoadingIndicator.style.display = 'block';
        generateImageBtn.disabled = true;
        generatedImageContainer.innerHTML = '';

        const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1} };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.alt = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: " + prompt.substring(0, 50);
                generatedImageContainer.appendChild(imgElement);
            } else if (result.error) {
                 console.error("Imagen API Error:", result.error);
                imageErrorMessage.textContent = `–û—à–∏–±–∫–∞ API: ${result.error.message}`;
                imageErrorMessage.style.display = 'block';
            }
            else {
                imageErrorMessage.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.";
                imageErrorMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("Error calling Imagen API:", error);
            imageErrorMessage.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.";
            imageErrorMessage.style.display = 'block';
        } finally {
            imageLoadingIndicator.style.display = 'none';
            generateImageBtn.disabled = false;
        }
    }
    generateImageBtn?.addEventListener('click', handleGenerateImage);
    imagePromptInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleGenerateImage();
    });


    async function handleSummarizeText() {
        const textToSummarize = summarizerInput.value.trim();
        if (!textToSummarize) {
            summarizerErrorMessage.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.";
            summarizerErrorMessage.style.display = 'block';
            summarizerOutput.style.display = 'none';
            return;
        }
        summarizerErrorMessage.style.display = 'none';
        summarizerLoadingIndicator.style.display = 'block';
        summarizeTextBtn.disabled = true;
        summarizerOutput.style.display = 'none';

        const prompt = `–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞:\n\n${textToSummarize}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${models[0].key}:generateContent?key=${API_KEY}`; // Use default text model

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                summarizerOutput.textContent = result.candidates[0].content.parts[0].text;
                summarizerOutput.style.display = 'block';
            } else if (result.error) {
                console.error("Summarizer API Error:", result.error);
                summarizerErrorMessage.textContent = `–û—à–∏–±–∫–∞ API: ${result.error.message}`;
                summarizerErrorMessage.style.display = 'block';
            }
            else {
                summarizerErrorMessage.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.";
                summarizerErrorMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("Error calling Summarizer API:", error);
            summarizerErrorMessage.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞.";
            summarizerErrorMessage.style.display = 'block';
        } finally {
            summarizerLoadingIndicator.style.display = 'none';
            summarizeTextBtn.disabled = false;
        }
    }
    summarizeTextBtn?.addEventListener('click', handleSummarizeText);


    function displayProfileData() {
        try {
            const user = tg.initDataUnsafe?.user;
            const avatarImg = document.getElementById('profile-avatar-img');
            const nameEl = document.getElementById('profile-name');
            const idEl = document.getElementById('profile-id');
            if (user && user.id) {
                if (user.photo_url) { avatarImg.style.backgroundImage = `url(${user.photo_url})`; }
                else { avatarImg.style.backgroundColor = '#444'; avatarImg.innerHTML = (user.first_name || 'U').charAt(0); avatarImg.style.display = 'flex'; avatarImg.style.alignItems = 'center'; avatarImg.style.justifyContent = 'center'; avatarImg.style.fontSize = '1.8rem'; avatarImg.style.color = 'var(--text-primary)'; }
                nameEl.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                idEl.textContent = `ID: ${user.id}`;
            } else { avatarImg.style.backgroundColor = '#444'; avatarImg.innerHTML = '?'; nameEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; idEl.textContent = 'ID: –ù/–î'; }
        } catch (e) { console.error("Error displaying profile data:", e); }
    }

    function updateNavArrows(swiperInstance, prefix) {
        const prev = document.getElementById(`${prefix}-nav-prev`);
        const next = document.getElementById(`${prefix}-nav-next`);
        if(prev && next && swiperInstance) {
            prev.classList.toggle('disabled', swiperInstance.isBeginning);
            next.classList.toggle('disabled', swiperInstance.isEnd);
        }
    }

    function openChat(agent) {
        selectedAgentKey = agent.key;
        chatTitle.textContent = agent.name;
        agentSelect.value = selectedAgentKey;
        modelSelect.value = selectedModelKey;
        currentMiniAppChatHistory = []; // Reset API history for new chat
        loadChatFromLocalStorage(); // Load display history
        if (chatMessagesContainer.children.length === 0) { // If no messages loaded from storage
            addMessageToChat('bot', `–ü—Ä–∏–≤–µ—Ç! –Ø ${agent.name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
        }
        switchScreen(chatScreen);
    }

    function closeChat() { switchScreen(mainScreen); }
    function openSettingsModal() { agentSelect.value = selectedAgentKey; modelSelect.value = selectedModelKey; settingsModal.style.display = 'flex'; }
    function closeSettingsModal() { settingsModal.style.display = 'none'; }

    function init() {
        if (tg.ready) tg.ready();
        if (tg.expand) tg.expand();
        if (tg.MainButton) tg.MainButton.hide();
        // Telegram BackButton is handled globally now

        populateCarousel('agents-swiper-wrapper', agents, 'agent');
        populateCarousel('models-swiper-wrapper', models, 'model');
        agentsSwiper = new Swiper("#agents-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'agents') }, slideChange(s){ updateNavArrows(s, 'agents') } }});
        modelsSwiper = new Swiper("#models-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'models') }, slideChange(s){ updateNavArrows(s, 'models') } }});
        document.getElementById('agents-nav-prev')?.addEventListener('click', () => agentsSwiper?.slidePrev());
        document.getElementById('agents-nav-next')?.addEventListener('click', () => agentsSwiper?.slideNext());
        document.getElementById('models-nav-prev')?.addEventListener('click', () => modelsSwiper?.slidePrev());
        document.getElementById('models-nav-next')?.addEventListener('click', () => modelsSwiper?.slideNext());

        populateToolsList();
        displayProfileData();

        agents.forEach(a => agentSelect.appendChild(new Option(`${a.icon} ${a.name}`, a.key)));
        models.forEach(m => modelSelect.appendChild(new Option(m.name, m.key))); // Only one model now

        document.querySelectorAll('.tab-item').forEach(tab => tab.addEventListener('click', () => showTab(tab.dataset.tab)));
        sendBtn.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        chatInput.addEventListener('input', handleInputStyling);
        attachBtn?.addEventListener('click', () => tg.showAlert?.('–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.'));
        chatBackButton?.addEventListener('click', closeChat);
        chatSettingsBtn?.addEventListener('click', openSettingsModal);
        document.querySelector('.modal-close-btn')?.addEventListener('click', closeSettingsModal);
        settingsModal?.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

        agentSelect.addEventListener('change', (e) => {
            selectedAgentKey = e.target.value;
            const agent = agents.find(a=> a.key === selectedAgentKey);
            if(agent) chatTitle.textContent = agent.name;
            currentMiniAppChatHistory = []; // Reset API history
            loadChatFromLocalStorage();
            if (chatMessagesContainer.children.length === 0 && agent) {
                 addMessageToChat('bot', `–ê–≥–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${agent.name}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
            }
        });
        modelSelect.addEventListener('change', (e) => { selectedModelKey = e.target.value; });

        handleInputStyling.call(chatInput);
        showTab('home');
        if (tg.BackButton) tg.BackButton.hide();
    }

    init();
});
</script>
</body>
</html>
