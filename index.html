<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
    <title>AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <style>
        :root {
            --bg-main: #000000; 
            --bg-card: #121212; 
            --bg-select: #2C2C2E;
            --bg-user-msg: #3E3E42;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --border-color: #282828; 
            --app-wrapper-border: #000000; 
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
            --gold-highlight: #d8ab4e; 
            --success-green: #4CAF50;
            --error-red: #F44336;
        }
        html, body {
            position: fixed;
            inset: 0;
            overflow: hidden;
            font-family: var(--font-family);
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            overscroll-behavior-y: contain;
            margin: 0;
            padding: 0;
        }
        .app-wrapper {
            width: 100%;
            max-width: 450px; 
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--app-wrapper-border); 
            border-right: 1px solid var(--app-wrapper-border); 
        }
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column; /* Ensures flex context for children */
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out;
            background-color: var(--bg-main);
            z-index: 10;
            will-change: opacity, visibility;
        }
        .screen.active { z-index: 20; opacity: 1; visibility: visible; }
        .screen:not(.active) { opacity: 0; visibility: hidden; pointer-events: none; }

        #main-screen, #image-generator-screen, #summarizer-screen, #chat-screen { flex-grow: 1; } 
        #main-content-area, .feature-content-area { 
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
         .fixed-header { 
            padding: 0.75rem 1rem;
            background: rgba(18,18,18,0.85); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            align-items: center; 
            gap: 0.5rem; 
            border-bottom: 1px solid var(--border-color);
            z-index: 25; 
            color: var(--text-primary);
            position: sticky; 
            top: 0;
            flex-shrink: 0;
        }
        .fixed-header h1 { font-size: 1.125rem; font-weight: 600; margin: 0; flex-grow: 1; text-align: center; } 
        .fixed-header .back-btn {
            color: var(--gold-highlight); 
            cursor: pointer;
            padding: 0.25rem; 
        }
         .main-screen-header { 
            padding: 1rem 1rem 0.5rem 1rem;
            background-color: var(--bg-main);
            flex-shrink: 0;
        }
        .main-screen-header h1 { font-size: 1.875rem; font-weight: 800; margin-bottom: 0.25rem; }
        .main-screen-header p.subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; }


        .content-pane { display: none; }
        .content-pane.active { display: block; }

        h2 { font-size: 1.25rem; font-weight: 700; }


        .swiper-container-wrapper { margin-top: 0.75rem; flex-shrink: 0; } 
        .swiper-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0 0.25rem; }
        .swiper-nav-arrows { display: flex; gap: 0.5rem; }
        .swiper-nav-arrow { width: 32px; height: 32px; background-color: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 0.2s, transform 0.1s; color: var(--text-secondary); }
        .swiper-nav-arrow:hover { color: var(--text-primary); }
        .swiper-nav-arrow:active { transform: scale(0.9); }
        .swiper-nav-arrow.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .swiper-slide { width: 180px; height: 120px; cursor: pointer; }
        .tg-card { border-radius: 16px; overflow: hidden; height: 100%; }
        .carousel-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 0.75rem; text-align: left; }
        .card-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .card-title { font-size: 0.9rem; font-weight: 600; color: #FFFFFF; }
        .card-description { font-size: 0.75rem; color: #FFFFFF; opacity: 0.80; margin-top: 0.1rem; line-height: 1.2; }

        .palette-1 { background: linear-gradient(45deg, #FF416C, #FF4B2B); }
        .palette-2 { background: linear-gradient(45deg, #12C2E9, #C471ED, #F64F59); }
        .palette-3 { background: linear-gradient(45deg, #00C9FF, #92FE9D); }
        .palette-4 { background: linear-gradient(45deg, #FAD961, #F76B1C); }
        .palette-5 { background: linear-gradient(45deg, #4A00E0, #8E2DE2); }
        .palette-6 { background-color: #2D2D2D; }

        .full-screen-card-list { display: grid; gap: 0.75rem; margin-top: 1rem; }
        .full-screen-card { background-color: var(--bg-card); border-radius: 16px; padding: 1rem; display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: transform 0.1s; }
        .full-screen-card:active { transform: scale(0.98); }
        .full-screen-card .icon { font-size: 1.75rem; }
        .full-screen-card .info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.1rem;}
        .full-screen-card .info p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.3;}

        .ios-tab-bar {
            flex-shrink: 0;
            max-width: 400px;
            width: calc(100% - 2rem);
            margin: 0 auto 1rem auto; 
            display: flex;
            border-radius: 16px; /* Rounded like iOS tab bar */
            padding: 0.3rem; 
            border: 1px solid var(--border-color); 
            background-color: transparent; /* Transparent background for the bar */
            z-index: 100;
            position: relative; /* For potential pseudo-elements if needed for glassmorphism */
        }
        .tab-item { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: color 0.2s, background-color 0.2s; 
            padding: 0.35rem 0; /* Adjusted padding */
            border-radius: 12px; /* Rounded corners for individual items */
            background-color: transparent; /* Ensure individual items are transparent by default */
            margin: 0.1rem; /* Small margin between items */
        }
        .tab-item.active { 
            color: var(--gold-highlight); 
            background-color: rgba(255, 255, 255, 0.1); /* Subtle background for active tab */
        }
        .tab-item:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.05); /* Subtle hover for non-active tabs */
        }
        .tab-item svg { width: 22px; height: 22px; margin-bottom: 2px; } 
        .tab-item span { font-size: 0.6rem; font-weight: 500; }

        .ios-card { background-color: var(--bg-card); border-radius: 1rem; padding: 1rem; margin-top: 1rem; }
        .profile-header { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 1rem;
            background-color: #333;
            background-size: cover;
            background-position: center;
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; 
            font-weight: 500;
            color: var(--text-primary);
        }
        .profile-info h2 { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.2rem 0;}
        .profile-info p { font-size: 0.85rem; color: var(--text-secondary); margin:0;}
        .profile-gems { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; font-size: 0.9rem;}

        /* Chat Screen Specific Styles */
        #chat-screen { display: flex; flex-direction: column; }

        #chat-screen .chat-header { 
            flex-shrink: 0;
             position: sticky; 
             top: 0;
             background: rgba(18,18,18,0.95); 
        }
        .chat-header .title { font-weight: 600; font-size: 1.125rem; text-align: center; flex-grow: 1; color: var(--text-primary); margin-left: 38px; }
        .chat-header-btn { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; color: var(--text-secondary); }
        .chat-header-btn#chat-back-btn { color: var(--gold-highlight); }
        .chat-header-btn:hover { background-color: var(--bg-card); }
        
        .chat-messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 1rem; 
            display: flex; 
            flex-direction: column; 
            gap: 0.25rem; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .chat-input-area { 
            flex-shrink: 0; /* Prevent shrinking */
            padding: 0.5rem 0.75rem; 
            border-top: 1px solid var(--border-color); 
            background-color: var(--bg-main); 
            display: flex;
            align-items: flex-end; /* Align items to bottom for textarea expansion */
            gap: 0.5rem; 
            z-index: 15; 
            /* This area is at the bottom of the chat-screen flex container */
        }
        #chat-prompt-input { 
            flex-grow: 1; 
            background-color: var(--bg-card);
            border-radius: 18px; 
            padding: 0.6rem 0.85rem; /* Adjusted padding */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem; /* Standard font size */
            line-height: 1.3; /* For better readability in textarea */
            min-height: 38px; /* Slightly taller base height */
            max-height: 120px; 
            resize: none; 
            overflow-y: auto; 
        }
        #chat-prompt-input:focus {
            outline: none;
            border-color: var(--gold-highlight);
            box-shadow: 0 0 0 1px var(--gold-highlight);
        }
        #chat-send-message-btn { 
            flex-shrink: 0; 
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 50%; /* Circular button */
            width: 38px; /* Fixed width */
            height: 38px; /* Fixed height */
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; /* Remove padding if icon is centered */
        }
        #chat-send-message-btn svg {
            width: 20px; /* Adjust icon size if needed */
            height: 20px;
        }
        #chat-send-message-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }


        .chat-message { padding: 0.5rem 0.9rem; border-radius: 1.1rem; max-width: 85%; word-wrap: break-word; line-height: 1.4; opacity: 0; transform: translateY(10px); animation: pop-in 0.3s ease forwards; margin-top: 0.65rem; will-change: transform, opacity; font-size: 0.9rem; }
        @keyframes pop-in { to { opacity: 1; transform: translateY(0); } }
        .message-bot { background-color: var(--bg-card); align-self: flex-start; color: var(--text-primary); }
        .message-user { background-color: var(--bg-user-msg); align-self: flex-end; color: var(--text-primary); }
        .message-bot.tailed { border-bottom-left-radius: 0.25rem; }
        .message-user.tailed { border-bottom-right-radius: 0.25rem; }
        .chat-message.grouped { margin-top: 0.25rem; }
        .chat-message.no-tail { border-bottom-left-radius: 1.1rem; border-bottom-right-radius: 1.1rem; }
        .message-bot.typing { color: var(--text-secondary); font-style: italic; }
        .typing .message-content::after { content: '.'; animation: dots 1.2s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: '...'; } }
        .message-meta { display: flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; color: var(--text-secondary); float: right; margin-left: 0.5rem; margin-top: 0.2rem; line-height: 1; user-select: none; }
        .chat-date-divider { text-align: center; margin: 1rem auto; background-color: rgba(44, 44, 46, 0.8); color: var(--text-primary); font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.6rem; border-radius: 1rem; width: fit-content; }

        /* Removed .chat-bottom-bar as input area is now the visual bottom of chat content */

        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card); padding: 1.5rem; border-radius: 1rem; width: calc(100% - 2rem); max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .custom-select { width: 100%; background-color: var(--bg-select); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 1rem; margin-top: 0.5rem;}

        .feature-input-area { margin-bottom: 1rem; }
        .feature-input-area textarea, .feature-input-area input[type="text"] {
            width: 100%;
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 44px;
        }
        .feature-input-area textarea { min-height: 100px; }
        .feature-submit-btn { /* General style, chat send button has specific overrides */
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--gold-highlight);
            color: black;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }
        .feature-submit-btn:hover { background-color: #c89a3e; }
        .feature-submit-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }
        .generated-image-container { margin-top: 1rem; text-align: center; }
        .generated-image-container img { max-width: 100%; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-card); }
        .generated-image-container button { 
            margin-top: 0.75rem;
            background-color: var(--bg-select);
            color: var(--text-primary);
        }
        .summarizer-output { margin-top: 1rem; padding: 1rem; background-color: var(--bg-card); border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-primary); font-size: 0.9rem; }
        .error-message { color: var(--error-red); text-align: center; margin-top: 1rem; }

        ::-webkit-scrollbar {
            width: 6px; 
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-main); 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #2a2a2a; 
            border-radius: 10px;
            border: 1px solid var(--bg-main); 
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #4a4a4a; 
        }
        * {
           scrollbar-width: thin;
           scrollbar-color: #2a2a2a var(--bg-main);
        }

    </style>
</head>
<body>
    <div class="app-wrapper">
        <div id="main-screen" class="screen active"> <div id="main-content-area"> <div id="home-content" class="content-pane active">
                    <div class="main-screen-header">
                        <h1>Главная</h1>
                        <p class="subtitle">Панель управления ассистентом</p>
                    </div>
                    <div class="full-screen-card" id="image-generator-card">
                        <div class="icon" style="font-size: 2rem;">🎨</div>
                        <div class="info"><h3>Генератор изображений ✨</h3><p>Создание картинок по описанию.</p></div>
                    </div>
                    <div class="swiper-container-wrapper">
                        <div class="swiper-header"><h2>Агенты</h2><div class="swiper-nav-arrows"><div id="agents-nav-prev" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="agents-nav-next" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="agents-swiper"><div class="swiper-wrapper" id="agents-swiper-wrapper"></div></div>
                    </div>
                    <div class="swiper-container-wrapper"> <div class="swiper-header"><h2>Модели</h2><div class="swiper-nav-arrows"><div id="models-nav-prev" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M10 13L5 8L10 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id="models-nav-next" class="swiper-nav-arrow"><svg width="16" viewBox="0 0 16 16"><path d="M6 13L11 8L6 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>
                        <div class="swiper" id="models-swiper"><div class="swiper-wrapper" id="models-swiper-wrapper"></div></div>
                    </div>
                </div>
                <div id="tools-content" class="content-pane">
                    <div class="main-screen-header">
                        <h1>Инструменты</h1>
                        <p class="subtitle">Полезные функции на базе ИИ</p>
                    </div>
                    <div id="tools-list" class="full-screen-card-list"></div>
                </div>
                <div id="profile-content" class="content-pane">
                     <div class="main-screen-header">
                        <h1>Профиль</h1>
                        <p class="subtitle">Информация о вашем аккаунте</p>
                    </div>
                    <div class="ios-card">
                       <div class="profile-header">
                           <div id="profile-avatar-img" class="profile-avatar"></div>
                           <div class="profile-info">
                               <h2 id="profile-name">Пользователь</h2>
                               <p id="profile-id">ID: Неизвестно</p>
                           </div>
                       </div>
                       <div class="profile-gems"><span>💎 Баланс гемов</span><span id="gem-balance" style="font-weight:700;">Недоступно</span></div>
                    </div>
                </div>
            </div>
            <nav class="ios-tab-bar">
                <div class="tab-item active" data-tab="home">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>Главная</span>
                </div>
                <div class="tab-item" data-tab="tools">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Инструменты</span>
                </div>
                <div class="tab-item" data-tab="profile">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Профиль</span>
                </div>
            </nav>
        </div>

        <div id="chat-screen" class="screen"> <div class="chat-header fixed-header"> 
                <div id="chat-back-btn" class="chat-header-btn">
                     <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 </div>
                 <div id="chat-title" class="title">Чат</div>
                 <div id="chat-settings-btn" class="chat-header-btn">
                    <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24"> <path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                 </div>
            </div>
            <div class="chat-messages" id="chat-messages-container"></div>
            <div class="chat-input-area"> 
                <textarea id="chat-prompt-input" placeholder="Сообщение..." rows="1"></textarea>
                <button id="chat-send-message-btn" disabled> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
            </div>

        <div id="image-generator-screen" class="screen">
            <div class="fixed-header">
                <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </div>
                <h1>Генератор изображений ✨</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <input type="text" id="image-prompt-input" placeholder="Введите описание изображения...">
                </div>
                <button id="generate-image-btn" class="feature-submit-btn">Сгенерировать</button>
                <div id="image-loading-indicator" class="loading-indicator" style="display: none;">Генерация изображения...</div>
                <div id="generated-image-container" class="generated-image-container"></div>
                <div id="image-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="summarizer-screen" class="screen">
            <div class="fixed-header">
                 <div class="back-btn" data-target-screen="main-screen">
                    <svg fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </div>
                <h1>Суммаризатор текста ✨</h1>
            </div>
            <div class="feature-content-area">
                <div class="feature-input-area">
                    <textarea id="summarizer-input" placeholder="Вставьте текст для суммирования..."></textarea>
                </div>
                <button id="summarize-text-btn" class="feature-submit-btn">Суммировать</button>
                <div id="summarizer-loading-indicator" class="loading-indicator" style="display: none;">Обработка текста...</div>
                <div id="summarizer-output" class="summarizer-output" style="display: none;"></div>
                <div id="summarizer-error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div id="settings-modal"> 
            <div class="modal-content">
                <div class="modal-header"><h3>Настройки чата</h3><div class="modal-close-btn" style="cursor: pointer;">✕</div></div>
                <div><label for="agent-select">АГЕНТ</label><select id="agent-select" class="custom-select"></select></div>
                <div style="margin-top: 1rem;"><label for="model-select">МОДЕЛЬ</label><select id="model-select" class="custom-select"></select></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp || {};
    let currentMiniAppChatHistory = []; 
    let lastMessageInfo = { sender: null, date: null }; 
    let agentsSwiper, modelsSwiper;

    const API_KEY = "AIzaSyCdDMpgLJyz6aYdwT9q4sbBk7sHVID4BTI"; 
    const APP_BACKEND_URL = "https://nwb-production.up.railway.app"; 

    const logger = {
        info: (message, ...optionalParams) => console.log(`[INFO] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        warn: (message, ...optionalParams) => console.warn(`[WARN] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        error: (message, ...optionalParams) => console.error(`[ERROR] ${new Date().toISOString()}: ${message}`, ...optionalParams),
        debug: (message, ...optionalParams) => console.debug(`[DEBUG] ${new Date().toISOString()}: ${message}`, ...optionalParams),
    };

    const agents = [ 
        { key: "universal_ai_basic", name: "Универсал", icon: "🌐", desc: "Ответы на любые темы", palette: "palette-5", systemPrompt: "Ты — полезный ИИ-ассистент." }, 
        { key: "idea_generator", name: "Генератор идей", icon: "💡", desc: "Помощь в поиске идей", palette: "palette-4", systemPrompt: "Ты — ИИ, специализирующийся на генерации креативных идей. Помоги пользователю придумать что-то новое." }, 
        { key: "career_coach", name: "Карьерный коуч", icon: "📈", desc: "Советы по карьере", palette: "palette-3", systemPrompt: "Ты — опытный карьерный коуч. Давай конструктивные советы и рекомендации по развитию карьеры." }, 
        { key: "programming_partner", name: "Партнер-прогер", icon: "💻", desc: "Помощь в коде", palette: "palette-2", systemPrompt: "Ты — ИИ-ассистент для программистов. Помогай с кодом, объясняй концепции и предлагай решения." }, 
        { key: "tutor_assistant", name: "Репетитор", icon: "📚", desc: "Помощь с учебой", palette: "palette-1", systemPrompt: "Ты — дружелюбный и терпеливый ИИ-репетитор. Помогай пользователю разбираться в учебных материалах." }, 
        { key: "literary_editor", name: "Редактор", icon: "✍️", desc: "Улучшение текстов", palette: "palette-6", systemPrompt: "Ты — ИИ-редактор. Помогай улучшать тексты, исправлять ошибки и делать их более выразительными." },
    ];

    const models = [ 
        { key: "google_gemini_2_0_flash", name: "Gemini 2.0 Flash", icon: "⚡️", desc: "Быстрая и доступная", palette: "palette-6" },
        { key: "google_gemini_2_5_flash_preview", name: "Gemini 2.5 Flash", icon: "👁️‍🗨️", desc: "Быстрый, с Vision", palette: "palette-2" },
        { key: "custom_api_gemini_2_5_pro", name: "Gemini Pro (Custom)", icon: "🚀", desc: "Продвинутая модель", palette: "palette-4" },
        { key: "custom_api_grok_3", name: "Grok 3 (Custom)", icon: "�", desc: "Модель Grok", palette: "palette-5" },
        { key: "custom_api_gpt_4o_mini", name: "GPT-4o mini (Custom)", icon: "🧠", desc: "Компактная GPT-4o", palette: "palette-3" }
    ];

    const tools = [
        { key: "summarizer", name: "Суммаризатор текста ✨", icon: "📑", desc: "Краткий пересказ длинных статей и видео." },
        { key: "text_analyzer", name: "Анализатор текста", icon: "🔍", desc: "Анализ тональности и ключевых слов." },
        { key: "translator_pro", name: "Про-переводчик", icon: "🌐", desc: "Контекстный перевод документов и речи." }
    ];

    let selectedAgentKey = agents[0].key;
    let selectedModelKey = models[0].key; 

    const mainScreen = document.getElementById('main-screen');
    const chatScreen = document.getElementById('chat-screen');
    const imageGeneratorScreen = document.getElementById('image-generator-screen');
    const summarizerScreen = document.getElementById('summarizer-screen');

    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatPromptInput = document.getElementById('chat-prompt-input'); 
    const chatSendMessageBtn = document.getElementById('chat-send-message-btn'); 

    const chatTitle = document.getElementById('chat-title');
    const chatBackButton = document.getElementById('chat-back-btn');
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const agentSelect = document.getElementById('agent-select');
    const modelSelect = document.getElementById('model-select');
    const mainContentArea = document.getElementById('main-content-area');

    const imageGeneratorCard = document.getElementById('image-generator-card');
    const imagePromptInputEl = document.getElementById('image-prompt-input'); 
    const generateImageBtn = document.getElementById('generate-image-btn');
    const imageLoadingIndicator = document.getElementById('image-loading-indicator');
    const generatedImageContainer = document.getElementById('generated-image-container');
    const imageErrorMessage = document.getElementById('image-error-message');

    const summarizerInput = document.getElementById('summarizer-input');
    const summarizeTextBtn = document.getElementById('summarize-text-btn');
    const summarizerLoadingIndicator = document.getElementById('summarizer-loading-indicator');
    const summarizerOutput = document.getElementById('summarizer-output');
    const summarizerErrorMessage = document.getElementById('summarizer-error-message');

    let pollingInterval = null;

    function formatTime(date) { return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }

    function switchScreen(screenToShow) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        screenToShow.classList.add('active');
        if (tg.BackButton) {
            if (screenToShow !== mainScreen) { tg.BackButton.show(); }
            else { tg.BackButton.hide(); }
        }

        if (screenToShow === chatScreen) {
            startPolling();
             chatPromptInput.focus(); // Focus input when chat screen is shown
        } else {
            stopPolling();
        }
    }

    if (tg.BackButton) {
        tg.BackButton.onClick(() => {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen && activeScreen.id === 'chat-screen') { closeChat(); }
            else if (activeScreen && (activeScreen.id === 'image-generator-screen' || activeScreen.id === 'summarizer-screen')) {
                switchScreen(mainScreen);
            }
        });
    }

    document.querySelectorAll('.back-btn[data-target-screen]').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetScreenId = btn.dataset.targetScreen;
            const targetScreen = document.getElementById(targetScreenId);
            if (targetScreen) switchScreen(targetScreen);
        });
    });

    function showTab(tabId) {
        document.querySelectorAll('.content-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        const pane = document.getElementById(`${tabId}-content`);
        const tab = document.querySelector(`.tab-item[data-tab="${tabId}"]`);
        if (pane) pane.classList.add('active');
        if (tab) tab.classList.add('active');
        mainContentArea.scrollTop = 0;
    }

    function saveChatToLocalStorage() { 
        try { 
            const displayHistory = Array.from(chatMessagesContainer.children)
                .filter(el => el.classList.contains('chat-message') && !el.classList.contains('typing'))
                .map(msgEl => {
                    const sender = msgEl.classList.contains('message-user') ? 'user' : 'bot';
                    const text = msgEl.querySelector('.message-content')?.textContent || '';
                    let timestamp = msgEl.dataset.timestamp || new Date().toISOString();
                    return { sender, text, timestamp }; 
                });
            setTimeout(() => {
                localStorage.setItem('uiChatHistory_' + selectedAgentKey, JSON.stringify(displayHistory)); 
                 logger.info("UI Chat history saved to localStorage for agent:", selectedAgentKey);
            },0);
        }
        catch (e) { console.error("Error saving UI chat history to localStorage:", e); }
    }

    function loadChatFromLocalStorage() { 
        chatMessagesContainer.innerHTML = '';
        lastMessageInfo = { sender: null, date: null };
        currentMiniAppChatHistory = []; 
        try {
            const savedUiHistory = localStorage.getItem('uiChatHistory_' + selectedAgentKey);
            if (savedUiHistory) {
                const parsedUiHistory = JSON.parse(savedUiHistory);
                parsedUiHistory.forEach(msg => {
                    addMessageToChat(msg.sender, msg.text, { 
                        isRestoredFromHistory: true, 
                        timestamp: msg.timestamp 
                    });
                    currentMiniAppChatHistory.push({role: msg.sender === 'user' ? 'user' : 'model', parts: [{text: msg.text}]});
                });
                logger.info("UI Chat history loaded from localStorage for agent:", selectedAgentKey);
            }
        } catch (e) {
            console.error("Error loading UI chat history from localStorage:", e);
        }
    }

    function addMessageToChat(sender, text, options = {}) {
        const { isTyping = false, isRestoredFromHistory = false, timestamp: msgTimestampStr } = options;
        const now = msgTimestampStr ? new Date(msgTimestampStr) : new Date(); 
        const currentDate = now.toDateString();

        if (!isTyping && (!lastMessageInfo.date || currentDate !== lastMessageInfo.date)) {
            const divider = document.createElement('div');
            divider.className = 'chat-date-divider';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (currentDate === today) { divider.textContent = 'Сегодня'; }
            else if (currentDate === yesterday) { divider.textContent = 'Вчера'; }
            else { divider.textContent = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }); }
            chatMessagesContainer.appendChild(divider);
        }

        const lastMessageElement = chatMessagesContainer.querySelector('.chat-message:last-of-type');
        if (!isTyping && lastMessageElement && sender === lastMessageInfo.sender && currentDate === lastMessageInfo.date) {
             lastMessageElement.classList.add('no-tail', 'grouped');
             lastMessageElement.classList.remove('tailed');
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message message-${sender} tailed`;
        msgDiv.dataset.timestamp = now.toISOString(); 
        const contentSpan = document.createElement('span');
        contentSpan.className = 'message-content';
        contentSpan.textContent = text;
        msgDiv.appendChild(contentSpan);

        if (isTyping) {
            msgDiv.classList.add('typing');
        } else {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const timeSpan = document.createElement('span');
            timeSpan.textContent = formatTime(now);
            metaDiv.appendChild(timeSpan);
            msgDiv.appendChild(metaDiv);
        }
        chatMessagesContainer.appendChild(msgDiv);

        if (!isTyping && !isRestoredFromHistory) {
            currentMiniAppChatHistory.push({ role: (sender === 'user' ? 'user' : 'model'), parts: [{ text: text }] });
            saveChatToLocalStorage(); 
        }
        lastMessageInfo = { sender: sender, date: currentDate };
        // Scroll to bottom smoothly
        chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
        return msgDiv;
    }

    async function submitMessageToBackend(userText, agentKey, modelKeyToSubmit) { 
        let userId = tg.initDataUnsafe?.user?.id;

        if (!userId) {
            logger.error("submitMessageToBackend: Telegram User ID missing.");
            addMessageToChat('bot', "Ошибка: ID пользователя Telegram не найден.");
            const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
            if (typingIndicator) typingIndicator.remove();
            return;
        }
        
        const backendProcessUrl = `${APP_BACKEND_URL}/api/process_app_message/${userId}`;
        logger.info(`Sending message to backend: ${backendProcessUrl} with agent ${agentKey}, model ${modelKeyToSubmit}`);

        try {
            const response = await fetch(backendProcessUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: userText, agentKey: agentKey, modelKey: modelKeyToSubmit }) 
            });

            if (!response.ok) {
                let errorText = `Ошибка бэкенда: ${response.status} ${response.statusText}`;
                try {
                    const errorResult = await response.json();
                    errorText = errorResult.message || (errorResult.detail ? JSON.stringify(errorResult.detail) : errorText);
                } catch (e) { logger.warn("Could not parse backend error response as JSON", e); }
                logger.error("Error submitting message to backend:", errorText);
                addMessageToChat('bot', errorText);
            } else {
                 const result = await response.json();
                 logger.info("Message submitted to backend successfully:", result);
            }
        } catch (error) {
            logger.error("Network error submitting message to backend:", error);
            addMessageToChat('bot', "Сетевая ошибка при отправке сообщения на бэкенд.");
        } finally {
            const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
            if (typingIndicator) typingIndicator.remove();
        }
    }

    async function handleSendMessage() {
        const text = chatPromptInput.value.trim(); 
        if (!text) return;

        addMessageToChat('user', text); 
        chatPromptInput.value = ''; 
        autoResizeTextarea.call(chatPromptInput); // Adjust textarea height after clearing
        chatSendMessageBtn.disabled = true; 

        const oldTypingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
        if(oldTypingIndicator) oldTypingIndicator.remove();
        addMessageToChat('bot', 'Печатает...', { isTyping: true });
        await submitMessageToBackend(text, selectedAgentKey, selectedModelKey);
    }

    function autoResizeTextarea() {
        this.style.height = 'auto'; 
        let newHeight = this.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(this).maxHeight);
        if (newHeight > maxHeight) {
            newHeight = maxHeight;
            this.style.overflowY = 'auto'; // Show scrollbar if max height is reached
        } else {
            this.style.overflowY = 'hidden'; // Hide scrollbar if not needed
        }
        this.style.height = newHeight + 'px';
        chatSendMessageBtn.disabled = this.value.trim().length === 0;
    }
    
    chatPromptInput.addEventListener('input', autoResizeTextarea);


    async function fetchUpdates() {
        let userId = tg.initDataUnsafe?.user?.id;
        if (!userId) {
             logger.warn("fetchUpdates: Telegram User ID not found. Polling skipped.");
            return; 
        }
        if (!chatScreen.classList.contains('active')) { 
            return;
        }

        const backendGetUpdatesUrl = `${APP_BACKEND_URL}/api/get_updates/${userId}`;
        try {
            const response = await fetch(backendGetUpdatesUrl);
            if (!response.ok) {
                logger.error("Polling error from backend:", response.status, response.statusText);
                return;
            }
            const data = await response.json();
            if (data && data.status === 'ok' && data.messages && data.messages.length > 0) {
                const typingIndicator = chatMessagesContainer.querySelector('.message-bot.typing');
                if (typingIndicator) typingIndicator.remove();
                
                data.messages.forEach(msg => {
                    addMessageToChat(msg.sender, msg.text, { timestamp: msg.timestamp });
                });
            }
        } catch (error) {
            logger.error("Network error during polling:", error);
        }
    }

    function startPolling() {
        stopPolling(); 
        logger.info("Starting polling for chat updates.");
        fetchUpdates(); 
        pollingInterval = setInterval(fetchUpdates, 3000); 
    }
    function stopPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            logger.info("Polling stopped.");
        }
    }


    function populateCarousel(containerId, items, type) {
        const wrapper = document.getElementById(containerId);
        if (!wrapper) return;
        wrapper.innerHTML = '';
        items.forEach(item => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `<div class="tg-card"><div class="carousel-card ${item.palette || 'palette-6'}"><div class="card-icon">${item.icon}</div><div><h3 class="card-title">${item.name}</h3><p class="card-description">${item.desc}</p></div></div></div>`;
            slide.addEventListener('click', () => {
                if (type === 'agent') {
                    selectedAgentKey = item.key;
                     const agentForChat = agents.find(a => a.key === item.key);
                     openChat(agentForChat); 
                } else if (type === 'model') {
                    selectedModelKey = item.key; 
                    const currentAgent = agents.find(a => a.key === selectedAgentKey);
                    if (currentAgent) {
                        openChat(currentAgent); 
                    } else {
                        logger.info("Model selected, but no active agent. Will be used for next chat.");
                        if(tg.showPopup) tg.showPopup({message: `Модель ${item.name} выбрана.`});
                    }
                }
            });
            wrapper.appendChild(slide);
        });
    }

    function populateToolsList() {
        const list = document.getElementById('tools-list');
        if (!list) return;
        list.innerHTML = '';
        tools.forEach(item => {
            const card = document.createElement('div');
            card.className = 'full-screen-card';
            card.innerHTML = `<div class="icon">${item.icon}</div><div class="info"><h3>${item.name}</h3><p>${item.desc}</p></div>`;
            card.addEventListener('click', () => {
                if (item.key === "summarizer") {
                    switchScreen(summarizerScreen);
                } else {
                    if (tg.showAlert) tg.showAlert(`Инструмент "${item.name}" еще не реализован.`);
                }
            });
            list.appendChild(card);
        });
    }

    imageGeneratorCard?.addEventListener('click', () => {
        switchScreen(imageGeneratorScreen);
    });

    async function handleGenerateImage() {
        const prompt = imagePromptInputEl.value.trim(); 
        if (!prompt) {
            imageErrorMessage.textContent = "Пожалуйста, введите описание изображения.";
            imageErrorMessage.style.display = 'block';
            generatedImageContainer.innerHTML = '';
            return;
        }
        imageErrorMessage.style.display = 'none';
        imageLoadingIndicator.style.display = 'block';
        generateImageBtn.disabled = true;
        generatedImageContainer.innerHTML = ''; 

        const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1} };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
        logger.info(`Image Generation: Calling API directly at ${apiUrl.split('?key=')[0]}...`);


        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorDetailMessage = "";
                try {
                    const errorResult = await response.json(); 
                    if (errorResult && errorResult.error && errorResult.error.message) {
                        errorDetailMessage = errorResult.error.message;
                    }
                } catch (e) { 
                    try { errorDetailMessage = await response.text(); } 
                    catch (textErr) { console.warn("Could not parse image error response as JSON or text", textErr); }
                }

                let userFriendlyDisplayError = `Ошибка API изображений: ${response.status} ${response.statusText}`;
                if (response.status === 401) { 
                    userFriendlyDisplayError = "Ошибка аутентификации (401) при доступе к API изображений.";
                } else if (errorDetailMessage && !errorDetailMessage.toLowerCase().includes("<html")) { 
                     userFriendlyDisplayError = `Ошибка API изображений (${response.status}): ${errorDetailMessage.substring(0, 200)}${errorDetailMessage.length > 200 ? '...' : ''}`;
                }
                
                console.error("Imagen API HTTP Error:", response.status, response.statusText, "Detail:", errorDetailMessage);
                imageErrorMessage.textContent = userFriendlyDisplayError;
                imageErrorMessage.style.display = 'block';
                return; 
            }

            const result = await response.json(); 

            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.alt = "Сгенерированное изображение: " + prompt.substring(0, 50);
                generatedImageContainer.appendChild(imgElement);

                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Сохранить изображение';
                saveBtn.className = 'feature-submit-btn'; 
                saveBtn.style.marginTop = '0.75rem';
                saveBtn.style.backgroundColor = 'var(--bg-select)'; 
                saveBtn.style.color = 'var(--text-primary)';

                saveBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = imageUrl; 
                    link.download = `generated_image_${Date.now()}.png`; 
                    document.body.appendChild(link); 
                    link.click();
                    document.body.removeChild(link);
                    if(tg.showAlert) tg.showAlert('Изображение инициировано к сохранению!');
                };
                generatedImageContainer.appendChild(saveBtn);

            } else if (result.error) { 
                 console.error("Imagen API Error (JSON payload):", result.error);
                imageErrorMessage.textContent = `Ошибка API (ответ): ${result.error.message}`;
                imageErrorMessage.style.display = 'block';
            } else { 
                console.warn("Unexpected Imagen API success response structure:", result);
                imageErrorMessage.textContent = "Не удалось сгенерировать изображение.";
                imageErrorMessage.style.display = 'block';
            }
        } catch (error) { 
            console.error("Error in handleGenerateImage (catch block):", error);
            imageErrorMessage.textContent = "Ошибка сети при генерации изображения.";
            imageErrorMessage.style.display = 'block';
        } finally {
            imageLoadingIndicator.style.display = 'none';
            generateImageBtn.disabled = false;
        }
    }
    generateImageBtn?.addEventListener('click', handleGenerateImage);
    imagePromptInputEl?.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter') handleGenerateImage();
    });


    async function handleSummarizeText() {
        const textToSummarize = summarizerInput.value.trim();
        if (!textToSummarize) {
            summarizerErrorMessage.textContent = "Пожалуйста, введите текст для суммирования.";
            summarizerErrorMessage.style.display = 'block';
            summarizerOutput.style.display = 'none';
            return;
        }
        summarizerErrorMessage.style.display = 'none';
        summarizerLoadingIndicator.style.display = 'block';
        summarizeTextBtn.disabled = true;
        summarizerOutput.style.display = 'none';

        const prompt = `Сделай краткое содержание следующего текста:\n\n${textToSummarize}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const modelToUseForSummarizer = selectedModelKey || models[0].key;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUseForSummarizer}:generateContent?key=${API_KEY}`;
        logger.info(`Summarizer: Calling API using model ${modelToUseForSummarizer}...`);


        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                let errorDetail = "";
                let userFriendlyError = `Ошибка API суммаризации: ${response.status} ${response.statusText}`;
                try {
                    const errorResult = await response.json();
                     errorDetail = errorResult?.error?.message || "";
                } catch (e) { /* ignore */ }

                if (response.status === 401) {
                    userFriendlyError = "Ошибка аутентификации (401) API суммаризации.";
                } else if (errorDetail && !errorDetail.toLowerCase().includes("<html")) {
                    userFriendlyError = `Ошибка API суммаризации (${response.status}): ${errorDetail.substring(0,100)}`;
                }
                console.error("Summarizer API HTTP Error:", response.status, response.statusText, "Detail:", errorDetail);
                summarizerErrorMessage.textContent = userFriendlyError;
                summarizerErrorMessage.style.display = 'block';
                return;
            }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                summarizerOutput.textContent = result.candidates[0].content.parts[0].text;
                summarizerOutput.style.display = 'block';
            } else if (result.error) {
                console.error("Summarizer API Error (JSON):", result.error);
                summarizerErrorMessage.textContent = `Ошибка API (ответ): ${result.error.message}`;
                summarizerErrorMessage.style.display = 'block';
            }
            else {
                console.warn("Unexpected Summarizer API response structure:", result);
                summarizerErrorMessage.textContent = "Не удалось суммировать текст.";
                summarizerErrorMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("Error calling Summarizer API (catch):", error);
            summarizerErrorMessage.textContent = "Ошибка сети при суммировании текста.";
            summarizerErrorMessage.style.display = 'block';
        } finally {
            summarizerLoadingIndicator.style.display = 'none';
            summarizeTextBtn.disabled = false;
        }
    }
    summarizeTextBtn?.addEventListener('click', handleSummarizeText);


    function displayProfileData() {
        try {
            const user = tg.initDataUnsafe?.user;
            const avatarImg = document.getElementById('profile-avatar-img');
            avatarImg.innerHTML = ''; 
            avatarImg.style.backgroundImage = ''; 

            if (user && user.id) {
                if (user.photo_url) {
                    avatarImg.style.backgroundImage = `url(${user.photo_url})`;
                } else {
                    avatarImg.style.backgroundColor = '#444';
                    avatarImg.innerHTML = (user.first_name || 'U').charAt(0).toUpperCase();
                }
                document.getElementById('profile-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Пользователь';
                document.getElementById('profile-id').textContent = `ID: ${user.id}`;
            } else {
                 avatarImg.style.backgroundColor = '#444';
                 avatarImg.innerHTML = '?'; 
                 document.getElementById('profile-name').textContent = 'Нет данных';
                 document.getElementById('profile-id').textContent = 'ID: Н/Д';
            }
        } catch (e) { console.error("Error displaying profile data:", e); }
    }

    function updateNavArrows(swiperInstance, prefix) {
        const prev = document.getElementById(`${prefix}-nav-prev`);
        const next = document.getElementById(`${prefix}-nav-next`);
        if(prev && next && swiperInstance) {
            prev.classList.toggle('disabled', swiperInstance.isBeginning);
            next.classList.toggle('disabled', swiperInstance.isEnd);
        }
    }

    function openChat(agent) {
        selectedAgentKey = agent.key;
        chatTitle.textContent = agent.name;
        
        const backendAgentConfig = AI_MODES_FRONTEND_MIRROR.find(a => a.key === agent.key); 
        if (backendAgentConfig && backendAgentConfig.forced_model_key) {
            selectedModelKey = backendAgentConfig.forced_model_key;
            logger.info(`Agent ${agent.name} forces model to ${selectedModelKey}.`);
        }

        agentSelect.value = selectedAgentKey;
        modelSelect.value = selectedModelKey;
        
        loadChatFromLocalStorage(); 
        if (chatMessagesContainer.children.length === 0) { 
            const modelForDisplay = models.find(m=>m.key === selectedModelKey)?.name || selectedModelKey;
            addMessageToChat('bot', `Привет! Я ${agent.name}. Чем могу помочь? (Модель: ${modelForDisplay})`);
        }
        switchScreen(chatScreen); 
    }

    function closeChat() { 
        stopPolling();
        switchScreen(mainScreen); 
    }
    function openSettingsModal() { agentSelect.value = selectedAgentKey; modelSelect.value = selectedModelKey; settingsModal.style.display = 'flex'; }
    function closeSettingsModal() { settingsModal.style.display = 'none'; }

    function init() {
        if (tg.ready) tg.ready();
        if (tg.expand) tg.expand();
        if (tg.MainButton) tg.MainButton.hide();

        populateCarousel('agents-swiper-wrapper', agents, 'agent');
        populateCarousel('models-swiper-wrapper', models, 'model');
        agentsSwiper = new Swiper("#agents-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'agents') }, slideChange(s){ updateNavArrows(s, 'agents') } }});
        modelsSwiper = new Swiper("#models-swiper", { slidesPerView: 'auto', spaceBetween: 10, on: { init(s){ updateNavArrows(s, 'models') }, slideChange(s){ updateNavArrows(s, 'models') } }});
        document.getElementById('agents-nav-prev')?.addEventListener('click', () => agentsSwiper?.slidePrev());
        document.getElementById('agents-nav-next')?.addEventListener('click', () => agentsSwiper?.slideNext());
        document.getElementById('models-nav-prev')?.addEventListener('click', () => modelsSwiper?.slidePrev());
        document.getElementById('models-nav-next')?.addEventListener('click', () => modelsSwiper?.slideNext());

        populateToolsList();
        displayProfileData();

        agents.forEach(a => agentSelect.appendChild(new Option(`${a.icon} ${a.name}`, a.key)));
        models.forEach(m => modelSelect.appendChild(new Option(m.name, m.key))); 

        document.querySelectorAll('.tab-item').forEach(tab => tab.addEventListener('click', () => showTab(tab.dataset.tab)));
        
        chatSendMessageBtn.addEventListener('click', handleSendMessage);
        chatPromptInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey && !chatSendMessageBtn.disabled) { 
                e.preventDefault(); 
                handleSendMessage(); 
            } 
        });

        chatBackButton?.addEventListener('click', closeChat);
        chatSettingsBtn?.addEventListener('click', openSettingsModal);
        document.querySelector('.modal-close-btn')?.addEventListener('click', closeSettingsModal);
        settingsModal?.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

        agentSelect.addEventListener('change', (e) => {
            selectedAgentKey = e.target.value;
            const agent = agents.find(a=> a.key === selectedAgentKey);
            if(agent) {
                chatTitle.textContent = agent.name;
                const backendAgentConfig = AI_MODES_FRONTEND_MIRROR.find(a_cfg => a_cfg.key === agent.key);
                if (backendAgentConfig && backendAgentConfig.forced_model_key) {
                    selectedModelKey = backendAgentConfig.forced_model_key;
                    modelSelect.value = selectedModelKey; 
                    logger.info(`Agent ${agent.name} selected, forces model to ${selectedModelKey}.`);
                }
            }
            loadChatFromLocalStorage(); 
            if (chatMessagesContainer.children.length === 0 && agent) { 
                 const modelForDisplay = models.find(m=>m.key === selectedModelKey)?.name || selectedModelKey;
                 addMessageToChat('bot', `Агент изменен на ${agent.name}. Чем могу помочь? (Модель: ${modelForDisplay})`);
            }
        });
        modelSelect.addEventListener('change', (e) => { 
            selectedModelKey = e.target.value; 
            logger.info(`Model changed to ${selectedModelKey} via dropdown.`);
            const currentAgent = agents.find(a => a.key === selectedAgentKey);
             if (chatScreen.classList.contains('active') && currentAgent) {
                 const modelForDisplay = models.find(m=>m.key === selectedModelKey)?.name || selectedModelKey;
                addMessageToChat('bot', `Модель изменена на ${modelForDisplay}.`);
             }
        });

        autoResizeTextarea.call(chatPromptInput); 
        showTab('home');
        if (tg.BackButton) tg.BackButton.hide();

        logger.info(`Initial selected agent: ${selectedAgentKey}`);
        logger.info(`Initial selected model: ${selectedModelKey}`);
    }

    const AI_MODES_FRONTEND_MIRROR = [ 
        { key: "universal_ai_basic", name: "Универсал", forced_model_key: null },
        { key: "photo_dietitian_analyzer", name: "🥑 Диетолог (анализ фото)", forced_model_key: "google_gemini_2_5_flash_preview" },
    ];

    init();
});
</script>
</body>
</html>
